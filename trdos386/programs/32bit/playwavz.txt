     1                                  ; ****************************************************************************
     2                                  ; playwav6.s (for TRDOS 386)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; PLAYWAV6.PRG ! AC'97 (ICH) .WAV PLAYER program by Erdogan TAN
     5                                  ;
     6                                  ; 25/11/2023
     7                                  ;
     8                                  ; [ Last Modification: 06/06/2024 ]
     9                                  ;
    10                                  ; Modified from PLAYWAV5.PRG .wav player program by Erdogan Tan, 18/08/2020
    11                                  ;
    12                                  ; Assembler: NASM version 2.15
    13                                  ;	     nasm playwav6.s -l playwav6.txt -o PLAYWAV6.PRG	
    14                                  ; ----------------------------------------------------------------------------
    15                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002
    16                                  
    17                                  ; previous version: playwav3.s (17/06/2017)
    18                                  
    19                                  ; CODE
    20                                  
    21                                  ; 14/07/2020
    22                                  ; 31/12/2017
    23                                  ; TRDOS 386 (v2.0) system calls
    24                                  _ver 	equ 0
    25                                  _exit 	equ 1
    26                                  _fork 	equ 2
    27                                  _read 	equ 3
    28                                  _write	equ 4
    29                                  _open	equ 5
    30                                  _close 	equ 6
    31                                  _wait 	equ 7
    32                                  _create	equ 8
    33                                  _rename	equ 9
    34                                  _delete	equ 10
    35                                  _exec	equ 11
    36                                  _chdir	equ 12
    37                                  _time 	equ 13
    38                                  _mkdir 	equ 14
    39                                  _chmod	equ 15
    40                                  _rmdir	equ 16
    41                                  _break	equ 17
    42                                  _drive	equ 18
    43                                  _seek	equ 19
    44                                  _tell 	equ 20
    45                                  _memory	equ 21
    46                                  _prompt	equ 22
    47                                  _path	equ 23
    48                                  _env	equ 24
    49                                  _stime	equ 25
    50                                  _quit	equ 26
    51                                  _intr	equ 27
    52                                  _dir	equ 28
    53                                  _emt 	equ 29
    54                                  _ldrvt 	equ 30
    55                                  _video 	equ 31
    56                                  _audio	equ 32
    57                                  _timer	equ 33
    58                                  _sleep	equ 34
    59                                  _msg    equ 35
    60                                  _geterr	equ 36
    61                                  _fpstat	equ 37
    62                                  _pri	equ 38
    63                                  _rele	equ 39
    64                                  _fff	equ 40
    65                                  _fnf	equ 41
    66                                  _alloc	equ 42
    67                                  _dalloc equ 43
    68                                  _calbac equ 44
    69                                  _dma	equ 45
    70                                  
    71                                  %macro sys 1-4
    72                                      ; 29/04/2016 - TRDOS 386 (TRDOS v2.0)	
    73                                      ; 03/09/2015	
    74                                      ; 13/04/2015
    75                                      ; Retro UNIX 386 v1 system call.	
    76                                      %if %0 >= 2   
    77                                          mov ebx, %2
    78                                          %if %0 >= 3    
    79                                              mov ecx, %3
    80                                              %if %0 = 4
    81                                                 mov edx, %4   
    82                                              %endif
    83                                          %endif
    84                                      %endif
    85                                      mov eax, %1
    86                                      ;int 30h
    87                                      int 40h ; TRDOS 386 (TRDOS v2.0)	   
    88                                  %endmacro
    89                                  
    90                                  ; TRDOS 386 (and Retro UNIX 386 v1) system call format:
    91                                  ; sys systemcall (eax) <arg1 (ebx)>, <arg2 (ecx)>, <arg3 (edx)>
    92                                  
    93                                  BUFFERSIZE	equ	32768	; audio buffer size 
    94                                  ENDOFFILE       equ     1	; flag for knowing end of file
    95                                  
    96                                  [BITS 32]
    97                                  
    98                                  [ORG 0] 
    99                                  
   100                                  _STARTUP:
   101                                  	; Prints the Credits Text.
   102                                  	sys	_msg, Credits, 255, 0Bh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000000 BB[0D210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000005 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000000A BA0B000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000000F B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000014 CD40                <1>  int 40h
   103                                  
   104                                  	; clear bss
   105 00000016 B9[99240000]            	mov	ecx, bss_end
   106 0000001B BF[0D240000]            	mov	edi, bss_start
   107 00000020 29F9                    	sub	ecx, edi
   108 00000022 D1E9                    	shr	ecx, 1
   109 00000024 31C0                    	xor	eax, eax
   110 00000026 F366AB                  	rep	stosw
   111                                  
   112                                  	; Detect (& Enable) AC'97 Audio Device
   113 00000029 E89B040000              	call	DetectAC97
   114 0000002E 731B                    	jnc     short GetFileName
   115                                  
   116                                  _dev_not_ready:
   117                                  ; couldn't find the audio device!
   118                                  	sys	_msg, noDevMsg, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000030 BB[D1210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000035 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000003A BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000003F B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000044 CD40                <1>  int 40h
   119 00000046 E958040000                      jmp     Exit
   120                                  
   121                                  GetFileName:  
   122 0000004B 89E6                    	mov	esi, esp
   123 0000004D AD                      	lodsd
   124 0000004E 83F802                  	cmp	eax, 2 ; two arguments 
   125                                  	       ; (program file name & mod file name)
   126 00000051 0F825A040000            	jb	pmsg_usage ; nothing to do
   127                                  
   128 00000057 AD                      	lodsd ; program file name address 
   129 00000058 AD                      	lodsd ; mod file name address (file to be read)
   130 00000059 89C6                    	mov	esi, eax
   131 0000005B BF[39240000]            	mov	edi, wav_file_name
   132                                  ScanName:       
   133 00000060 AC                      	lodsb
   134 00000061 84C0                    	test	al, al
   135 00000063 0F8448040000            	je	pmsg_usage
   136 00000069 3C20                    	cmp	al, 20h
   137 0000006B 74F3                    	je	short ScanName	; scan start of name.
   138 0000006D AA                      	stosb
   139 0000006E B4FF                    	mov	ah, 0FFh
   140                                  a_0:	
   141 00000070 FEC4                    	inc	ah
   142                                  a_1:
   143 00000072 AC                      	lodsb
   144 00000073 AA                      	stosb
   145 00000074 3C2E                    	cmp	al, '.'
   146 00000076 74F8                    	je	short a_0	
   147 00000078 20C0                    	and	al, al
   148 0000007A 75F6                    	jnz	short a_1
   149                                  
   150 0000007C 08E4                    	or	ah, ah		; if period NOT found,
   151 0000007E 750B                    	jnz	short _1 	; then add a .WAV extension.
   152                                  SetExt:
   153 00000080 4F                      	dec	edi
   154 00000081 C7072E574156            	mov	dword [edi], '.WAV'
   155 00000087 C6470400                	mov	byte [edi+4], 0
   156                                  
   157                                  _1:
   158                                  
   159                                  ; 26/11/2023
   160                                  %if 0
   161                                  	; Allocate Audio Buffer (for user)
   162                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   163                                  	; 26/11/2023
   164                                  	sys	_audio, 0200h, [buffersize], audio_buffer
   165                                  	jnc	short _2
   166                                  error_exit:
   167                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
   168                                  	jmp	Exit
   169                                  _2:
   170                                  	; DIRECT CGA (TEXT MODE) MEMORY ACCESS
   171                                  	; bl = 0, bh = 4
   172                                  	; Direct access/map to CGA (Text) memory (0B8000h)
   173                                  
   174                                  	sys	_video, 0400h
   175                                  	cmp	eax, 0B8000h
   176                                  	jne	short error_exit
   177                                  
   178                                  	; Initialize Audio Device (bh = 3)
   179                                  	sys	_audio, 0301h, 0, audio_int_handler 
   180                                  ;	jc	short error_exit
   181                                  _3:
   182                                  
   183                                  %endif
   184 0000008B E89C060000              	call	write_audio_dev_info 
   185                                  
   186                                  ; open the file
   187                                          ; open existing file
   188 00000090 E841040000                      call    openFile ; no error? ok.
   189 00000095 731B                            jnc     short _gsr
   190                                  
   191                                  ; file not found!
   192                                  	sys	_msg, noFileErrMsg, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000097 BB[FC210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000009C B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000000A1 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000000A6 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000000AB CD40                <1>  int 40h
   193                                  _exit_:
   194 000000AD E9F1030000                      jmp     Exit
   195                                  
   196                                  _gsr:  
   197 000000B2 E859040000                     	call    getSampleRate		; read the sample rate
   198                                                                          ; pass it onto codec.
   199                                  	;jc	Exit
   200                                  	; 25/11/2023
   201 000000B7 72F4                    	jc	short _exit_
   202                                  
   203 000000B9 66A3[12240000]          	mov	[sample_rate], ax
   204 000000BF 880D[10240000]          	mov	[stmo], cl
   205 000000C5 8815[11240000]          	mov	[bps], dl
   206                                  
   207                                  	; 26/11/2023
   208 000000CB C605[8C240000]00        	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   209 000000D2 FEC9                    	dec	cl
   210 000000D4 7506                    	jnz	short _gsr_1 ; stereo
   211 000000D6 FE05[8C240000]          	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   212                                  _gsr_1:	
   213 000000DC 80FA08                  	cmp	dl, 8 
   214 000000DF 7706                    	ja	short _gsr_2 ; 16 bit samples
   215 000000E1 FE05[8C240000]          	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   216                                  _gsr_2:	
   217                                  	; 06/06/2017
   218                                  	sys	_audio, 0E00h ; get audio controller info
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000000E7 BB000E0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000000EC B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000000F1 CD40                <1>  int 40h
   219 000000F3 0F82FE020000            	jc	error_exit ; 25/11/2023
   220                                  
   221                                  	;cmp	ah, 2 ; ICH ? (Intel AC'97 Audio Controller)
   222                                  	;jne	_dev_not_ready	
   223                                  
   224                                  	; EAX = IRQ Number in AL
   225                                  	;	Audio Device Number in AH 
   226                                  	; EBX = DEV/VENDOR ID
   227                                  	;       (DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV)
   228                                  	; ECX = BUS/DEV/FN 
   229                                  	;       (00000000BBBBBBBBDDDDDFFF00000000)
   230                                  	; EDX = NABMBAR/NAMBAR (for AC97)
   231                                  	;      (Low word, DX = NAMBAR address)
   232                                  	; EDX = Base IO Addr (DX) for SB16 & VT8233
   233                                  
   234 000000F9 A2[8B240000]            	mov	[ac97_int_ln_reg], al
   235 000000FE 891D[8D240000]          	mov	[dev_vendor], ebx
   236 00000104 890D[91240000]          	mov	[bus_dev_fn], ecx
   237                                  	;mov	[ac97_NamBar], dx
   238                                  	;shr	dx, 16
   239                                  	;mov	[ac97_NabmBar], dx
   240 0000010A 8915[95240000]          	mov	[ac97_NamBar], edx	
   241                                    
   242                                  	; 01/06/2024
   243                                  	; Reset Audio Device (bh = 8)
   244                                  	sys	_audio, 0800h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000110 BB00080000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000115 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000011A CD40                <1>  int 40h
   245                                  	;jc	error_exit	
   246 0000011C 7239                    	jc	short init_err
   247                                  
   248 0000011E E8EB060000              	call	write_ac97_pci_dev_info
   249                                  
   250                                  	; 01/06/2024
   251                                  	; 25/11/2023
   252                                  	; Get AC'97 Codec info
   253                                  	; (Function 14, sub function 1)
   254                                  	sys	_audio, 0E01h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000123 BB010E0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000128 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000012D CD40                <1>  int 40h
   255                                  	; 06/06/2024
   256 0000012F 7302                    	jnc	short _gsr_3
   257                                  	
   258 00000131 D1E0                    	shl	eax, 1 ; clears AL BIT 0
   259                                  _gsr_3:
   260                                  	; Save Variable Rate Audio support bit
   261 00000133 2401                    	and	al, 1
   262 00000135 A2[1C240000]            	mov	[VRA], al
   263                                  
   264                                  	; 06/06/2024
   265                                  	; ebx = codec vendor id1 & id2 (bx)
   266 0000013A E8E3080000              	call	write_codec_info
   267                                  
   268                                  	; 25/11/2023
   269 0000013F E891080000              	call	write_VRA_info
   270                                  
   271                                  	; 01/05/2017
   272 00000144 E8FA050000              	call	write_wav_file_info
   273                                  
   274                                  	; 25/11/2023
   275                                  	; ------------------------------------------
   276                                  
   277 00000149 803D[1C240000]01        	cmp	byte [VRA], 1
   278 00000150 7220                    	jb	short chk_sample_rate
   279                                  
   280                                  playwav_48_khz:	
   281                                  	;mov	dword [loadfromwavfile], loadFromFile
   282                                  	;mov	dword [buffersize], 65536
   283 00000152 E987020000              	jmp	PlayNow
   284                                  
   285                                  	; 01/06/2024
   286                                  init_err:
   287                                  	sys	_msg, msg_init_err, 255, 0Eh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000157 BB[35220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000015C B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000161 BA0E000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000166 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000016B CD40                <1>  int 40h
   288 0000016D E931030000              	jmp	Exit
   289                                  
   290                                  chk_sample_rate:
   291                                  	; set conversion parameters
   292                                  	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
   293 00000172 66A1[12240000]          	mov	ax, [sample_rate]
   294 00000178 663D80BB                	cmp	ax, 48000
   295 0000017C 74D4                    	je	short playwav_48_khz
   296                                  chk_22khz:
   297 0000017E 663D2256                	cmp	ax, 22050
   298 00000182 7545                    	jne	short chk_11khz
   299 00000184 803D[11240000]08        	cmp	byte [bps], 8
   300 0000018B 7615                    	jna	short chk_22khz_1
   301 0000018D BB[F8160000]            	mov	ebx, load_22khz_stereo_16_bit
   302 00000192 803D[10240000]01        	cmp	byte [stmo], 1 
   303 00000199 751A                    	jne	short chk_22khz_2
   304 0000019B BB[6B160000]            	mov	ebx, load_22khz_mono_16_bit
   305 000001A0 EB13                    	jmp	short chk_22khz_2
   306                                  chk_22khz_1:
   307 000001A2 BB[E4150000]            	mov	ebx, load_22khz_stereo_8_bit
   308 000001A7 803D[10240000]01        	cmp	byte [stmo], 1 
   309 000001AE 7505                    	jne	short chk_22khz_2
   310 000001B0 BB[5B150000]            	mov	ebx, load_22khz_mono_8_bit
   311                                  chk_22khz_2:
   312 000001B5 B85A1D0000              	mov	eax, 7514  ; (442*17)
   313 000001BA BA25000000              	mov	edx, 37
   314 000001BF B911000000              	mov	ecx, 17 
   315 000001C4 E9BA010000              	jmp	set_sizes	
   316                                  chk_11khz:
   317 000001C9 663D112B                	cmp	ax, 11025
   318 000001CD 7545                    	jne	short chk_44khz
   319 000001CF 803D[11240000]08        	cmp	byte [bps], 8
   320 000001D6 7615                    	jna	short chk_11khz_1
   321 000001D8 BB[14190000]            	mov	ebx, load_11khz_stereo_16_bit
   322 000001DD 803D[10240000]01        	cmp	byte [stmo], 1 
   323 000001E4 751A                    	jne	short chk_11khz_2
   324 000001E6 BB[9B180000]            	mov	ebx, load_11khz_mono_16_bit
   325 000001EB EB13                    	jmp	short chk_11khz_2
   326                                  chk_11khz_1:
   327 000001ED BB[21180000]            	mov	ebx, load_11khz_stereo_8_bit
   328 000001F2 803D[10240000]01        	cmp	byte [stmo], 1 
   329 000001F9 7505                    	jne	short chk_11khz_2
   330 000001FB BB[A9170000]            	mov	ebx, load_11khz_mono_8_bit
   331                                  chk_11khz_2:
   332 00000200 B8AD0E0000              	mov	eax, 3757  ; (221*17)
   333 00000205 BA4A000000              	mov	edx, 74
   334 0000020A B911000000              	mov	ecx, 17
   335 0000020F E96F010000              	jmp	set_sizes 
   336                                  chk_44khz:
   337 00000214 663D44AC                	cmp	ax, 44100
   338 00000218 7545                    	jne	short chk_16khz
   339 0000021A 803D[11240000]08        	cmp	byte [bps], 8
   340 00000221 7615                    	jna	short chk_44khz_1
   341 00000223 BB[3B1B0000]            	mov	ebx, load_44khz_stereo_16_bit
   342 00000228 803D[10240000]01        	cmp	byte [stmo], 1 
   343 0000022F 751A                    	jne	short chk_44khz_2
   344 00000231 BB[C21A0000]            	mov	ebx, load_44khz_mono_16_bit
   345 00000236 EB13                    	jmp	short chk_44khz_2
   346                                  chk_44khz_1:
   347 00000238 BB[451A0000]            	mov	ebx, load_44khz_stereo_8_bit
   348 0000023D 803D[10240000]01        	cmp	byte [stmo], 1 
   349 00000244 7505                    	jne	short chk_44khz_2
   350 00000246 BB[C9190000]            	mov	ebx, load_44khz_mono_8_bit
   351                                  chk_44khz_2:
   352 0000024B B8D93A0000              	mov	eax, 15065 ; (655*23)
   353 00000250 BA19000000              	mov	edx, 25
   354 00000255 B917000000              	mov	ecx, 23
   355 0000025A E924010000              	jmp	set_sizes 
   356                                  chk_16khz:
   357 0000025F 663D803E                	cmp	ax, 16000
   358 00000263 7545                    	jne	short chk_8khz
   359 00000265 803D[11240000]08        	cmp	byte [bps], 8
   360 0000026C 7615                    	jna	short chk_16khz_1
   361 0000026E BB[A0100000]            	mov	ebx, load_16khz_stereo_16_bit
   362 00000273 803D[10240000]01        	cmp	byte [stmo], 1 
   363 0000027A 751A                    	jne	short chk_16khz_2
   364 0000027C BB[1F100000]            	mov	ebx, load_16khz_mono_16_bit
   365 00000281 EB13                    	jmp	short chk_16khz_2
   366                                  chk_16khz_1:
   367 00000283 BB[650F0000]            	mov	ebx, load_16khz_stereo_8_bit
   368 00000288 803D[10240000]01        	cmp	byte [stmo], 1 
   369 0000028F 7505                    	jne	short chk_16khz_2
   370 00000291 BB[E60E0000]            	mov	ebx, load_16khz_mono_8_bit
   371                                  chk_16khz_2:
   372 00000296 B855150000              	mov	eax, 5461
   373 0000029B BA03000000              	mov	edx, 3
   374 000002A0 B901000000              	mov	ecx, 1
   375 000002A5 E9D9000000              	jmp	set_sizes 
   376                                  chk_8khz:
   377 000002AA 663D401F                	cmp	ax, 8000
   378 000002AE 7545                    	jne	short chk_24khz
   379 000002B0 803D[11240000]08        	cmp	byte [bps], 8
   380 000002B7 7615                    	jna	short chk_8khz_1
   381 000002B9 BB[9B0D0000]            	mov	ebx, load_8khz_stereo_16_bit
   382 000002BE 803D[10240000]01        	cmp	byte [stmo], 1 
   383 000002C5 751A                    	jne	short chk_8khz_2
   384 000002C7 BB[CB0C0000]            	mov	ebx, load_8khz_mono_16_bit
   385 000002CC EB13                    	jmp	short chk_8khz_2
   386                                  chk_8khz_1:
   387 000002CE BB[9B0B0000]            	mov	ebx, load_8khz_stereo_8_bit
   388 000002D3 803D[10240000]01        	cmp	byte [stmo], 1 
   389 000002DA 7505                    	jne	short chk_8khz_2
   390 000002DC BB[BC0A0000]            	mov	ebx, load_8khz_mono_8_bit
   391                                  chk_8khz_2:
   392 000002E1 B8AA0A0000              	mov	eax, 2730
   393 000002E6 BA06000000              	mov	edx, 6
   394 000002EB B901000000              	mov	ecx, 1
   395 000002F0 E98E000000              	jmp	set_sizes 
   396                                  chk_24khz:
   397 000002F5 663DC05D                	cmp	ax, 24000
   398 000002F9 7542                    	jne	short chk_32khz
   399 000002FB 803D[11240000]08        	cmp	byte [bps], 8
   400 00000302 7615                    	jna	short chk_24khz_1
   401 00000304 BB[CA120000]            	mov	ebx, load_24khz_stereo_16_bit
   402 00000309 803D[10240000]01        	cmp	byte [stmo], 1 
   403 00000310 751A                    	jne	short chk_24khz_2
   404 00000312 BB[67120000]            	mov	ebx, load_24khz_mono_16_bit
   405 00000317 EB13                    	jmp	short chk_24khz_2
   406                                  chk_24khz_1:
   407 00000319 BB[DD110000]            	mov	ebx, load_24khz_stereo_8_bit
   408 0000031E 803D[10240000]01        	cmp	byte [stmo], 1 
   409 00000325 7505                    	jne	short chk_24khz_2
   410 00000327 BB[76110000]            	mov	ebx, load_24khz_mono_8_bit
   411                                  chk_24khz_2:
   412 0000032C B800200000              	mov	eax, 8192
   413 00000331 BA02000000              	mov	edx, 2
   414 00000336 B901000000              	mov	ecx, 1
   415 0000033B EB46                    	jmp	short set_sizes 
   416                                  chk_32khz:
   417 0000033D 663D007D                	cmp	ax, 32000
   418 00000341 7574                    	jne	short vra_needed
   419 00000343 803D[11240000]08        	cmp	byte [bps], 8
   420 0000034A 7615                    	jna	short chk_32khz_1
   421 0000034C BB[CB140000]            	mov	ebx, load_32khz_stereo_16_bit
   422 00000351 803D[10240000]01        	cmp	byte [stmo], 1 
   423 00000358 751A                    	jne	short chk_32khz_2
   424 0000035A BB[61140000]            	mov	ebx, load_32khz_mono_16_bit
   425 0000035F EB13                    	jmp	short chk_32khz_2
   426                                  chk_32khz_1:
   427 00000361 BB[C4130000]            	mov	ebx, load_32khz_stereo_8_bit
   428 00000366 803D[10240000]01        	cmp	byte [stmo], 1 
   429 0000036D 7505                    	jne	short chk_32khz_2
   430 0000036F BB[51130000]            	mov	ebx, load_32khz_mono_8_bit
   431                                  chk_32khz_2:
   432 00000374 B8AA2A0000              	mov	eax, 10922
   433 00000379 BA03000000              	mov	edx, 3
   434 0000037E B902000000              	mov	ecx, 2
   435                                  	;jmp	short set_sizes 
   436                                  set_sizes:
   437 00000383 803D[10240000]01        	cmp	byte [stmo], 1
   438 0000038A 7402                    	je	short ss_1
   439 0000038C D1E0                    	shl	eax, 1
   440                                  ss_1:
   441 0000038E 803D[11240000]08        	cmp	byte [bps], 8
   442 00000395 7602                    	jna	short ss_2
   443                                  	; 16 bit samples
   444 00000397 D1E0                    	shl	eax, 1
   445                                  ss_2:
   446 00000399 A3[D6030000]            	mov	[loadsize], eax
   447 0000039E F7E2                    	mul	edx
   448                                  	;cmp	ecx, 1
   449                                  	;je	short ss_3
   450                                  ;ss_3:
   451 000003A0 F7F1                    	div	ecx
   452 000003A2 8A0D[8C240000]          	mov	cl, [fbs_shift]
   453 000003A8 D3E0                    	shl	eax, cl
   454                                  	; 26/11/2023
   455                                  	;shr	eax, 1	; buffer size is 16 bit sample count
   456 000003AA A3[DA030000]            	mov	[buffersize], eax ; buffer size in bytes 
   457 000003AF 891D[D2030000]          	mov	[loadfromwavfile], ebx
   458 000003B5 EB27                    	jmp	short PlayNow
   459                                  
   460                                  vra_needed:
   461                                  	sys	_msg, msg_no_vra, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000003B7 BB[66220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000003BC B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000003C1 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000003C6 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000003CB CD40                <1>  int 40h
   462 000003CD E9D1000000              	jmp	Exit
   463                                  
   464                                  	; 26/11/2023
   465                                  	; 13/11/2023
   466                                  loadfromwavfile:
   467 000003D2 [9F050000]              	dd	loadFromFile
   468                                  loadsize:	; read from wav file
   469 000003D6 00000000                	dd	0
   470                                  buffersize:	; write to DMA buffer
   471 000003DA 00000100                	dd	65536 ; bytes
   472                                  
   473                                  PlayNow: 
   474                                  
   475                                  ; 26/11/2023
   476                                  %if 1
   477                                  	; Allocate Audio Buffer (for user)
   478                                  	;sys	_audio, 0200h, BUFFERSIZE, audio_buffer
   479                                  	; 26/11/2023
   480                                  	sys	_audio, 0200h, [buffersize], audio_buffer
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000003DE BB00020000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000003E3 8B0D[DA030000]      <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000003E9 BA[00300000]        <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000003EE B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000003F3 CD40                <1>  int 40h
   481 000003F5 731B                    	jnc	short _2
   482                                  
   483                                  	; 26/11/2023 - temporary
   484                                  	;sys	_msg, test_1, 255, 0Ch
   485                                  
   486                                  error_exit:
   487                                  	sys	_msg, trdos386_err_msg, 255, 0Eh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000003F7 BB[15220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000003FC B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000401 BA0E000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000406 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000040B CD40                <1>  int 40h
   488 0000040D E991000000              	jmp	Exit
   489                                  _2:
   490                                  	; DIRECT CGA (TEXT MODE) MEMORY ACCESS
   491                                  	; bl = 0, bh = 4
   492                                  	; Direct access/map to CGA (Text) memory (0B8000h)
   493                                  
   494                                  	sys	_video, 0400h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000412 BB00040000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000417 B81F000000          <1>  mov eax, %1
    86                              <1> 
    87 0000041C CD40                <1>  int 40h
   495 0000041E 3D00800B00              	cmp	eax, 0B8000h
   496 00000423 75D2                    	jne	short error_exit
   497                                  
   498                                  	; 01/06/2024
   499                                  	; Initialize Audio Device (bh = 3)
   500                                  	sys	_audio, 0301h, 0, audio_int_handler 
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000425 BB01030000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000042A B900000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000042F BA[6E050000]        <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000434 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000439 CD40                <1>  int 40h
   501                                  	;jc	short error_exit
   502 0000043B 0F8216FDFFFF            	jc	init_err
   503                                  _3:
   504                                  
   505                                  %endif
   506                                  
   507                                  ;
   508                                  ; position file pointer to start in actual wav data
   509                                  ; MUCH improvement should really be done here to check if sample size is
   510                                  ; supported, make sure there are 2 channels, etc.  
   511                                  ;
   512                                          ;mov     ah, 42h
   513                                          ;mov     al, 0	; from start of file
   514                                          ;mov     bx, [FileHandle]
   515                                          ;xor     cx, cx
   516                                          ;mov     dx, 44	; jump past .wav/riff header
   517                                          ;int     21h
   518                                  
   519                                  	sys	_seek, [FileHandle], 44, 0
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000441 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000447 B92C000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000044C BA00000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000451 B813000000          <1>  mov eax, %1
    86                              <1> 
    87 00000456 CD40                <1>  int 40h
   520                                  
   521                                  	sys	_msg, nextline, 255, 07h ; 01/05/2017
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000458 BB[EB220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000045D B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000462 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000467 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000046C CD40                <1>  int 40h
   522                                  
   523                                  ; play the .wav file. Most of the good stuff is in here.
   524                                  
   525 0000046E E8E1010000                      call    PlayWav
   526                                  
   527                                  ; close the .wav file and exit.
   528                                  
   529                                  StopPlaying:
   530                                  	; Stop Playing
   531                                  	sys	_audio, 0700h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000473 BB00070000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000478 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000047D CD40                <1>  int 40h
   532                                  	; Cancel callback service (for user)
   533                                  	sys	_audio, 0900h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000047F BB00090000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000484 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000489 CD40                <1>  int 40h
   534                                  	; Deallocate Audio Buffer (for user)
   535                                  	sys	_audio, 0A00h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000048B BB000A0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000490 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000495 CD40                <1>  int 40h
   536                                  	; Disable Audio Device
   537                                  	sys	_audio, 0C00h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000497 BB000C0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000049C B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000004A1 CD40                <1>  int 40h
   538                                  Exit:  
   539 000004A3 E847000000                      call    closeFile
   540                                           
   541                                  	sys	_exit	; Bye!
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004A8 B801000000          <1>  mov eax, %1
    86                              <1> 
    87 000004AD CD40                <1>  int 40h
   542                                  here:
   543 000004AF EBFE                    	jmp	short here
   544                                  
   545                                  pmsg_usage:
   546                                  	sys	_msg, msg_usage, 255, 0Bh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004B1 BB[B2210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000004B6 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000004BB BA0B000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004C0 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000004C5 CD40                <1>  int 40h
   547 000004C7 EBDA                    	jmp	short Exit
   548                                  
   549                                  	; 25/11/2023
   550                                  DetectAC97:
   551                                  	; Detect (BH=1) AC'97 (BL=2) Audio Device
   552                                          sys	_audio, 0102h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004C9 BB02010000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004CE B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000004D3 CD40                <1>  int 40h
   553                                  
   554                                  ; 01/06/2024
   555                                  %if 0
   556                                  	jc	short DetectAC97_retn
   557                                  
   558                                  	; 25/11/2023
   559                                  	; Get AC'97 Codec info
   560                                  	; (Function 14, sub function 1)
   561                                  	sys	_audio, 0E01h
   562                                  	; Save Variable Rate Audio support bit
   563                                  	and	al, 1
   564                                  	mov	[VRA], al
   565                                  %endif
   566                                  
   567                                  DetectAC97_retn:
   568 000004D5 C3                      	retn
   569                                  
   570                                  ;open or create file
   571                                  ;
   572                                  ;input: ds:dx-->filename (asciiz)
   573                                  ;       al=file Mode (create or open)
   574                                  ;output: none  cs:[FileHandle] filled
   575                                  ;
   576                                  openFile:
   577                                  	;mov	ah, 3Bh	; start with a mode
   578                                  	;add	ah, al	; add in create or open mode
   579                                  	;xor	ecx, ecx
   580                                  	;int	21h
   581                                  	;jc	short _of1
   582                                  	;;mov	[cs:FileHandle], ax
   583                                  
   584                                  	sys	_open, wav_file_name, 0
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004D6 BB[39240000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000004DB B900000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004E0 B805000000          <1>  mov eax, %1
    86                              <1> 
    87 000004E5 CD40                <1>  int 40h
   585 000004E7 7205                    	jc	short _of1
   586                                  
   587 000004E9 A3[09210000]            	mov	[FileHandle], eax
   588                                  _of1:
   589 000004EE C3                      	retn
   590                                  
   591                                  ; close the currently open file
   592                                  ; input: none, uses cs:[FileHandle]
   593                                  closeFile:
   594 000004EF 833D[09210000]FF        	cmp	dword [FileHandle], -1
   595 000004F6 7417                    	je	short _cf1
   596                                  	;mov    bx, [FileHandle]  
   597                                  	;mov    ax, 3E00h
   598                                          ;int    21h              ;close file
   599                                  
   600                                  	sys	_close, [FileHandle]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000004F8 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000004FE B806000000          <1>  mov eax, %1
    86                              <1> 
    87 00000503 CD40                <1>  int 40h
   601 00000505 C705[09210000]FFFF-     	mov 	dword [FileHandle], -1
   601 0000050D FFFF               
   602                                  _cf1:
   603 0000050F C3                      	retn
   604                                  
   605                                  getSampleRate:
   606                                  	
   607                                  ; reads the sample rate from the .wav file.
   608                                  ; entry: none - assumes file is already open
   609                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   610                                  ;	cx = number of channels (mono=1, stereo=2)
   611                                  ;	dx = bits per sample (8, 16)
   612                                  
   613 00000510 53                      	push    ebx
   614                                  
   615                                          ;mov	ah, 42h
   616                                          ;mov	al, 0	; from start of file
   617                                          ;mov	bx, [FileHandle]
   618                                          ;xor	ecx, ecx
   619                                          ;mov	dx, 08h	; "WAVE"
   620                                          ;int	21h
   621                                  	
   622                                  	sys	_seek, [FileHandle], 8, 0
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000511 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000517 B908000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000051C BA00000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000521 B813000000          <1>  mov eax, %1
    86                              <1> 
    87 00000526 CD40                <1>  int 40h
   623                                  
   624                                          ;mov	dx, smpRBuff
   625                                          ;mov	cx, 28	; 28 bytes
   626                                  	;mov	ah, 3fh
   627                                          ;int	21h
   628                                  
   629                                  	sys	_read, [FileHandle], smpRBuff, 28
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000528 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000052E B9[1D240000]        <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000533 BA1C000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000538 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000053D CD40                <1>  int 40h
   630                                  
   631 0000053F 813D[1D240000]5741-     	cmp	dword [smpRBuff], 'WAVE'
   631 00000547 5645               
   632 00000549 7520                    	jne	short gsr_stc
   633                                  
   634 0000054B 66833D[29240000]01      	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   635 00000553 7516                    	jne	short gsr_stc
   636                                  
   637 00000555 668B0D[2B240000]        	mov	cx, [smpRBuff+14]	; return num of channels in CX
   638 0000055C 66A1[2D240000]                  mov     ax, [smpRBuff+16]	; return sample rate in AX
   639 00000562 668B15[37240000]        	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   640                                  gsr_retn:
   641 00000569 5B                              pop     ebx
   642 0000056A C3                              retn
   643                                  gsr_stc:
   644 0000056B F9                      	stc
   645 0000056C EBFB                    	jmp	short gsr_retn
   646                                  
   647                                  audio_int_handler:
   648                                  	; 18/08/2020 (14/10/2020, 'wavplay2.s')
   649                                  
   650                                  	;mov	byte [srb], 1 ; interrupt (or signal response byte)
   651                                  	
   652                                  	;cmp	byte [cbs_busy], 1
   653                                  	;jnb	short _callback_bsy_retn
   654                                  	
   655                                  	;mov	byte [cbs_busy], 1
   656                                  
   657 0000056E A0[19240000]            	mov	al, [half_buff]
   658                                  
   659 00000573 3C01                    	cmp	al, 1
   660 00000575 721A                    	jb	short _callback_retn
   661                                  
   662                                  	; 18/08/2020
   663 00000577 C605[1A240000]01        	mov	byte [srb], 1
   664                                  
   665 0000057E 8035[19240000]03        	xor	byte [half_buff], 3 ; 2->1, 1->2
   666                                  
   667 00000585 0430                    	add	al, '0'
   668                                  tL0:	; 26/11/2023
   669 00000587 B44E                    	mov	ah, 4Eh
   670 00000589 BB00800B00              	mov	ebx, 0B8000h ; video display page address
   671 0000058E 668903                  	mov	[ebx], ax ; show playing buffer (1, 2)
   672                                  _callback_retn:
   673                                  	;mov	byte [cbs_busy], 0
   674                                  _callback_bsy_retn:
   675                                  	sys	_rele ; return from callback service 
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000591 B827000000          <1>  mov eax, %1
    86                              <1> 
    87 00000596 CD40                <1>  int 40h
   676                                  	; we must not come here !
   677                                  	sys	_exit
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000598 B801000000          <1>  mov eax, %1
    86                              <1> 
    87 0000059D CD40                <1>  int 40h
   678                                  	
   679                                  loadFromFile:
   680                                  	; 26/11/2023
   681 0000059F F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
   682                                  					; last of the file?
   683 000005A6 7402                    	jz	short lff_0		; no
   684 000005A8 F9                      	stc
   685 000005A9 C3                      	retn
   686                                  lff_0:
   687                                  	; 13/06/2017
   688                                  	;mov	edx, BUFFERSIZE
   689                                  	; 26/11/2023
   690 000005AA BF[00300000]            	mov	edi, audio_buffer
   691 000005AF 8B15[DA030000]          	mov	edx, [buffersize]	; bytes
   692 000005B5 8A0D[8C240000]          	mov	cl, [fbs_shift]   
   693 000005BB 20C9                    	and	cl, cl
   694 000005BD 7409                    	jz	short lff_1 ; stereo, 16 bit
   695                                  
   696                                  	; fbs_shift =
   697                                  	;	2 for mono and 8 bit sample (multiplier = 4)
   698                                  	;	1 for mono or 8 bit sample (multiplier = 2)
   699 000005BF D3EA                    	shr	edx, cl
   700                                  	;inc	edx
   701                                  
   702 000005C1 BE[00300100]            	mov     esi, temp_buffer
   703 000005C6 EB02                    	jmp	short lff_2
   704                                  lff_1:
   705                                  	;mov	esi, audio_buffer
   706 000005C8 89FE                    	mov	esi, edi ; audio_buffer
   707                                  lff_2:
   708                                  	; 17/03/2017
   709                                  	; esi = buffer address
   710                                  	; edx = buffer size
   711                                   
   712                                  	; 26/11/2023
   713                                  	; load file into memory
   714                                  	sys 	_read, [FileHandle], esi
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000005CA 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000005D0 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000005D2 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000005D7 CD40                <1>  int 40h
   715 000005D9 89D1                    	mov	ecx, edx
   716 000005DB 724A                    	jc	short padfill ; error !
   717                                  
   718 000005DD 21C0                    	and	eax, eax
   719 000005DF 7446                    	jz	short padfill
   720                                  lff_3:
   721                                  	; 26/11/2023
   722 000005E1 8A1D[8C240000]          	mov	bl, [fbs_shift]
   723 000005E7 20DB                    	and	bl, bl
   724 000005E9 745C                    	jz	short lff_11
   725                                  
   726 000005EB 29C1                    	sub	ecx, eax
   727 000005ED 89CD                    	mov	ebp, ecx
   728                                  
   729                                  	;mov	esi, temp_buffer
   730                                  	;mov	edi, audio_buffer
   731 000005EF 89C1                    	mov	ecx, eax   ; byte count
   732                                  
   733 000005F1 803D[11240000]08        	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   734 000005F8 751E                    	jne	short lff_6 ; 16 bit samples
   735                                  	; 8 bit samples
   736 000005FA FECB                    	dec	bl  ; shift count, 1 = stereo, 2 = mono
   737 000005FC 740E                    	jz	short lff_5 ; 8 bit, stereo
   738                                  lff_4:
   739                                  	; mono & 8 bit
   740 000005FE AC                      	lodsb
   741 000005FF 2C80                    	sub	al, 80h ; 08/11/2023
   742 00000601 C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   743 00000604 66AB                    	stosw	; left channel
   744 00000606 66AB                    	stosw	; right channel
   745 00000608 E2F4                    	loop	lff_4
   746 0000060A EB16                    	jmp	short lff_8
   747                                  lff_5:
   748                                  	; stereo & 8 bit
   749 0000060C AC                      	lodsb
   750 0000060D 2C80                    	sub	al, 80h ; 08/11/2023
   751 0000060F C1E008                  	shl	eax, 8 ; convert 8 bit sample to 16 bit sample
   752 00000612 66AB                    	stosw
   753 00000614 E2F6                    	loop	lff_5			
   754 00000616 EB0A                    	jmp	short lff_8
   755                                  lff_6:
   756 00000618 D1E9                    	shr	ecx, 1 ; word count
   757                                  lff_7:
   758 0000061A 66AD                    	lodsw
   759 0000061C 66AB                    	stosw	; left channel
   760 0000061E 66AB                    	stosw	; right channel
   761 00000620 E2F8                    	loop	lff_7
   762                                  lff_8:
   763                                  	; 27/11/2023
   764 00000622 F8                      	clc
   765 00000623 89E9                    	mov	ecx, ebp
   766 00000625 E314                    	jecxz	endLFF_retn
   767                                  	
   768                                  padfill:
   769 00000627 803D[11240000]10        	cmp 	byte [bps], 16
   770 0000062E 740C                    	je	short lff_10
   771                                  	; Minimum Value = 0
   772 00000630 30C0                            xor     al, al
   773 00000632 F3AA                    	rep	stosb
   774                                  lff_9:
   775 00000634 800D[18240000]01                or	byte [flags], ENDOFFILE	; end of file flag
   776                                  endLFF_retn:
   777 0000063B C3                              retn
   778                                  lff_10:
   779 0000063C 31C0                    	xor	eax, eax
   780                                  	; Minimum value = 8000h (-32768)
   781 0000063E D1E9                    	shr	ecx, 1 
   782 00000640 B480                    	mov	ah, 80h ; ax = -32768
   783 00000642 F366AB                  	rep	stosw
   784 00000645 EBED                    	jmp	short lff_9
   785                                  
   786                                  lff_11:
   787                                  	; 16 bit stereo
   788                                  	; ecx = buffer size
   789                                  	; eax = read count
   790 00000647 29C1                    	sub	ecx, eax
   791 00000649 76F0                    	jna	short endLFF_retn
   792 0000064B 01C7                    	add	edi, eax  ; audio_buffer + eax
   793 0000064D EBED                    	jmp	short lff_10 ; padfill
   794                                  
   795                                  error_exit_2:
   796                                  	; 26/11/2023 - temporary
   797                                  	;sys	_msg, test_2, 255, 0Ch
   798                                  
   799 0000064F E9A3FDFFFF              	jmp	error_exit
   800                                  	
   801                                  	; 26/11/2023 - temporary
   802                                  ;test_1:
   803                                  ;	db 13, 10, 'Test 1', 13,10, 0
   804                                  ;test_2:
   805                                  ;	db 13, 10, 'Test 2', 13,10, 0
   806                                  	
   807                                  PlayWav:
   808                                  	; 26/11/2023
   809                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   810                                  	; 13/06/2017
   811                                  	; Convert 8 bit samples to 16 bit samples
   812                                  	; and convert mono samples to stereo samples
   813                                  
   814                                  	; 26/11/2023
   815                                  	; load 32768 bytes into audio buffer
   816                                  	;mov	edi, audio_buffer
   817                                  	;;mov	edx, BUFFERSIZE
   818                                  	; 26/11/2023
   819                                  	;mov	edx, [buffersize]
   820                                  	;call	loadFromFile
   821                                  	; 26/11/2023
   822 00000654 FF15[D2030000]          	call	dword [loadfromwavfile]
   823 0000065A 72F3                    	jc	short error_exit_2
   824 0000065C C605[19240000]01        	mov	byte [half_buff], 1 ; (DMA) Buffer 1
   825                                  
   826                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   827 00000663 F605[18240000]01        	test    byte [flags], ENDOFFILE  ; end of file
   828 0000066A 7512                    	jnz	short _6 ; yes
   829                                  			 ; bypass filling dma half buffer 2
   830                                  
   831                                  	; bh = 16 : update (current, first) dma half buffer
   832                                  	; bl = 0  : then switch to the next (second) half buffer
   833                                  	sys	_audio, 1000h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000066C BB00100000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000671 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000676 CD40                <1>  int 40h
   834                                  
   835                                  	; 18/08/2020
   836                                  	; [audio_flag] = 1 (in TRDOS 386 kernel)
   837                                  
   838                                  	; audio_buffer must be filled again after above system call 
   839                                  	; (Because audio interrupt will be generated by AC97 hardware
   840                                  	; at the end of the first half of dma buffer.. so, 
   841                                  	; the second half must be ready. 'sound_play' will use it.)
   842                                  
   843                                  	; 26/11/2023
   844                                  	;mov	edi, audio_buffer
   845                                  	;;mov	edx, BUFFERSIZE
   846                                  	; 26/11/2023
   847                                  	;mov	edx, [buffersize]
   848                                  	;call	loadFromFile
   849                                  	; 26/11/2023
   850 00000678 FF15[D2030000]          	call	dword [loadfromwavfile]
   851                                  	;jc	short p_return
   852                                  _6:
   853                                  	; Set Master Volume Level (BL=0 or 80h)
   854                                  	; 	for next playing (BL>=80h)
   855                                  	;sys	_audio, 0B80h, 1D1Dh
   856                                  	sys	_audio, 0B00h, 1D1Dh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000067E BB000B0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000683 B91D1D0000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000688 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 0000068D CD40                <1>  int 40h
   857                                  
   858                                  	; 18/08/2020
   859                                  	;mov	byte [volume_level], 1Dh
   860 0000068F 880D[1B240000]          	mov	[volume_level], cl
   861                                  
   862                                  	; Start	to play
   863 00000695 A0[11240000]            	mov	al, [bps]
   864 0000069A C0E804                  	shr	al, 4 ; 8 -> 0, 16 -> 1
   865 0000069D D0E0                    	shl	al, 1 ; 16 -> 2, 8 -> 0
   866 0000069F 8A1D[10240000]          	mov	bl, [stmo]
   867 000006A5 FECB                    	dec	bl
   868 000006A7 08C3                    	or	bl, al
   869 000006A9 668B0D[12240000]        	mov	cx, [sample_rate] 
   870 000006B0 B704                    	mov	bh, 4 ; start to play
   871                                  	sys	_audio
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77                              <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000006B2 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 000006B7 CD40                <1>  int 40h
   872                                  
   873                                  	;mov	ebx, 0B8000h ; video display page address
   874                                  	;mov	ah, 4Eh
   875                                  	;mov	al, [half_buffer]
   876                                  	;mov	[ebx], ax ; show playing buffer (1, 2)
   877                                  
   878                                  	; 18/08/2020 (27/07/2020, 'wavplay2.s')
   879                                  	; Here..
   880                                  	; If byte [flags] <> ENDOFFILE ...
   881                                  	; user's audio_buffer has been copied to dma half buffer 2
   882                                  
   883                                  	; [audio_flag] = 0 (in TRDOS 386 kernel)
   884                                  
   885                                  	; audio_buffer must be filled again after above system call 
   886                                  	; (Because, audio interrupt will be generated by VT8237R
   887                                  	; at the end of the first half of dma buffer.. so, 
   888                                  	; the 2nd half of dma buffer is ready but the 1st half
   889                                  	; must be filled again.)
   890                                  
   891                                  	; 18/08/2020
   892 000006B9 F605[18240000]01        	test    byte [flags], ENDOFFILE  ; end of file
   893 000006C0 7506                    	jnz	short p_loop ; yes
   894                                  
   895                                  	; 18/08/2020
   896                                  	; load 32768 bytes into audio buffer
   897                                  	;; (for the second half of DMA buffer)
   898                                  	; 27/11/2023
   899                                  	; 20/05/2017
   900                                  	;mov	edi, audio_buffer
   901                                  	;mov	edx, BUFFERSIZE
   902                                  	; 26/11/2023
   903                                  	;mov	edx, [buffersize]
   904                                  	;call	loadFromFile
   905                                  	; 26/11/2023
   906 000006C2 FF15[D2030000]          	call	dword [loadfromwavfile]
   907                                  	;jc	short p_return
   908                                  	;mov	byte [half_buff], 2 ; (DMA) Buffer 2
   909                                  
   910                                  	; we need to wait for 'SRB' (audio interrupt)
   911                                  	; (we can not return from 'PlayWav' here 
   912                                  	;  even if we have got an error from file reading)
   913                                  	; ((!!current audio data must be played!!))
   914                                  
   915                                  	; 18/08/2020
   916                                  	;mov	byte [srb], 1
   917                                  
   918                                  p_loop:
   919                                  	;mov	ah, 1		; any key pressed?
   920                                  	;int	32h		; no, Loop.
   921                                  	;jz	short q_loop
   922                                  	;
   923                                  	;mov	ah, 0		; flush key buffer...
   924                                  	;int	32h
   925                                  
   926                                  	; 18/08/2020 (14/10/2017, 'wavplay2.s')
   927 000006C8 803D[1A240000]00        	cmp	byte [srb], 0
   928 000006CF 760F                    	jna	short q_loop
   929 000006D1 C605[1A240000]00        	mov	byte [srb], 0
   930                                  	; 27/11/2023
   931                                  	;mov	edi, audio_buffer
   932                                  	;mov	edx, BUFFERSIZE
   933                                  	; 26/11/2023
   934                                  	;mov	edx, [buffersize]
   935                                  	;call	loadFromFile
   936                                  	; 26/11/2023
   937 000006D8 FF15[D2030000]          	call	dword [loadfromwavfile]
   938 000006DE 7212                    	jc	short p_return
   939                                  q_loop:
   940 000006E0 B401                    	mov     ah, 1		; any key pressed?
   941 000006E2 CD32                    	int     32h		; no, Loop.
   942 000006E4 74E2                    	jz	short p_loop
   943                                  
   944 000006E6 B400                    	mov     ah, 0		; flush key buffer...
   945 000006E8 CD32                    	int     32h
   946                                  	
   947 000006EA 3C2B                    	cmp	al, '+' ; increase sound volume
   948 000006EC 740C                    	je	short inc_volume_level
   949 000006EE 3C2D                    	cmp	al, '-'
   950 000006F0 742B                    	je	short dec_volume_level
   951                                  
   952                                  p_return:
   953 000006F2 C605[19240000]00        	mov	byte [half_buff], 0
   954 000006F9 C3                      	retn
   955                                  
   956                                  	; 18/08/2020 (14/10/2017, 'wavplay2.s')
   957                                  inc_volume_level:
   958 000006FA 8A0D[1B240000]          	mov	cl, [volume_level]
   959 00000700 80F91F                  	cmp	cl, 1Fh ; 31
   960 00000703 73DB                    	jnb	short q_loop
   961 00000705 FEC1                    	inc	cl
   962                                  change_volume_level:
   963 00000707 880D[1B240000]          	mov	[volume_level], cl
   964 0000070D 88CD                    	mov	ch, cl
   965                                  	; Set Master Volume Level
   966                                  	sys	_audio, 0B00h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000070F BB000B0000          <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79                              <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81                              <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000714 B820000000          <1>  mov eax, %1
    86                              <1> 
    87 00000719 CD40                <1>  int 40h
   967 0000071B EBAB                    	jmp	short p_loop
   968                                  dec_volume_level:
   969 0000071D 8A0D[1B240000]          	mov	cl, [volume_level]
   970 00000723 80F901                  	cmp	cl, 1 ; 1
   971 00000726 76A0                    	jna	short p_loop
   972 00000728 FEC9                    	dec	cl
   973 0000072A EBDB                    	jmp	short change_volume_level
   974                                  
   975                                  write_audio_dev_info:
   976                                  	; EBX = Message address
   977                                  	; ECX = Max. message length (or stop on ZERO character)
   978                                  	;	(1 to 255)
   979                                  	; DL  = Message color (07h = light gray, 0Fh = white) 
   980                                       	sys 	_msg, msgAudioCardInfo, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000072C BB[89210000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000731 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000736 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000073B B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000740 CD40                <1>  int 40h
   981 00000742 C3                      	retn
   982                                  
   983                                  write_wav_file_info:
   984                                  	; 01/05/2017
   985                                  	sys	_msg, msgWavFileName, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000743 BB[9F220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000748 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000074D BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000752 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000757 CD40                <1>  int 40h
   986                                  	sys	_msg, wav_file_name, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000759 BB[39240000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000075E B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000763 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000768 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000076D CD40                <1>  int 40h
   987                                  
   988                                  write_sample_rate:
   989                                  	; 01/05/2017
   990 0000076F 66A1[12240000]          	mov	ax, [sample_rate]
   991                                  	; ax = sample rate (hertz)
   992 00000775 31D2                    	xor	edx, edx
   993 00000777 66B90A00                	mov	cx, 10
   994 0000077B 66F7F1                  	div	cx
   995 0000077E 0015[C4220000]          	add	[msgHertz+4], dl
   996 00000784 29D2                    	sub	edx, edx
   997 00000786 66F7F1                  	div	cx
   998 00000789 0015[C3220000]          	add	[msgHertz+3], dl
   999 0000078F 29D2                    	sub	edx, edx
  1000 00000791 66F7F1                  	div	cx
  1001 00000794 0015[C2220000]          	add	[msgHertz+2], dl
  1002 0000079A 29D2                    	sub	edx, edx
  1003 0000079C 66F7F1                  	div	cx
  1004 0000079F 0015[C1220000]          	add	[msgHertz+1], dl
  1005 000007A5 0005[C0220000]          	add	[msgHertz], al
  1006                                  	
  1007                                  	sys	_msg, msgSampleRate, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000007AB BB[B1220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000007B0 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000007B5 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000007BA B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000007BF CD40                <1>  int 40h
  1008                                  
  1009 000007C1 BE[DB220000]            	mov	esi, msg16Bits
  1010 000007C6 803D[11240000]10        	cmp	byte [bps], 16
  1011 000007CD 7405                    	je	short wsr_1
  1012 000007CF BE[CB220000]            	mov	esi, msg8Bits
  1013                                  wsr_1:
  1014                                  	sys	_msg, esi, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000007D4 89F3                <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000007D6 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000007DB BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000007E0 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000007E5 CD40                <1>  int 40h
  1015                                  
  1016 000007E7 BE[D4220000]            	mov	esi, msgMono
  1017 000007EC 803D[10240000]01        	cmp	byte [stmo], 1
  1018 000007F3 7405                    	je	short wsr_2
  1019 000007F5 BE[E5220000]            	mov	esi, msgStereo		
  1020                                  wsr_2:
  1021                                  	sys	_msg, esi, 255, 0Fh
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000007FA 89F3                <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000007FC B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000801 BA0F000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000806 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 0000080B CD40                <1>  int 40h
  1022 0000080D C3                              retn
  1023                                  
  1024                                  write_ac97_pci_dev_info:
  1025                                  	; 06/06/2017
  1026                                  	; 03/06/2017
  1027                                  	; BUS/DEV/FN
  1028                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  1029                                  	; DEV/VENDOR
  1030                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  1031                                  
  1032 0000080E 8B35[8D240000]          	mov	esi, [dev_vendor]
  1033 00000814 89F0                    	mov	eax, esi
  1034 00000816 0FB6D8                  	movzx	ebx, al
  1035 00000819 88DA                    	mov	dl, bl
  1036 0000081B 80E30F                  	and	bl, 0Fh
  1037 0000081E 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1038 00000824 A2[33230000]            	mov	[msgVendorId+3], al
  1039 00000829 88D3                    	mov	bl, dl
  1040 0000082B C0EB04                  	shr	bl, 4
  1041 0000082E 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1042 00000834 A2[32230000]            	mov	[msgVendorId+2], al
  1043 00000839 88E3                    	mov	bl, ah
  1044 0000083B 88DA                    	mov	dl, bl
  1045 0000083D 80E30F                  	and	bl, 0Fh
  1046 00000840 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1047 00000846 A2[31230000]            	mov	[msgVendorId+1], al
  1048 0000084B 88D3                    	mov	bl, dl
  1049 0000084D C0EB04                  	shr	bl, 4
  1050 00000850 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1051 00000856 A2[30230000]            	mov	[msgVendorId], al
  1052 0000085B C1E810                  	shr	eax, 16
  1053 0000085E 88C3                    	mov	bl, al
  1054 00000860 88DA                    	mov	dl, bl
  1055 00000862 80E30F                  	and	bl, 0Fh
  1056 00000865 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1057 0000086B A2[44230000]            	mov	[msgDevId+3], al
  1058 00000870 88D3                    	mov	bl, dl
  1059 00000872 C0EB04                  	shr	bl, 4
  1060 00000875 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1061 0000087B A2[43230000]            	mov	[msgDevId+2], al
  1062 00000880 88E3                    	mov	bl, ah
  1063 00000882 88DA                    	mov	dl, bl
  1064 00000884 80E30F                  	and	bl, 0Fh
  1065 00000887 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1066 0000088D A2[42230000]            	mov	[msgDevId+1], al
  1067 00000892 88D3                    	mov	bl, dl
  1068 00000894 C0EB04                  	shr	bl, 4
  1069 00000897 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1070 0000089D A2[41230000]            	mov	[msgDevId], al
  1071                                  
  1072 000008A2 8B35[91240000]          	mov	esi, [bus_dev_fn]
  1073 000008A8 C1EE08                  	shr	esi, 8
  1074 000008AB 6689F0                  	mov	ax, si
  1075 000008AE 88C3                    	mov	bl, al
  1076 000008B0 88DA                    	mov	dl, bl
  1077 000008B2 80E307                  	and	bl, 7 ; bit 0,1,2
  1078 000008B5 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1079 000008BB A2[68230000]            	mov	[msgFncNo+1], al
  1080 000008C0 88D3                    	mov	bl, dl
  1081 000008C2 C0EB03                  	shr	bl, 3
  1082 000008C5 88DA                    	mov	dl, bl
  1083 000008C7 80E30F                  	and	bl, 0Fh
  1084 000008CA 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1085 000008D0 A2[5A230000]            	mov	[msgDevNo+1], al
  1086 000008D5 88D3                    	mov	bl, dl
  1087 000008D7 C0EB04                  	shr	bl, 4
  1088 000008DA 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1089 000008E0 A2[59230000]            	mov	[msgDevNo], al
  1090 000008E5 88E3                    	mov	bl, ah
  1091 000008E7 88DA                    	mov	dl, bl
  1092 000008E9 80E30F                  	and	bl, 0Fh
  1093 000008EC 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1094 000008F2 A2[4E230000]            	mov	[msgBusNo+1], al
  1095 000008F7 88D3                    	mov	bl, dl
  1096 000008F9 C0EB04                  	shr	bl, 4
  1097 000008FC 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1098 00000902 A2[4D230000]            	mov	[msgBusNo], al
  1099                                  
  1100 00000907 66A1[95240000]          	mov	ax, [ac97_NamBar]
  1101 0000090D 88C3                    	mov	bl, al
  1102 0000090F 88DA                    	mov	dl, bl
  1103 00000911 80E30F                  	and	bl, 0Fh
  1104 00000914 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1105 0000091A A2[77230000]            	mov	[msgNamBar+3], al
  1106 0000091F 88D3                    	mov	bl, dl
  1107 00000921 C0EB04                  	shr	bl, 4
  1108 00000924 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1109 0000092A A2[76230000]            	mov	[msgNamBar+2], al
  1110 0000092F 88E3                    	mov	bl, ah
  1111 00000931 88DA                    	mov	dl, bl
  1112 00000933 80E30F                  	and	bl, 0Fh
  1113 00000936 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1114 0000093C A2[75230000]            	mov	[msgNamBar+1], al
  1115 00000941 88D3                    	mov	bl, dl
  1116 00000943 C0EB04                  	shr	bl, 4
  1117 00000946 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1118 0000094C A2[74230000]            	mov	[msgNamBar], al
  1119                                  
  1120 00000951 66A1[97240000]          	mov	ax, [ac97_NabmBar]
  1121 00000957 88C3                    	mov	bl, al
  1122 00000959 88DA                    	mov	dl, bl
  1123 0000095B 80E30F                  	and	bl, 0Fh
  1124 0000095E 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1125 00000964 A2[87230000]            	mov	[msgNabmBar+3], al
  1126 00000969 88D3                    	mov	bl, dl
  1127 0000096B C0EB04                  	shr	bl, 4
  1128 0000096E 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1129 00000974 A2[86230000]            	mov	[msgNabmBar+2], al
  1130 00000979 88E3                    	mov	bl, ah
  1131 0000097B 88DA                    	mov	dl, bl
  1132 0000097D 80E30F                  	and	bl, 0Fh
  1133 00000980 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1134 00000986 A2[85230000]            	mov	[msgNabmBar+1], al
  1135 0000098B 88D3                    	mov	bl, dl
  1136 0000098D C0EB04                  	shr	bl, 4
  1137 00000990 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1138 00000996 A2[84230000]            	mov	[msgNabmBar], al
  1139                                  
  1140 0000099B 30E4                    	xor	ah, ah
  1141 0000099D A0[8B240000]            	mov	al, [ac97_int_ln_reg]
  1142 000009A2 B10A                    	mov	cl, 10
  1143 000009A4 F6F1                    	div	cl
  1144 000009A6 660105[90230000]        	add	[msgIRQ], ax
  1145 000009AD 20C0                    	and	al, al
  1146 000009AF 750D                    	jnz	short _w_ac97imsg_
  1147 000009B1 A0[91230000]            	mov	al, [msgIRQ+1]
  1148 000009B6 B420                    	mov	ah, ' '
  1149 000009B8 66A3[90230000]          	mov	[msgIRQ], ax
  1150                                  _w_ac97imsg_:
  1151                                  	sys	_msg, msgAC97Info, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009BE BB[FF220000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000009C3 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000009C8 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000009CD B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000009D2 CD40                <1>  int 40h
  1152                                  
  1153 000009D4 C3                              retn
  1154                                  
  1155                                  write_VRA_info:
  1156                                  	; 25/11/2023
  1157                                  	sys	_msg, msgVRAheader, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009D5 BB[C8230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000009DA B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000009DF BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000009E4 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 000009E9 CD40                <1>  int 40h
  1158 000009EB 803D[1C240000]00        	cmp	byte [VRA], 0
  1159 000009F2 7617                    	jna	short _w_VRAi_no
  1160                                  _w_VRAi_yes:
  1161                                  	sys	_msg, msgVRAyes, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000009F4 BB[D6230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000009F9 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000009FE BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000A03 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000A08 CD40                <1>  int 40h
  1162 00000A0A C3                      	retn
  1163                                  _w_VRAi_no:
  1164                                  	sys	_msg, msgVRAno, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000A0B BB[DC230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000A10 B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000A15 BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000A1A B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000A1F CD40                <1>  int 40h
  1165 00000A21 C3                      	retn
  1166                                  
  1167                                  	; 06/06/2024
  1168                                  write_codec_info:
  1169 00000A22 89DA                    	mov	edx, ebx
  1170 00000A24 83E30F                  	and	ebx, 0Fh
  1171 00000A27 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1172 00000A2D A2[C1230000]            	mov	[msgCodecId2+3], al
  1173 00000A32 88D3                    	mov	bl, dl
  1174 00000A34 C0EB04                  	shr	bl, 4
  1175 00000A37 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1176 00000A3D A2[C0230000]            	mov	[msgCodecId2+2], al
  1177 00000A42 88F3                    	mov	bl, dh
  1178 00000A44 80E30F                  	and	bl, 0Fh
  1179 00000A47 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1180 00000A4D A2[BF230000]            	mov	[msgCodecId2+1], al
  1181 00000A52 88F3                    	mov	bl, dh
  1182 00000A54 C0EB04                  	shr	bl, 4
  1183 00000A57 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1184 00000A5D A2[BE230000]            	mov	[msgCodecId2], al
  1185 00000A62 C1EA10                  	shr	edx, 16
  1186 00000A65 88D3                    	mov	bl, dl
  1187 00000A67 80E30F                  	and	bl, 0Fh
  1188 00000A6A 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1189 00000A70 A2[AE230000]            	mov	[msgCodecId1+3], al
  1190 00000A75 88D3                    	mov	bl, dl
  1191 00000A77 C0EB04                  	shr	bl, 4
  1192 00000A7A 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1193 00000A80 A2[AD230000]            	mov	[msgCodecId1+2], al
  1194 00000A85 88F3                    	mov	bl, dh
  1195 00000A87 80E30F                  	and	bl, 0Fh
  1196 00000A8A 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1197 00000A90 A2[AC230000]            	mov	[msgCodecId1+1], al
  1198 00000A95 88F3                    	mov	bl, dh
  1199 00000A97 C0EB04                  	shr	bl, 4
  1200 00000A9A 8A83[EE220000]          	mov	al, [ebx+hex_chars]
  1201 00000AA0 A2[AB230000]            	mov	[msgCodecId1], al
  1202                                  	;
  1203                                  	sys	_msg, msgCodec, 255, 07h
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000AA5 BB[95230000]        <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000AAA B9FF000000          <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000AAF BA07000000          <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000AB4 B823000000          <1>  mov eax, %1
    86                              <1> 
    87 00000AB9 CD40                <1>  int 40h
  1204 00000ABB C3                      	retn
  1205                                  
  1206                                  ; 26/11/2023
  1207                                  ; 25/11/2023 - playwav6.s (32 bit registers, TRDOS 386 adaption)
  1208                                  ; 15/11/2023 - PLAYWAV5.COM, ich_wav5.asm
  1209                                  ; 14/11/2023
  1210                                  ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1211                                  ; --------------------------------------------------------
  1212                                  
  1213                                  ;;Note:	At the end of every buffer load,
  1214                                  ;;	during buffer switch/swap, there will be discontinuity
  1215                                  ;;	between the last converted sample and the 1st sample
  1216                                  ;;	of the next buffer.
  1217                                  ;;	(like as a dot noises vaguely between normal sound samples)
  1218                                  ;;	-To avoid this defect, the 1st sample of
  1219                                  ;;	the next buffer may be read from the wav file but
  1220                                  ;;	the file pointer would need to be set to 1 sample back
  1221                                  ;;	again via seek system call. Time comsumption problem! -
  1222                                  ;;
  1223                                  ;;	Erdogan Tan - 15/11/2023
  1224                                  ;;
  1225                                  ;;	((If entire wav data would be loaded at once.. conversion
  1226                                  ;;	defect/noise would disappear.. but for DOS, to keep
  1227                                  ;;	64KB buffer limit is important also it is important
  1228                                  ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1229                                  ;;	I have tested this program by using 2-30MB wav files.))
  1230                                  ;;
  1231                                  ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1232                                  ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1233                                  ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1234                                  ;;			Realtek ALC850 codec.
  1235                                  ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1236                                  
  1237                                  load_8khz_mono_8_bit:
  1238                                  	; 15/11/2023
  1239                                  	; 14/11/2023
  1240                                  	; 13/11/2023
  1241 00000ABC F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1242                                  					; last of the file?
  1243 00000AC3 7402                    	jz	short lff8m_0		; no
  1244 00000AC5 F9                      	stc
  1245 00000AC6 C3                      	retn
  1246                                  
  1247                                  lff8m_0:
  1248 00000AC7 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1249                                          ;mov	edx, [loadsize]
  1250                                  
  1251                                  	; esi = buffer address
  1252                                  	;; edx = buffer size
  1253                                  
  1254                                  	; load file into memory
  1255                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000ACC 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000AD2 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000AD4 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000ADA B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000ADF CD40                <1>  int 40h
  1256 00000AE1 7305                    	jnc	short lff8m_6
  1257 00000AE3 E9AA000000              	jmp	lff8m_5  ; error !
  1258                                  
  1259                                  lff8m_6:
  1260 00000AE8 BF[00300000]            	mov	edi, audio_buffer
  1261 00000AED 21C0                    	and	eax, eax
  1262 00000AEF 0F8494000000            	jz	lff8_eof
  1263                                  
  1264 00000AF5 89C1                    	mov	ecx, eax		; byte count
  1265                                  lff8m_1:
  1266 00000AF7 AC                      	lodsb
  1267 00000AF8 A2[00210000]            	mov	[previous_val], al
  1268 00000AFD 2C80                    	sub	al, 80h
  1269 00000AFF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1270 00000B03 66AB                    	stosw		; original sample (left channel)
  1271 00000B05 66AB                    	stosw		; original sample (right channel)
  1272                                  	;xor	eax, eax
  1273 00000B07 B080                    	mov	al, 80h
  1274 00000B09 49                      	dec	ecx
  1275 00000B0A 7402                    	jz	short lff8m_2
  1276 00000B0C 8A06                    	mov	al, [esi]
  1277                                  lff8m_2:
  1278                                  	;mov	[next_val], ax
  1279 00000B0E 88C7                    	mov	bh, al	; [next_val]
  1280 00000B10 8A25[00210000]          	mov	ah, [previous_val]
  1281 00000B16 00E0                    	add	al, ah	; [previous_val]
  1282 00000B18 D0D8                    	rcr	al, 1
  1283 00000B1A 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample
  1284 00000B1C 00E0                    	add	al, ah	; [previous_val]
  1285 00000B1E D0D8                    	rcr	al, 1	
  1286 00000B20 88C3                    	mov	bl, al 	; this is temporary interpolation value	
  1287 00000B22 00E0                    	add	al, ah	; [previous_val]
  1288 00000B24 D0D8                    	rcr	al, 1
  1289 00000B26 2C80                    	sub	al, 80h
  1290 00000B28 66C1E008                	shl	ax, 8	
  1291 00000B2C 66AB                    	stosw		; this is 1st interpolated sample (L)
  1292 00000B2E 66AB                    	stosw		; this is 1st interpolated sample (R)
  1293 00000B30 88D8                    	mov	al, bl
  1294 00000B32 00D0                    	add	al, dl
  1295 00000B34 D0D8                    	rcr	al, 1
  1296 00000B36 2C80                    	sub	al, 80h
  1297 00000B38 66C1E008                	shl	ax, 8
  1298 00000B3C 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1299 00000B3E 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1300 00000B40 88D0                    	mov	al, dl
  1301 00000B42 2C80                    	sub	al, 80h
  1302 00000B44 66C1E008                	shl	ax, 8
  1303 00000B48 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1304 00000B4A 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1305                                  	;mov	al, [next_val]
  1306 00000B4C 88F8                    	mov	al, bh
  1307 00000B4E 00D0                    	add	al, dl
  1308 00000B50 D0D8                    	rcr	al, 1
  1309 00000B52 88C3                    	mov	bl, al	; this is temporary interpolation value
  1310 00000B54 00D0                    	add	al, dl
  1311 00000B56 D0D8                    	rcr	al, 1
  1312 00000B58 2C80                    	sub	al, 80h
  1313 00000B5A 66C1E008                	shl	ax, 8
  1314 00000B5E 66AB                    	stosw		; this is 4th interpolated sample (L)
  1315 00000B60 66AB                    	stosw		; this is 4th interpolated sample (R)
  1316                                  	;mov	al, [next_val]
  1317 00000B62 88F8                    	mov	al, bh
  1318 00000B64 00D8                    	add	al, bl
  1319 00000B66 D0D8                    	rcr	al, 1
  1320 00000B68 2C80                    	sub	al, 80h
  1321 00000B6A 66C1E008                	shl	ax, 8
  1322 00000B6E 66AB                    	stosw		; this is 5th interpolated sample (L)
  1323 00000B70 66AB                    	stosw		; this is 5th interpolated sample (R)
  1324                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1325 00000B72 09C9                    	or	ecx, ecx
  1326 00000B74 7581                    	jnz	short lff8m_1
  1327                                  
  1328                                  	; --------------
  1329                                  
  1330                                  lff8s_3:
  1331                                  lff8m_3:
  1332                                  lff8s2_3:
  1333                                  lff8m2_3:
  1334                                  lff16s_3:
  1335                                  lff16m_3:
  1336                                  lff16s2_3:
  1337                                  lff16m2_3:
  1338                                  lff24_3:
  1339                                  lff32_3:
  1340                                  lff44_3:
  1341                                  lff22_3:
  1342                                  lff11_3:
  1343                                  	; 01/06/2024 (BugFix)
  1344 00000B76 8B0D[DA030000]          	mov	ecx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1345                                  	;shl	ecx, 1	; byte count ; Bug !
  1346 00000B7C 29F9                    	sub	ecx, edi
  1347 00000B7E 7607                    	jna	short lff8m_4
  1348                                  	;inc	ecx
  1349 00000B80 C1E902                  	shr	ecx, 2
  1350 00000B83 31C0                    	xor	eax, eax ; fill (remain part of) buffer with zeros	
  1351 00000B85 F3AB                    	rep	stosd
  1352                                  lff8m_4:
  1353                                  	; 01/06/2024 (BugFix)
  1354                                  	; cf=1 ; Bug !
  1355 00000B87 F8                      	clc
  1356 00000B88 C3                      	retn
  1357                                  
  1358                                  lff8_eof:
  1359                                  lff16_eof:
  1360                                  lff24_eof:
  1361                                  lff32_eof:
  1362                                  lff44_eof:
  1363                                  lff22_eof:
  1364                                  lff11_eof:
  1365                                  	; 15/11/2023
  1366 00000B89 C605[18240000]01        	mov	byte [flags], ENDOFFILE
  1367 00000B90 EBE4                    	jmp	short lff8m_3
  1368                                  
  1369                                  lff8s_5:
  1370                                  lff8m_5:
  1371                                  lff8s2_5:
  1372                                  lff8m2_5:
  1373                                  lff16s_5:
  1374                                  lff16m_5:
  1375                                  lff16s2_5:
  1376                                  lff16m2_5:
  1377                                  lff24_5:
  1378                                  lff32_5:
  1379                                  lff44_5:
  1380                                  lff22_5:
  1381                                  lff11_5:
  1382 00000B92 B021                    	mov	al, '!'  ; error
  1383 00000B94 E8EEF9FFFF              	call	tL0
  1384                                  	
  1385                                  	;jmp	short lff8m_3
  1386                                  	; 15/11/2023
  1387 00000B99 EBEE                    	jmp	lff8_eof
  1388                                  
  1389                                  	; --------------
  1390                                  
  1391                                  load_8khz_stereo_8_bit:
  1392                                  	; 15/11/2023
  1393                                  	; 14/11/2023
  1394                                  	; 13/11/2023
  1395 00000B9B F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1396                                  					; last of the file?
  1397 00000BA2 7402                    	jz	short lff8s_0		; no
  1398 00000BA4 F9                      	stc
  1399 00000BA5 C3                      	retn
  1400                                  
  1401                                  lff8s_0:
  1402 00000BA6 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1403                                          ;mov	edx, [loadsize]
  1404                                  
  1405                                  	; esi = buffer address
  1406                                  	;; edx = buffer size
  1407                                  
  1408                                  	; load file into memory
  1409                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000BAB 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000BB1 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000BB3 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000BB9 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000BBE CD40                <1>  int 40h
  1410 00000BC0 72D0                    	jc	short lff8s_5 ; error !
  1411                                  
  1412 00000BC2 BF[00300000]            	mov	edi, audio_buffer
  1413                                  	
  1414 00000BC7 D1E8                    	shr	eax, 1
  1415 00000BC9 74BE                    	jz	short lff8_eof
  1416                                  
  1417 00000BCB 89C1                    	mov	ecx, eax	; word count
  1418                                  lff8s_1:
  1419 00000BCD AC                      	lodsb
  1420 00000BCE A2[00210000]            	mov	[previous_val_l], al
  1421 00000BD3 2C80                    	sub	al, 80h
  1422 00000BD5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1423 00000BD9 66AB                    	stosw		; original sample (L)
  1424 00000BDB AC                      	lodsb
  1425 00000BDC A2[02210000]            	mov	[previous_val_r], al
  1426 00000BE1 2C80                    	sub	al, 80h
  1427 00000BE3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1428 00000BE7 66AB                    	stosw		; original sample (R)
  1429                                  
  1430                                  	;xor	eax, eax
  1431 00000BE9 66B88080                	mov	ax, 8080h
  1432 00000BED 49                      	dec	ecx
  1433 00000BEE 7403                    	jz	short lff8s_2
  1434                                  		; convert 8 bit sample to 16 bit sample
  1435 00000BF0 668B06                  	mov	ax, [esi]
  1436                                  lff8s_2:
  1437 00000BF3 A2[04210000]            	mov	[next_val_l], al
  1438 00000BF8 8825[06210000]          	mov	[next_val_r], ah
  1439 00000BFE 8A25[00210000]          	mov	ah, [previous_val_l]
  1440 00000C04 00E0                    	add	al, ah
  1441 00000C06 D0D8                    	rcr	al, 1
  1442 00000C08 88C2                    	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1443 00000C0A 00E0                    	add	al, ah
  1444 00000C0C D0D8                    	rcr	al, 1	
  1445 00000C0E 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1446 00000C10 00E0                    	add	al, ah
  1447 00000C12 D0D8                    	rcr	al, 1
  1448 00000C14 2C80                    	sub	al, 80h
  1449 00000C16 66C1E008                	shl	ax, 8
  1450 00000C1A 66AB                    	stosw		; this is 1st interpolated sample (L)
  1451 00000C1C A0[06210000]            	mov	al, [next_val_r]
  1452 00000C21 8A25[02210000]          	mov	ah, [previous_val_r]
  1453 00000C27 00E0                    	add	al, ah
  1454 00000C29 D0D8                    	rcr	al, 1
  1455 00000C2B 88C6                    	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1456 00000C2D 00E0                    	add	al, ah
  1457 00000C2F D0D8                    	rcr	al, 1
  1458 00000C31 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1459 00000C33 00E0                    	add	al, ah
  1460 00000C35 D0D8                    	rcr	al, 1
  1461 00000C37 2C80                    	sub	al, 80h
  1462 00000C39 66C1E008                	shl	ax, 8
  1463 00000C3D 66AB                    	stosw		; this is 1st interpolated sample (R)
  1464 00000C3F 88D8                    	mov	al, bl
  1465 00000C41 00D0                    	add	al, dl
  1466 00000C43 D0D8                    	rcr	al, 1
  1467 00000C45 2C80                    	sub	al, 80h
  1468 00000C47 66C1E008                	shl	ax, 8
  1469 00000C4B 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1470 00000C4D 88F8                    	mov	al, bh
  1471 00000C4F 00F0                    	add	al, dh
  1472 00000C51 D0D8                    	rcr	al, 1
  1473 00000C53 2C80                    	sub	al, 80h
  1474 00000C55 66C1E008                	shl	ax, 8
  1475 00000C59 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1476 00000C5B 88D0                    	mov	al, dl
  1477 00000C5D 2C80                    	sub	al, 80h
  1478 00000C5F 66C1E008                	shl	ax, 8
  1479 00000C63 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1480 00000C65 88F0                    	mov	al, dh
  1481 00000C67 2C80                    	sub	al, 80h
  1482 00000C69 66C1E008                	shl	ax, 8
  1483 00000C6D 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1484 00000C6F A0[04210000]            	mov	al, [next_val_l]
  1485 00000C74 00D0                    	add	al, dl
  1486 00000C76 D0D8                    	rcr	al, 1
  1487 00000C78 88C3                    	mov	bl, al	; this is temporary interpolation value (L)
  1488 00000C7A 00D0                    	add	al, dl
  1489 00000C7C D0D8                    	rcr	al, 1
  1490 00000C7E 2C80                    	sub	al, 80h
  1491 00000C80 66C1E008                	shl	ax, 8
  1492 00000C84 66AB                    	stosw		; this is 4th interpolated sample (L)
  1493 00000C86 A0[06210000]            	mov	al, [next_val_r]
  1494 00000C8B 00F0                    	add	al, dh
  1495 00000C8D D0D8                    	rcr	al, 1
  1496 00000C8F 88C7                    	mov	bh, al	; this is temporary interpolation value (R)
  1497 00000C91 00F0                    	add	al, dh
  1498 00000C93 D0D8                    	rcr	al, 1
  1499 00000C95 2C80                    	sub	al, 80h
  1500 00000C97 66C1E008                	shl	ax, 8
  1501 00000C9B 66AB                    	stosw		; this is 4th interpolated sample (R)
  1502 00000C9D A0[04210000]            	mov	al, [next_val_l]
  1503 00000CA2 00D8                    	add	al, bl
  1504 00000CA4 D0D8                    	rcr	al, 1
  1505 00000CA6 2C80                    	sub	al, 80h
  1506 00000CA8 66C1E008                	shl	ax, 8
  1507 00000CAC 66AB                    	stosw		; this is 5th interpolated sample (L)
  1508 00000CAE A0[06210000]            	mov	al, [next_val_r]
  1509 00000CB3 00F8                    	add	al, bh
  1510 00000CB5 D0D8                    	rcr	al, 1
  1511 00000CB7 2C80                    	sub	al, 80h
  1512 00000CB9 66C1E008                	shl	ax, 8
  1513 00000CBD 66AB                    	stosw		; this is 5th interpolated sample (R)
  1514                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1515 00000CBF E305                    	jecxz	lff8s_6
  1516 00000CC1 E907FFFFFF              	jmp	lff8s_1
  1517                                  lff8s_6:
  1518 00000CC6 E9ABFEFFFF              	jmp	lff8s_3
  1519                                  
  1520                                  load_8khz_mono_16_bit:
  1521                                  	; 13/11/2023
  1522 00000CCB F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1523                                  					; last of the file?
  1524 00000CD2 7402                    	jz	short lff8m2_0		; no
  1525 00000CD4 F9                      	stc
  1526 00000CD5 C3                      	retn
  1527                                  
  1528                                  lff8m2_0:
  1529 00000CD6 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1530                                          ;mov	edx, [loadsize]
  1531                                  
  1532                                  	; esi = buffer address
  1533                                  	;; edx = buffer size
  1534                                  
  1535                                  	; load file into memory
  1536                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000CDB 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000CE1 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000CE3 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000CE9 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000CEE CD40                <1>  int 40h
  1537 00000CF0 0F82A0000000            	jc	lff8m2_7 ; error !
  1538                                  
  1539 00000CF6 BF[00300000]            	mov	edi, audio_buffer
  1540                                  	
  1541 00000CFB D1E8                    	shr	eax, 1
  1542 00000CFD 7505                    	jnz	short lff8m2_8
  1543 00000CFF E985FEFFFF              	jmp	lff8_eof
  1544                                  
  1545                                  lff8m2_8:
  1546 00000D04 89C1                    	mov	ecx, eax	; word count
  1547                                  lff8m2_1:
  1548 00000D06 66AD                    	lodsw
  1549 00000D08 66AB                    	stosw		; original sample (left channel)
  1550 00000D0A 66AB                    	stosw		; original sample (right channel)
  1551 00000D0C 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1552 00000D0F 66A3[00210000]          	mov	[previous_val], ax
  1553 00000D15 31C0                    	xor	eax, eax
  1554 00000D17 49                      	dec	ecx
  1555 00000D18 7403                    	jz	short lff8m2_2
  1556 00000D1A 668B06                  	mov	ax, [esi]
  1557                                  lff8m2_2:
  1558 00000D1D 80C480                  	add	ah, 80h ; convert sound level to 0-65535 format
  1559 00000D20 89C5                    	mov	ebp, eax	; [next_val]
  1560 00000D22 660305[00210000]        	add	ax, [previous_val]
  1561 00000D29 66D1D8                  	rcr	ax, 1
  1562 00000D2C 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample
  1563 00000D2E 660305[00210000]        	add	ax, [previous_val]
  1564 00000D35 66D1D8                  	rcr	ax, 1	; this is temporary interpolation value
  1565 00000D38 89C3                    	mov	ebx, eax 		
  1566 00000D3A 660305[00210000]        	add	ax, [previous_val]
  1567 00000D41 66D1D8                  	rcr	ax, 1
  1568 00000D44 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1569 00000D47 66AB                    	stosw		; this is 1st interpolated sample (L)
  1570 00000D49 66AB                    	stosw		; this is 1st interpolated sample (R)
  1571 00000D4B 89D8                    	mov	eax, ebx
  1572 00000D4D 6601D0                  	add	ax, dx
  1573 00000D50 66D1D8                  	rcr	ax, 1
  1574 00000D53 80EC80                  	sub	ah, 80h
  1575 00000D56 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1576 00000D58 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1577 00000D5A 89D0                    	mov	eax, edx
  1578 00000D5C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1579 00000D5F 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1580 00000D61 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1581 00000D63 89E8                    	mov	eax, ebp
  1582 00000D65 6601D0                  	add	ax, dx
  1583 00000D68 66D1D8                  	rcr	ax, 1
  1584 00000D6B 89C3                    	mov	ebx, eax ; this is temporary interpolation value
  1585 00000D6D 6601D0                  	add	ax, dx
  1586 00000D70 66D1D8                  	rcr	ax, 1
  1587 00000D73 80EC80                  	sub	ah, 80h
  1588 00000D76 66AB                    	stosw		; this is 4th interpolated sample (L)
  1589 00000D78 66AB                    	stosw		; this is 4th interpolated sample (R)
  1590 00000D7A 89E8                    	mov	eax, ebp
  1591 00000D7C 6601D8                  	add	ax, bx
  1592 00000D7F 66D1D8                  	rcr	ax, 1
  1593 00000D82 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1594 00000D85 66AB                    	stosw		; this is 5th interpolated sample (L)
  1595 00000D87 66AB                    	stosw		; this is 5th interpolated sample (R)
  1596                                  	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1597 00000D89 09C9                    	or	ecx, ecx
  1598 00000D8B 0F8575FFFFFF            	jnz	lff8m2_1
  1599 00000D91 E9E0FDFFFF              	jmp	lff8m2_3
  1600                                  
  1601                                  lff8m2_7:
  1602                                  lff8s2_7:
  1603 00000D96 E9F7FDFFFF              	jmp	lff8m2_5  ; error
  1604                                  
  1605                                  load_8khz_stereo_16_bit:
  1606                                  	; 16/11/2023
  1607                                  	; 15/11/2023
  1608                                  	; 13/11/2023
  1609 00000D9B F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1610                                  					; last of the file?
  1611 00000DA2 7402                    	jz	short lff8s2_0		; no
  1612 00000DA4 F9                      	stc
  1613 00000DA5 C3                      	retn
  1614                                  
  1615                                  lff8s2_0:
  1616 00000DA6 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1617                                          ;mov	edx, [loadsize]
  1618                                  
  1619                                  	; esi = buffer address
  1620                                  	;; edx = buffer size
  1621                                  
  1622                                  	; load file into memory
  1623                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000DAB 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000DB1 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000DB3 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000DB9 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000DBE CD40                <1>  int 40h
  1624 00000DC0 72D4                    	jc	short lff8s2_7 ; error !
  1625                                  
  1626 00000DC2 BF[00300000]            	mov	edi, audio_buffer
  1627                                  	
  1628 00000DC7 C1E802                  	shr	eax, 2
  1629 00000DCA 7505                    	jnz	short lff8s2_8
  1630 00000DCC E9B8FDFFFF              	jmp	lff8_eof
  1631                                  
  1632                                  lff8s2_8:
  1633 00000DD1 89C1                    	mov	ecx, eax ; dword count
  1634                                  lff8s2_1:
  1635 00000DD3 66AD                    	lodsw
  1636 00000DD5 66AB                    	stosw		; original sample (L)
  1637                                  	; 15/11/2023
  1638 00000DD7 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1639 00000DDA 66A3[00210000]          	mov	[previous_val_l], ax
  1640 00000DE0 66AD                    	lodsw
  1641 00000DE2 66AB                    	stosw		; original sample (R)
  1642 00000DE4 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1643 00000DE7 66A3[02210000]          	mov	[previous_val_r], ax
  1644 00000DED 31D2                    	xor	edx, edx
  1645 00000DEF 31C0                    	xor	eax, eax
  1646                                  	; 16/11/2023
  1647 00000DF1 49                      	dec	ecx
  1648 00000DF2 7407                    	jz	short lff8s2_2
  1649 00000DF4 668B06                  	mov	ax, [esi]
  1650 00000DF7 668B5602                	mov	dx, [esi+2]
  1651                                  lff8s2_2:
  1652 00000DFB 80C480                  	add	ah, 80h	; convert sound level to 0-65535 format
  1653 00000DFE 66A3[04210000]          	mov	[next_val_l], ax
  1654 00000E04 80C680                  	add	dh, 80h	; convert sound level to 0-65535 format
  1655 00000E07 668915[06210000]        	mov	[next_val_r], dx
  1656 00000E0E 660305[00210000]        	add	ax, [previous_val_l]
  1657 00000E15 66D1D8                  	rcr	ax, 1
  1658 00000E18 89C2                    	mov	edx, eax ; this is interpolated middle (3th) sample (L)
  1659 00000E1A 660305[00210000]        	add	ax, [previous_val_l]
  1660 00000E21 66D1D8                  	rcr	ax, 1	
  1661 00000E24 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1662 00000E26 660305[00210000]        	add	ax, [previous_val_l]
  1663 00000E2D 66D1D8                  	rcr	ax, 1
  1664 00000E30 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1665 00000E33 66AB                    	stosw		; this is 1st interpolated sample (L)
  1666 00000E35 66A1[06210000]          	mov	ax, [next_val_r]
  1667 00000E3B 660305[02210000]        	add	ax, [previous_val_r]
  1668 00000E42 66D1D8                  	rcr	ax, 1
  1669 00000E45 89C5                    	mov	ebp, eax ; this is interpolated middle (3th) sample (R)
  1670 00000E47 660305[02210000]        	add	ax, [previous_val_r]
  1671 00000E4E 66D1D8                  	rcr	ax, 1
  1672 00000E51 50                      	push	eax ; *	; this is temporary interpolation value (R)
  1673 00000E52 660305[02210000]        	add	ax, [previous_val_r]
  1674 00000E59 66D1D8                  	rcr	ax, 1
  1675 00000E5C 80EC80                  	sub	ah, 80h
  1676 00000E5F 66AB                    	stosw		; this is 1st interpolated sample (R)
  1677 00000E61 89D8                    	mov	eax, ebx
  1678 00000E63 6601D0                  	add	ax, dx
  1679 00000E66 66D1D8                  	rcr	ax, 1
  1680 00000E69 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1681 00000E6C 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1682 00000E6E 58                      	pop	eax ; *
  1683 00000E6F 6601E8                  	add	ax, bp
  1684 00000E72 66D1D8                  	rcr	ax, 1
  1685 00000E75 80EC80                  	sub	ah, 80h
  1686 00000E78 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1687 00000E7A 89D0                    	mov	eax, edx
  1688 00000E7C 80EC80                  	sub	ah, 80h
  1689 00000E7F 66AB                    	stosw		; this is middle (3th) interpolated sample (L)
  1690 00000E81 89E8                    	mov	eax, ebp
  1691 00000E83 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1692 00000E86 66AB                    	stosw		; this is middle (3th) interpolated sample (R)
  1693 00000E88 66A1[04210000]          	mov	ax, [next_val_l]
  1694 00000E8E 6601D0                  	add	ax, dx
  1695 00000E91 66D1D8                  	rcr	ax, 1
  1696 00000E94 89C3                    	mov	ebx, eax ; this is temporary interpolation value (L)
  1697 00000E96 6601D0                  	add	ax, dx
  1698 00000E99 66D1D8                  	rcr	ax, 1
  1699 00000E9C 80EC80                  	sub	ah, 80h
  1700 00000E9F 66AB                    	stosw		; this is 4th interpolated sample (L)
  1701 00000EA1 66A1[06210000]          	mov	ax, [next_val_r]
  1702 00000EA7 6601E8                  	add	ax, bp
  1703 00000EAA 66D1D8                  	rcr	ax, 1
  1704 00000EAD 50                      	push	eax ; ** ; this is temporary interpolation value (R)
  1705 00000EAE 6601E8                  	add	ax, bp
  1706 00000EB1 66D1D8                  	rcr	ax, 1
  1707 00000EB4 80EC80                  	sub	ah, 80h
  1708 00000EB7 66AB                    	stosw		; this is 4th interpolated sample (R)
  1709 00000EB9 66A1[04210000]          	mov	ax, [next_val_l]
  1710 00000EBF 6601D8                  	add	ax, bx
  1711 00000EC2 66D1D8                  	rcr	ax, 1
  1712 00000EC5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1713 00000EC8 66AB                    	stosw		; this is 5th interpolated sample (L)
  1714 00000ECA 58                      	pop	eax ; **
  1715 00000ECB 660305[06210000]        	add	ax, [next_val_r]
  1716 00000ED2 66D1D8                  	rcr	ax, 1
  1717 00000ED5 80EC80                  	sub	ah, 80h
  1718 00000ED8 66AB                    	stosw		; this is 5th interpolated sample (R)
  1719                                  	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1720 00000EDA E305                    	jecxz	lff8_s2_9
  1721 00000EDC E9F2FEFFFF              	jmp	lff8s2_1
  1722                                  lff8_s2_9:
  1723 00000EE1 E990FCFFFF              	jmp	lff8s2_3
  1724                                  
  1725                                  ; .....................
  1726                                  
  1727                                  load_16khz_mono_8_bit:
  1728                                  	; 14/11/2023
  1729                                  	; 13/11/2023
  1730 00000EE6 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1731                                  					; last of the file?
  1732 00000EED 7402                    	jz	short lff16m_0		; no
  1733 00000EEF F9                      	stc
  1734 00000EF0 C3                      	retn
  1735                                  
  1736                                  lff16m_0:
  1737 00000EF1 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1738                                          ;mov	edx, [loadsize]
  1739                                  
  1740                                  	; esi = buffer address
  1741                                  	;; edx = buffer size
  1742                                  
  1743                                  	; load file into memory
  1744                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000EF6 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000EFC 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000EFE 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000F04 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000F09 CD40                <1>  int 40h
  1745 00000F0B 7253                    	jc	short lff16m_7 ; error !
  1746                                  
  1747 00000F0D BF[00300000]            	mov	edi, audio_buffer
  1748                                  	
  1749 00000F12 21C0                    	and	eax, eax
  1750 00000F14 7505                    	jnz	short lff16m_8
  1751 00000F16 E96EFCFFFF              	jmp	lff16_eof
  1752                                  
  1753                                  lff16m_8:
  1754 00000F1B 89C1                    	mov	ecx, eax		; byte count
  1755                                  lff16m_1:
  1756 00000F1D AC                      	lodsb
  1757                                  	;mov	[previous_val], al
  1758 00000F1E 88C3                    	mov	bl, al
  1759 00000F20 2C80                    	sub	al, 80h
  1760 00000F22 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1761 00000F26 66AB                    	stosw		; original sample (left channel)
  1762 00000F28 66AB                    	stosw		; original sample (right channel)
  1763                                  	;xor	ax, ax
  1764                                  	; 14/11/22023
  1765 00000F2A B080                    	mov	al, 80h
  1766 00000F2C 49                      	dec	ecx
  1767 00000F2D 7402                    	jz	short lff16m_2
  1768 00000F2F 8A06                    	mov	al, [esi]
  1769                                  lff16m_2:
  1770                                  	;mov	[next_val], al
  1771 00000F31 88C7                    	mov	bh, al
  1772                                  	;add	al, [previous_val]
  1773 00000F33 00D8                    	add	al, bl
  1774 00000F35 D0D8                    	rcr	al, 1
  1775 00000F37 88C2                    	mov	dl, al	; this is interpolated middle (temp) sample
  1776                                  	;add	al, [previous_val]
  1777 00000F39 00D8                    	add	al, bl
  1778 00000F3B D0D8                    	rcr	al, 1
  1779 00000F3D 2C80                    	sub	al, 80h
  1780 00000F3F 66C1E008                	shl	ax, 8
  1781 00000F43 66AB                    	stosw		; this is 1st interpolated sample (L)
  1782 00000F45 66AB                    	stosw		; this is 1st interpolated sample (R)
  1783                                  	;mov	al, [next_val]
  1784 00000F47 88F8                    	mov	al, bh
  1785 00000F49 00D0                    	add	al, dl
  1786 00000F4B D0D8                    	rcr	al, 1
  1787 00000F4D 2C80                    	sub	al, 80h
  1788 00000F4F 66C1E008                	shl	ax, 8
  1789 00000F53 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1790 00000F55 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1791                                  	
  1792                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1793 00000F57 09C9                    	or	ecx, ecx
  1794 00000F59 75C2                    	jnz	short lff16m_1
  1795 00000F5B E916FCFFFF              	jmp	lff16m_3
  1796                                  
  1797                                  lff16m_7:
  1798                                  lff16s_7:
  1799 00000F60 E92DFCFFFF              	jmp	lff16m_5  ; error
  1800                                  
  1801                                  load_16khz_stereo_8_bit:
  1802                                  	; 14/11/2023
  1803                                  	; 13/11/2023
  1804 00000F65 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1805                                  					; last of the file?
  1806 00000F6C 7402                    	jz	short lff16s_0		; no
  1807 00000F6E F9                      	stc
  1808 00000F6F C3                      	retn
  1809                                  
  1810                                  lff16s_0:
  1811 00000F70 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1812                                          ;mov	edx, [loadsize]
  1813                                  
  1814                                  	; esi = buffer address
  1815                                  	;; edx = buffer size
  1816                                  
  1817                                  	; load file into memory
  1818                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00000F75 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00000F7B 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00000F7D 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00000F83 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00000F88 CD40                <1>  int 40h
  1819 00000F8A 72D4                    	jc	short lff16s_7 ; error !
  1820                                  
  1821 00000F8C BF[00300000]            	mov	edi, audio_buffer
  1822                                  	
  1823 00000F91 D1E8                    	shr	eax, 1
  1824 00000F93 7505                    	jnz	short lff16s_8
  1825 00000F95 E9EFFBFFFF              	jmp	lff16_eof
  1826                                  
  1827                                  lff16s_8:
  1828 00000F9A 89C1                    	mov	ecx, eax	; word count
  1829                                  lff16s_1:
  1830 00000F9C AC                      	lodsb
  1831 00000F9D A2[00210000]            	mov	[previous_val_l], al
  1832 00000FA2 2C80                    	sub	al, 80h
  1833 00000FA4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1834 00000FA8 66AB                    	stosw		; original sample (L)
  1835 00000FAA AC                      	lodsb
  1836 00000FAB A2[02210000]            	mov	[previous_val_r], al
  1837 00000FB0 2C80                    	sub	al, 80h
  1838 00000FB2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1839 00000FB6 66AB                    	stosw		; original sample (R)
  1840                                  
  1841                                  	;xor	eax, eax
  1842 00000FB8 66B88080                	mov	ax, 8080h
  1843 00000FBC 49                      	dec	ecx
  1844 00000FBD 7403                    	jz	short lff16s_2
  1845                                  		; convert 8 bit sample to 16 bit sample
  1846 00000FBF 668B06                  	mov	ax, [esi]
  1847                                  lff16s_2:
  1848                                  	;mov	[next_val_l], al
  1849                                  	;mov	[next_val_r], ah
  1850 00000FC2 89C3                    	mov	ebx, eax
  1851 00000FC4 0205[00210000]          	add	al, [previous_val_l]
  1852 00000FCA D0D8                    	rcr	al, 1
  1853 00000FCC 88C2                    	mov	dl, al	; this is temporary interpolation value (L)
  1854 00000FCE 0205[00210000]          	add	al, [previous_val_l]
  1855 00000FD4 D0D8                    	rcr	al, 1
  1856 00000FD6 2C80                    	sub	al, 80h
  1857 00000FD8 66C1E008                	shl	ax, 8
  1858 00000FDC 66AB                    	stosw		; this is 1st interpolated sample (L)
  1859 00000FDE 88F8                    	mov	al, bh	; [next_val_r]
  1860 00000FE0 0205[02210000]          	add	al, [previous_val_r]
  1861 00000FE6 D0D8                    	rcr	al, 1
  1862 00000FE8 88C6                    	mov	dh, al	; this is temporary interpolation value (R)
  1863 00000FEA 0205[02210000]          	add	al, [previous_val_r]
  1864 00000FF0 D0D8                    	rcr	al, 1
  1865 00000FF2 2C80                    	sub	al, 80h
  1866 00000FF4 66C1E008                	shl	ax, 8
  1867 00000FF8 66AB                    	stosw		; this is 1st interpolated sample (R)
  1868 00000FFA 88D0                    	mov	al, dl
  1869 00000FFC 00D8                    	add	al, bl	; [next_val_l]
  1870 00000FFE D0D8                    	rcr	al, 1
  1871 00001000 2C80                    	sub	al, 80h
  1872 00001002 66C1E008                	shl	ax, 8
  1873 00001006 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1874 00001008 88F0                    	mov	al, dh
  1875 0000100A 00F8                    	add	al, bh	; [next_val_r]
  1876 0000100C D0D8                    	rcr	al, 1
  1877 0000100E 2C80                    	sub	al, 80h
  1878 00001010 66C1E008                	shl	ax, 8
  1879 00001014 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  1880                                  	
  1881                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1882 00001016 09C9                    	or	ecx, ecx
  1883 00001018 7582                    	jnz	short lff16s_1
  1884 0000101A E957FBFFFF              	jmp	lff16s_3
  1885                                  
  1886                                  load_16khz_mono_16_bit:
  1887                                  	; 15/11/2023
  1888                                  	; 13/11/2023
  1889 0000101F F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1890                                  					; last of the file?
  1891 00001026 7402                    	jz	short lff16m2_0		; no
  1892 00001028 F9                      	stc
  1893 00001029 C3                      	retn
  1894                                  
  1895                                  lff16m2_0:
  1896 0000102A BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1897                                          ;mov	edx, [loadsize]
  1898                                  
  1899                                  	; esi = buffer address
  1900                                  	;; edx = buffer size
  1901                                  
  1902                                  	; load file into memory
  1903                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000102F 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001035 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001037 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000103D B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001042 CD40                <1>  int 40h
  1904 00001044 7255                    	jc	short lff16m2_7 ; error !
  1905                                  
  1906 00001046 BF[00300000]            	mov	edi, audio_buffer
  1907                                  	
  1908 0000104B D1E8                    	shr	eax, 1
  1909 0000104D 7505                    	jnz	short lff16m2_8
  1910 0000104F E935FBFFFF              	jmp	lff16_eof
  1911                                  
  1912                                  lff16m2_8:
  1913 00001054 89C1                    	mov	ecx, eax  ; word count
  1914                                  lff16m2_1:
  1915 00001056 66AD                    	lodsw
  1916 00001058 66AB                    	stosw		; original sample (left channel)
  1917 0000105A 66AB                    	stosw		; original sample (right channel)
  1918 0000105C 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  1919                                  	;mov	[previous_val], ax
  1920 0000105F 89C3                    	mov	ebx, eax	
  1921 00001061 31C0                    	xor	eax, eax
  1922 00001063 49                      	dec	ecx
  1923 00001064 7403                    	jz	short lff16m2_2
  1924 00001066 668B06                  	mov	ax, [esi]
  1925                                  lff16m2_2:
  1926 00001069 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  1927 0000106C 89C5                    	mov	ebp, eax	; [next_val]
  1928                                  	;add	ax, [previous_val]
  1929 0000106E 6601D8                  	add	ax, bx
  1930 00001071 66D1D8                  	rcr	ax, 1
  1931 00001074 89C2                    	mov	edx, eax ; this is temporary interpolation value
  1932                                  	;add	ax, [previous_val]
  1933 00001076 6601D8                  	add	ax, bx
  1934 00001079 66D1D8                  	rcr	ax, 1
  1935 0000107C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1936 0000107F 66AB                    	stosw		; this is 1st interpolated sample (L)
  1937 00001081 66AB                    	stosw		; this is 1st interpolated sample (R)
  1938 00001083 89E8                    	mov	eax, ebp 
  1939 00001085 6601D0                  	add	ax, dx
  1940 00001088 66D1D8                  	rcr	ax, 1
  1941 0000108B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  1942 0000108E 66AB                    	stosw		; this is 2nd interpolated sample (L)
  1943 00001090 66AB                    	stosw		; this is 2nd interpolated sample (R)
  1944                                  	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1945 00001092 09C9                    	or	ecx, ecx
  1946 00001094 75C0                    	jnz	short lff16m2_1
  1947 00001096 E9DBFAFFFF              	jmp	lff16m2_3
  1948                                  
  1949                                  lff16m2_7:
  1950                                  lff16s2_7:
  1951 0000109B E9F2FAFFFF              	jmp	lff16m2_5  ; error
  1952                                  
  1953                                  load_16khz_stereo_16_bit:
  1954                                  	; 16/11/2023
  1955                                  	; 15/11/2023
  1956                                  	; 13/11/2023
  1957 000010A0 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  1958                                  					; last of the file?
  1959 000010A7 7402                    	jz	short lff16s2_0		; no
  1960 000010A9 F9                      	stc
  1961 000010AA C3                      	retn
  1962                                  
  1963                                  lff16s2_0:
  1964 000010AB BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  1965                                          ;mov	edx, [loadsize]
  1966                                  
  1967                                  	; esi = buffer address
  1968                                  	;; edx = buffer size
  1969                                  
  1970                                  	; load file into memory
  1971                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000010B0 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000010B6 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000010B8 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000010BE B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000010C3 CD40                <1>  int 40h
  1972 000010C5 72D4                    	jc	short lff16s2_7 ; error !
  1973                                  
  1974 000010C7 BF[00300000]            	mov	edi, audio_buffer
  1975                                  	
  1976 000010CC C1E802                  	shr	eax, 2
  1977 000010CF 7505                    	jnz	short lff16s2_8
  1978 000010D1 E9B3FAFFFF              	jmp	lff16_eof
  1979                                  
  1980                                  lff16s2_8:
  1981 000010D6 89C1                    	mov	ecx, eax  ; dword count
  1982                                  lff16s2_1:
  1983 000010D8 66AD                    	lodsw
  1984 000010DA 66AB                    	stosw		; original sample (L)
  1985 000010DC 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  1986 000010DF 66A3[00210000]          	mov	[previous_val_l], ax
  1987 000010E5 66AD                    	lodsw
  1988 000010E7 66AB                    	stosw		; original sample (R)
  1989 000010E9 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  1990 000010EC 66A3[02210000]          	mov	[previous_val_r], ax
  1991 000010F2 31D2                    	xor	edx, edx
  1992 000010F4 31C0                    	xor	eax, eax
  1993                                  	; 16/11/2023
  1994 000010F6 49                      	dec	ecx
  1995 000010F7 7407                    	jz	short lff16s2_2
  1996 000010F9 668B06                  	mov	ax, [esi]
  1997 000010FC 668B5602                	mov	dx, [esi+2]
  1998                                  lff16s2_2:
  1999 00001100 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2000                                  	;mov	[next_val_l], ax
  2001 00001103 89C5                    	mov	ebp, eax
  2002 00001105 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2003 00001108 668915[06210000]        	mov	[next_val_r], dx
  2004 0000110F 660305[00210000]        	add	ax, [previous_val_l]
  2005 00001116 66D1D8                  	rcr	ax, 1
  2006 00001119 89C2                    	mov	edx, eax ; this is temporary interpolation value (L)
  2007 0000111B 660305[00210000]        	add	ax, [previous_val_l]
  2008 00001122 66D1D8                  	rcr	ax, 1
  2009 00001125 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2010 00001128 66AB                    	stosw		; this is 1st interpolated sample (L)
  2011 0000112A 66A1[06210000]          	mov	ax, [next_val_r]
  2012 00001130 660305[02210000]        	add	ax, [previous_val_r]
  2013 00001137 66D1D8                  	rcr	ax, 1
  2014 0000113A 89C3                    	mov	ebx, eax ; this is temporary interpolation value (R)
  2015 0000113C 660305[02210000]        	add	ax, [previous_val_r]
  2016 00001143 66D1D8                  	rcr	ax, 1
  2017 00001146 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2018 00001149 66AB                    	stosw		; this is 1st interpolated sample (R)
  2019                                  	;mov	ax, [next_val_l]
  2020 0000114B 89E8                    	mov	eax, ebp
  2021 0000114D 6601D0                  	add	ax, dx
  2022 00001150 66D1D8                  	rcr	ax, 1
  2023 00001153 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2024 00001156 66AB                    	stosw		; this is 2nd interpolated sample (L)
  2025 00001158 66A1[06210000]          	mov	ax, [next_val_r]
  2026 0000115E 6601D8                  	add	ax, bx
  2027 00001161 66D1D8                  	rcr	ax, 1
  2028 00001164 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2029 00001167 66AB                    	stosw 		; this is 2nd interpolated sample (R)
  2030                                  	
  2031                                  	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2032 00001169 09C9                    	or	ecx, ecx
  2033 0000116B 0F8567FFFFFF            	jnz	lff16s2_1
  2034 00001171 E900FAFFFF              	jmp	lff16s2_3
  2035                                  
  2036                                  ; .....................
  2037                                  
  2038                                  load_24khz_mono_8_bit:
  2039                                  	; 15/11/2023
  2040 00001176 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2041                                  					; last of the file?
  2042 0000117D 7402                    	jz	short lff24m_0		; no
  2043 0000117F F9                      	stc
  2044 00001180 C3                      	retn
  2045                                  
  2046                                  lff24m_0:
  2047 00001181 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2048                                          ;mov	edx, [loadsize]
  2049                                  
  2050                                  	; esi = buffer address
  2051                                  	;; edx = buffer size
  2052                                  
  2053                                  	; load file into memory
  2054                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001186 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000118C 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000118E 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001194 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001199 CD40                <1>  int 40h
  2055 0000119B 723B                    	jc	short lff24m_7 ; error !
  2056                                  
  2057 0000119D BF[00300000]            	mov	edi, audio_buffer
  2058                                  	
  2059 000011A2 21C0                    	and	eax, eax
  2060 000011A4 7505                    	jnz	short lff24m_8
  2061 000011A6 E9DEF9FFFF              	jmp	lff24_eof
  2062                                  
  2063                                  lff24m_8:
  2064 000011AB 89C1                    	mov	ecx, eax	; byte count
  2065                                  lff24m_1:
  2066 000011AD AC                      	lodsb
  2067                                  	;mov	[previous_val], al
  2068 000011AE 88C3                    	mov	bl, al
  2069 000011B0 2C80                    	sub	al, 80h
  2070 000011B2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2071 000011B6 66AB                    	stosw		; original sample (left channel)
  2072 000011B8 66AB                    	stosw		; original sample (right channel)
  2073                                  	;xor	eax, eax
  2074 000011BA B080                    	mov	al, 80h
  2075 000011BC 49                      	dec	ecx
  2076 000011BD 7402                    	jz	short lff24m_2
  2077 000011BF 8A06                    	mov	al, [esi]
  2078                                  lff24m_2:
  2079                                  	;;mov	[next_val], al
  2080                                  	;mov	bh, al
  2081                                  	;add	al, [previous_val]
  2082 000011C1 00D8                    	add	al, bl
  2083 000011C3 D0D8                    	rcr	al, 1
  2084 000011C5 2C80                    	sub	al, 80h
  2085 000011C7 66C1E008                	shl	ax, 8
  2086 000011CB 66AB                    	stosw		; this is interpolated sample (L)
  2087 000011CD 66AB                    	stosw		; this is interpolated sample (R)
  2088                                  	
  2089                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2090 000011CF 09C9                    	or	ecx, ecx
  2091 000011D1 75DA                    	jnz	short lff24m_1
  2092 000011D3 E99EF9FFFF              	jmp	lff24_3
  2093                                  
  2094                                  lff24m_7:
  2095                                  lff24s_7:
  2096 000011D8 E9B5F9FFFF              	jmp	lff24_5  ; error
  2097                                  
  2098                                  load_24khz_stereo_8_bit:
  2099                                  	; 15/11/2023
  2100 000011DD F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2101                                  					; last of the file?
  2102 000011E4 7402                    	jz	short lff24s_0		; no
  2103 000011E6 F9                      	stc
  2104 000011E7 C3                      	retn
  2105                                  
  2106                                  lff24s_0:
  2107 000011E8 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2108                                          ;mov	edx, [loadsize]
  2109                                  
  2110                                  	; esi = buffer address
  2111                                  	;; edx = buffer size
  2112                                  
  2113                                  	; load file into memory
  2114                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000011ED 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000011F3 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000011F5 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000011FB B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001200 CD40                <1>  int 40h
  2115 00001202 72D4                    	jc	short lff24s_7 ; error !
  2116                                  
  2117 00001204 BF[00300000]            	mov	edi, audio_buffer
  2118                                  	
  2119 00001209 D1E8                    	shr	eax, 1
  2120 0000120B 7505                    	jnz	short lff24s_8
  2121 0000120D E977F9FFFF              	jmp	lff24_eof
  2122                                  
  2123                                  lff24s_8:
  2124 00001212 89C1                    	mov	ecx, eax  ; word count
  2125                                  lff24s_1:
  2126 00001214 AC                      	lodsb
  2127 00001215 A2[00210000]            	mov	[previous_val_l], al
  2128 0000121A 2C80                    	sub	al, 80h
  2129 0000121C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2130 00001220 66AB                    	stosw		; original sample (L)
  2131 00001222 AC                      	lodsb
  2132 00001223 A2[02210000]            	mov	[previous_val_r], al
  2133 00001228 2C80                    	sub	al, 80h
  2134 0000122A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2135 0000122E 66AB                    	stosw		; original sample (R)
  2136                                  
  2137                                  	;xor	eax, eax
  2138 00001230 66B88080                	mov	ax, 8080h
  2139 00001234 49                      	dec	ecx
  2140 00001235 7403                    	jz	short lff24s_2
  2141                                  		; convert 8 bit sample to 16 bit sample
  2142 00001237 668B06                  	mov	ax, [esi]
  2143                                  lff24s_2:
  2144                                  	;;mov	[next_val_l], al
  2145                                  	;;mov	[next_val_r], ah
  2146                                  	;mov	bx, ax
  2147 0000123A 88E7                    	mov	bh, ah
  2148 0000123C 0205[00210000]          	add	al, [previous_val_l]
  2149 00001242 D0D8                    	rcr	al, 1
  2150                                  	;mov	dl, al
  2151 00001244 2C80                    	sub	al, 80h
  2152 00001246 66C1E008                	shl	ax, 8
  2153 0000124A 66AB                    	stosw		; this is interpolated sample (L)
  2154 0000124C 88F8                    	mov	al, bh	; [next_val_r]
  2155 0000124E 0205[02210000]          	add	al, [previous_val_r]
  2156 00001254 D0D8                    	rcr	al, 1
  2157                                  	;mov	dh, al
  2158 00001256 2C80                    	sub	al, 80h
  2159 00001258 66C1E008                	shl	ax, 8
  2160 0000125C 66AB                    	stosw		; this is interpolated sample (R)
  2161                                  		
  2162                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2163 0000125E 09C9                    	or	ecx, ecx
  2164 00001260 75B2                    	jnz	short lff24s_1
  2165 00001262 E90FF9FFFF              	jmp	lff24_3
  2166                                  
  2167                                  load_24khz_mono_16_bit:
  2168                                  	; 15/11/2023
  2169 00001267 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2170                                  					; last of the file?
  2171 0000126E 7402                    	jz	short lff24m2_0		; no
  2172 00001270 F9                      	stc
  2173 00001271 C3                      	retn
  2174                                  
  2175                                  lff24m2_0:
  2176 00001272 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2177                                          ;mov	edx, [loadsize]
  2178                                  
  2179                                  	; esi = buffer address
  2180                                  	;; edx = buffer size
  2181                                  
  2182                                  	; load file into memory
  2183                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001277 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000127D 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000127F 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001285 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000128A CD40                <1>  int 40h
  2184 0000128C 7237                    	jc	short lff24m2_7 ; error !
  2185                                  
  2186 0000128E BF[00300000]            	mov	edi, audio_buffer
  2187                                  	
  2188 00001293 D1E8                    	shr	eax, 1
  2189 00001295 7505                    	jnz	short lff24m2_8
  2190 00001297 E9EDF8FFFF              	jmp	lff24_eof
  2191                                  
  2192                                  lff24m2_8:
  2193 0000129C 89C1                    	mov	ecx, eax  ; word count
  2194                                  lff24m2_1:
  2195 0000129E 66AD                    	lodsw
  2196 000012A0 66AB                    	stosw		; original sample (left channel)
  2197 000012A2 66AB                    	stosw		; original sample (right channel)
  2198 000012A4 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2199                                  	;mov	[previous_val], ax
  2200                                  	;mov	ebx, eax	
  2201                                  	;xor	eax, eax
  2202 000012A7 31DB                    	xor	ebx, ebx
  2203 000012A9 49                      	dec	ecx
  2204 000012AA 7403                    	jz	short lff24m2_2
  2205                                  	;mov	ax, [esi]
  2206 000012AC 668B1E                  	mov	bx, [esi]
  2207                                  lff24m2_2:
  2208                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2209                                  	;mov	ebp, eax	; [next_val]
  2210                                  	;add	ax, [previous_val]
  2211                                  	; ax = [previous_val]
  2212                                  	; bx = [next_val]
  2213 000012AF 6601D8                  	add	ax, bx
  2214 000012B2 66D1D8                  	rcr	ax, 1
  2215 000012B5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2216 000012B8 66AB                    	stosw		; this is interpolated sample (L)
  2217 000012BA 66AB                    	stosw		; this is interpolated sample (R)
  2218                                  	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2219 000012BC 09C9                    	or	ecx, ecx
  2220 000012BE 75DE                    	jnz	short lff24m2_1
  2221 000012C0 E9B1F8FFFF              	jmp	lff24_3
  2222                                  
  2223                                  lff24m2_7:
  2224                                  lff24s2_7:
  2225 000012C5 E9C8F8FFFF              	jmp	lff24_5  ; error
  2226                                  
  2227                                  load_24khz_stereo_16_bit:
  2228                                  	; 16/11/2023
  2229                                  	; 15/11/2023
  2230 000012CA F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2231                                  					; last of the file?
  2232 000012D1 7402                    	jz	short lff24s2_0		; no
  2233 000012D3 F9                      	stc
  2234 000012D4 C3                      	retn
  2235                                  
  2236                                  lff24s2_0:
  2237 000012D5 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2238                                          ;mov	edx, [loadsize]
  2239                                  
  2240                                  	; esi = buffer address
  2241                                  	;; edx = buffer size
  2242                                  
  2243                                  	; load file into memory
  2244                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000012DA 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000012E0 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000012E2 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000012E8 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000012ED CD40                <1>  int 40h
  2245 000012EF 72D4                    	jc	short lff24s2_7 ; error !
  2246                                  
  2247 000012F1 BF[00300000]            	mov	edi, audio_buffer
  2248                                  	
  2249 000012F6 C1E802                  	shr	eax, 2
  2250 000012F9 7505                    	jnz	short lff24s2_8
  2251 000012FB E989F8FFFF              	jmp	lff24_eof
  2252                                  
  2253                                  lff24s2_8:
  2254 00001300 89C1                    	mov	ecx, eax  ; dword count
  2255                                  lff24s2_1:
  2256 00001302 66AD                    	lodsw
  2257 00001304 66AB                    	stosw		; original sample (L)
  2258 00001306 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2259 00001309 66A3[00210000]          	mov	[previous_val_l], ax
  2260 0000130F 66AD                    	lodsw
  2261 00001311 66AB                    	stosw		; original sample (R)
  2262 00001313 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2263                                  	;mov	[previous_val_r], ax
  2264 00001316 89C3                    	mov	ebx, eax
  2265 00001318 31D2                    	xor	edx, edx
  2266 0000131A 31C0                    	xor	eax, eax
  2267                                  	; 16/11/2023
  2268 0000131C 49                      	dec	ecx
  2269 0000131D 7407                    	jz	short lff24s2_2
  2270 0000131F 668B06                  	mov	ax, [esi]
  2271 00001322 668B5602                	mov	dx, [esi+2]
  2272                                  lff24s2_2:
  2273 00001326 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2274                                  	;;mov	[next_val_l], ax
  2275                                  	;mov	ebp, eax
  2276 00001329 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2277                                  	;mov	[next_val_r], dx
  2278 0000132C 660305[00210000]        	add	ax, [previous_val_l]
  2279 00001333 66D1D8                  	rcr	ax, 1
  2280 00001336 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2281 00001339 66AB                    	stosw		; this is interpolated sample (L)
  2282                                  	;mov	ax, [next_val_r]
  2283 0000133B 89D0                    	mov	eax, edx
  2284                                  	;add	ax, [previous_val_r]
  2285 0000133D 6601D8                  	add	ax, bx
  2286 00001340 66D1D8                  	rcr	ax, 1
  2287 00001343 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2288 00001346 66AB                    	stosw		; this is interpolated sample (R)
  2289                                  	
  2290                                  	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2291 00001348 09C9                    	or	ecx, ecx
  2292 0000134A 75B6                    	jnz	short lff24s2_1
  2293 0000134C E925F8FFFF              	jmp	lff24_3
  2294                                  
  2295                                  ; .....................
  2296                                  
  2297                                  load_32khz_mono_8_bit:
  2298                                  	; 15/11/2023
  2299 00001351 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2300                                  					; last of the file?
  2301 00001358 7402                    	jz	short lff32m_0		; no
  2302 0000135A F9                      	stc
  2303 0000135B C3                      	retn
  2304                                  
  2305                                  lff32m_0:
  2306 0000135C BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2307                                          ;mov	edx, [loadsize]
  2308                                  
  2309                                  	; esi = buffer address
  2310                                  	;; edx = buffer size
  2311                                  
  2312                                  	; load file into memory
  2313                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001361 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001367 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001369 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000136F B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001374 CD40                <1>  int 40h
  2314 00001376 7247                    	jc	short lff32m_7 ; error !
  2315                                  
  2316 00001378 BF[00300000]            	mov	edi, audio_buffer
  2317                                  	
  2318 0000137D 21C0                    	and	eax, eax
  2319 0000137F 7505                    	jnz	short lff32m_8
  2320 00001381 E903F8FFFF              	jmp	lff32_eof
  2321                                  
  2322                                  lff32m_8:
  2323 00001386 89C1                    	mov	ecx, eax	; byte count
  2324                                  lff32m_1:
  2325 00001388 AC                      	lodsb
  2326                                  	;mov	[previous_val], al
  2327 00001389 88C3                    	mov	bl, al
  2328 0000138B 2C80                    	sub	al, 80h
  2329 0000138D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2330 00001391 66AB                    	stosw		; original sample (left channel)
  2331 00001393 66AB                    	stosw		; original sample (right channel)
  2332                                  	;xor	eax, eax
  2333 00001395 B080                    	mov	al, 80h
  2334 00001397 49                      	dec	ecx
  2335 00001398 7402                    	jz	short lff32m_2
  2336 0000139A 8A06                    	mov	al, [esi]
  2337                                  lff32m_2:
  2338                                  	;;mov	[next_val], al
  2339                                  	;mov	bh, al
  2340                                  	;add	al, [previous_val]
  2341 0000139C 00D8                    	add	al, bl
  2342 0000139E D0D8                    	rcr	al, 1
  2343 000013A0 2C80                    	sub	al, 80h
  2344 000013A2 66C1E008                	shl	ax, 8
  2345 000013A6 66AB                    	stosw		; this is interpolated sample (L)
  2346 000013A8 66AB                    	stosw		; this is interpolated sample (R)
  2347                                  	
  2348                                  	; different than 8-16-24 kHZ !
  2349                                  	; 'original-interpolated-original' trio samples 
  2350 000013AA E30E                    	jecxz	lff32m_3
  2351                                  
  2352 000013AC AC                      	lodsb
  2353 000013AD 2C80                    	sub	al, 80h
  2354 000013AF 66C1E008                	shl	ax, 8
  2355 000013B3 66AB                    	stosw		; original sample (left channel)
  2356 000013B5 66AB                    	stosw		; original sample (right channel)
  2357                                  
  2358                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2359 000013B7 49                      	dec	ecx
  2360 000013B8 75CE                    	jnz	short lff32m_1
  2361                                  lff32m_3:
  2362 000013BA E9B7F7FFFF              	jmp	lff32_3
  2363                                  
  2364                                  lff32m_7:
  2365                                  lff32s_7:
  2366 000013BF E9CEF7FFFF              	jmp	lff32_5  ; error
  2367                                  
  2368                                  load_32khz_stereo_8_bit:
  2369                                  	; 15/11/2023
  2370 000013C4 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2371                                  					; last of the file?
  2372 000013CB 7402                    	jz	short lff32s_0		; no
  2373 000013CD F9                      	stc
  2374 000013CE C3                      	retn
  2375                                  
  2376                                  lff32s_0:
  2377 000013CF BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2378                                          ;mov	edx, [loadsize]
  2379                                  
  2380                                  	; esi = buffer address
  2381                                  	;; edx = buffer size
  2382                                  
  2383                                  	; load file into memory
  2384                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000013D4 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000013DA 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000013DC 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000013E2 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000013E7 CD40                <1>  int 40h
  2385 000013E9 72D4                    	jc	short lff32s_7 ; error !
  2386                                  
  2387 000013EB BF[00300000]            	mov	edi, audio_buffer
  2388                                  	
  2389 000013F0 D1E8                    	shr	eax, 1
  2390 000013F2 7505                    	jnz	short lff32s_8
  2391 000013F4 E990F7FFFF              	jmp	lff32_eof
  2392                                  
  2393                                  lff32s_8:
  2394 000013F9 89C1                    	mov	ecx, eax  ; word count
  2395                                  lff32s_1:
  2396 000013FB AC                      	lodsb
  2397 000013FC A2[00210000]            	mov	[previous_val_l], al
  2398 00001401 2C80                    	sub	al, 80h
  2399 00001403 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2400 00001407 66AB                    	stosw		; original sample (L)
  2401 00001409 AC                      	lodsb
  2402 0000140A A2[02210000]            	mov	[previous_val_r], al
  2403 0000140F 2C80                    	sub	al, 80h
  2404 00001411 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2405 00001415 66AB                    	stosw		; original sample (R)
  2406                                  
  2407                                  	;xor	eax, eax
  2408 00001417 66B88080                	mov	ax, 8080h
  2409 0000141B 49                      	dec	ecx
  2410 0000141C 7403                    	jz	short lff32s_2
  2411                                  		; convert 8 bit sample to 16 bit sample
  2412 0000141E 668B06                  	mov	ax, [esi]
  2413                                  lff32s_2:
  2414                                  	;;mov	[next_val_l], al
  2415                                  	;;mov	[next_val_r], ah
  2416                                  	;mov	bx, ax
  2417 00001421 88E7                    	mov	bh, ah
  2418 00001423 0205[00210000]          	add	al, [previous_val_l]
  2419 00001429 D0D8                    	rcr	al, 1
  2420                                  	;mov	dl, al
  2421 0000142B 2C80                    	sub	al, 80h
  2422 0000142D 66C1E008                	shl	ax, 8
  2423 00001431 66AB                    	stosw		; this is interpolated sample (L)
  2424 00001433 88F8                    	mov	al, bh	; [next_val_r]
  2425 00001435 0205[02210000]          	add	al, [previous_val_r]
  2426 0000143B D0D8                    	rcr	al, 1
  2427                                  	;mov	dh, al
  2428 0000143D 2C80                    	sub	al, 80h
  2429 0000143F 66C1E008                	shl	ax, 8
  2430 00001443 66AB                    	stosw		; this is interpolated sample (R)
  2431                                  
  2432                                  	; different than 8-16-24 kHZ !
  2433                                  	; 'original-interpolated-original' trio samples 
  2434 00001445 E315                    	jecxz	lff32s_3
  2435                                  
  2436 00001447 AC                      	lodsb
  2437 00001448 2C80                    	sub	al, 80h
  2438 0000144A 66C1E008                	shl	ax, 8
  2439 0000144E 66AB                    	stosw		; original sample (left channel)
  2440                                  
  2441 00001450 AC                      	lodsb
  2442 00001451 2C80                    	sub	al, 80h
  2443 00001453 66C1E008                	shl	ax, 8
  2444 00001457 66AB                    	stosw		; original sample (right channel)
  2445                                  		
  2446                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2447 00001459 49                      	dec	ecx
  2448 0000145A 759F                    	jnz	short lff32s_1
  2449                                  lff32s_3:
  2450 0000145C E915F7FFFF              	jmp	lff32_3
  2451                                  
  2452                                  load_32khz_mono_16_bit:
  2453                                  	; 15/11/2023
  2454 00001461 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2455                                  					; last of the file?
  2456 00001468 7402                    	jz	short lff32m2_0		; no
  2457 0000146A F9                      	stc
  2458 0000146B C3                      	retn
  2459                                  
  2460                                  lff32m2_0:
  2461 0000146C BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2462                                          ;mov	edx, [loadsize]
  2463                                  
  2464                                  	; esi = buffer address
  2465                                  	;; edx = buffer size
  2466                                  
  2467                                  	; load file into memory
  2468                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001471 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001477 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001479 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000147F B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001484 CD40                <1>  int 40h
  2469 00001486 723E                    	jc	short lff32m2_7 ; error !
  2470                                  
  2471 00001488 BF[00300000]            	mov	edi, audio_buffer
  2472                                  	
  2473 0000148D D1E8                    	shr	eax, 1
  2474 0000148F 7505                    	jnz	short lff32m2_8
  2475 00001491 E9F3F6FFFF              	jmp	lff32_eof
  2476                                  
  2477                                  lff32m2_8:
  2478 00001496 89C1                    	mov	ecx, eax  ; word count
  2479                                  lff32m2_1:
  2480 00001498 66AD                    	lodsw
  2481 0000149A 66AB                    	stosw		; original sample (left channel)
  2482 0000149C 66AB                    	stosw		; original sample (right channel)
  2483 0000149E 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  2484                                  	;mov	[previous_val], ax
  2485                                  	;mov	ebx, eax	
  2486                                  	;xor	eax, eax
  2487 000014A1 31DB                    	xor	ebx, ebx
  2488 000014A3 49                      	dec	ecx
  2489 000014A4 7403                    	jz	short lff32m2_2
  2490                                  	;mov	ax, [esi]
  2491 000014A6 668B1E                  	mov	bx, [esi]
  2492                                  lff32m2_2:
  2493                                  	;add	ah, 80h ; convert sound level 0 to 65535 format
  2494                                  	;mov	ebp, eax	; [next_val]
  2495                                  	;add	ax, [previous_val]
  2496                                  	; ax = [previous_val]
  2497                                  	; bx = [next_val]
  2498 000014A9 6601D8                  	add	ax, bx
  2499 000014AC 66D1D8                  	rcr	ax, 1
  2500 000014AF 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2501 000014B2 66AB                    	stosw		; this is interpolated sample (L)
  2502 000014B4 66AB                    	stosw		; this is interpolated sample (R)
  2503                                  
  2504                                  	; different than 8-16-24 kHZ !
  2505                                  	; 'original-interpolated-original' trio samples 
  2506 000014B6 E309                    	jecxz	lff32m2_3
  2507                                  
  2508 000014B8 66AD                    	lodsw
  2509 000014BA 66AB                    	stosw		; original sample (left channel)
  2510 000014BC 66AB                    	stosw		; original sample (right channel)
  2511                                  
  2512                                  	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2513 000014BE 49                      	dec	ecx
  2514 000014BF 75D7                    	jnz	short lff32m2_1
  2515                                  lff32m2_3:
  2516 000014C1 E9B0F6FFFF              	jmp	lff32_3
  2517                                  
  2518                                  lff32m2_7:
  2519                                  lff32s2_7:
  2520 000014C6 E9C7F6FFFF              	jmp	lff32_5  ; error
  2521                                  
  2522                                  load_32khz_stereo_16_bit:
  2523                                  	; 16/11/2023
  2524                                  	; 15/11/2023
  2525 000014CB F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2526                                  					; last of the file?
  2527 000014D2 7402                    	jz	short lff32s2_0		; no
  2528 000014D4 F9                      	stc
  2529 000014D5 C3                      	retn
  2530                                  
  2531                                  lff32s2_0:
  2532 000014D6 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2533                                          ;mov	edx, [loadsize]
  2534                                  
  2535                                  	; esi = buffer address
  2536                                  	;; edx = buffer size
  2537                                  
  2538                                  	; load file into memory
  2539                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000014DB 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000014E1 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000014E3 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000014E9 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000014EE CD40                <1>  int 40h
  2540 000014F0 72D4                    	jc	short lff32s2_7 ; error !
  2541                                  
  2542 000014F2 BF[00300000]            	mov	edi, audio_buffer
  2543                                  	
  2544 000014F7 C1E802                  	shr	eax, 2
  2545 000014FA 7505                    	jnz	short lff32s2_8
  2546 000014FC E988F6FFFF              	jmp	lff32_eof
  2547                                  
  2548                                  lff32s2_8:
  2549 00001501 89C1                    	mov	ecx, eax ; dword count
  2550                                  lff32s2_1:
  2551 00001503 66AD                    	lodsw
  2552 00001505 66AB                    	stosw		; original sample (L)
  2553 00001507 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2554 0000150A 66A3[00210000]          	mov	[previous_val_l], ax
  2555 00001510 66AD                    	lodsw
  2556 00001512 66AB                    	stosw		; original sample (R)
  2557 00001514 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2558                                  	;mov	[previous_val_r], ax
  2559 00001517 89C3                    	mov	ebx, eax
  2560 00001519 31D2                    	xor	edx, edx
  2561 0000151B 31C0                    	xor	eax, eax
  2562                                  	; 16/11/2023
  2563 0000151D 49                      	dec	ecx
  2564 0000151E 7407                    	jz	short lff32s2_2
  2565 00001520 668B06                  	mov	ax, [esi]
  2566 00001523 668B5602                	mov	dx, [esi+2]
  2567                                  lff32s2_2:
  2568 00001527 80C480                  	add	ah, 80h	; convert sound level 0 to 65535 format 
  2569                                  	;;mov	[next_val_l], ax
  2570                                  	;mov	ebp, eax
  2571 0000152A 80C680                  	add	dh, 80h	; convert sound level 0 to 65535 format 
  2572                                  	;mov	[next_val_r], dx
  2573 0000152D 660305[00210000]        	add	ax, [previous_val_l]
  2574 00001534 66D1D8                  	rcr	ax, 1
  2575 00001537 80EC80                  	sub	ah, 80h ; -32768 to +32767 format again
  2576 0000153A 66AB                    	stosw		; this is interpolated sample (L)
  2577                                  	;mov	ax, [next_val_r]
  2578 0000153C 89D0                    	mov	eax, edx
  2579                                  	;add	ax, [previous_val_r]
  2580 0000153E 6601D8                  	add	ax, bx
  2581 00001541 66D1D8                  	rcr	ax, 1
  2582 00001544 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  2583 00001547 66AB                    	stosw		; this is interpolated sample (R)
  2584                                  
  2585                                  	; different than 8-16-24 kHZ !
  2586                                  	; 'original-interpolated-original' trio samples 
  2587 00001549 E30B                    	jecxz	lff32s2_3
  2588                                  
  2589 0000154B 66AD                    	lodsw
  2590 0000154D 66AB                    	stosw	; original sample (L)
  2591 0000154F 66AD                    	lodsw
  2592 00001551 66AB                    	stosw	; original sample (R)
  2593                                  	
  2594                                  	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2595 00001553 49                      	dec	ecx
  2596 00001554 75AD                    	jnz	short lff32s2_1
  2597                                  lff32s2_3:
  2598 00001556 E91BF6FFFF              	jmp	lff32_3
  2599                                  
  2600                                  ; .....................
  2601                                  
  2602                                  load_22khz_mono_8_bit:
  2603                                  	; 16/11/2023
  2604 0000155B F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2605                                  					; last of the file?
  2606 00001562 7402                    	jz	short lff22m_0		; no
  2607 00001564 F9                      	stc
  2608 00001565 C3                      	retn
  2609                                  
  2610                                  lff22m_0:
  2611 00001566 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2612                                          ;mov	edx, [loadsize]
  2613                                  
  2614                                  	; esi = buffer address
  2615                                  	;; edx = buffer size
  2616                                  
  2617                                  	; load file into memory
  2618                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000156B 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001571 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001573 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001579 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000157E CD40                <1>  int 40h
  2619 00001580 725D                    	jc	short lff22m_7 ; error !
  2620                                  
  2621 00001582 BF[00300000]            	mov	edi, audio_buffer
  2622                                  	
  2623 00001587 21C0                    	and	eax, eax
  2624 00001589 7505                    	jnz	short lff22m_8
  2625 0000158B E9F9F5FFFF              	jmp	lff22_eof
  2626                                  
  2627                                  lff22m_8:
  2628 00001590 89C1                    	mov	ecx, eax	; byte count
  2629                                  lff22m_9:
  2630 00001592 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2631 00001597 C605[08210000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2632                                  lff22m_1:
  2633                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2634 0000159E AC                      	lodsb
  2635 0000159F B280                    	mov	dl, 80h
  2636 000015A1 49                      	dec	ecx
  2637 000015A2 7402                    	jz	short lff22m_2_1
  2638 000015A4 8A16                    	mov	dl, [esi]
  2639                                  lff22m_2_1:	
  2640                                  	; al = [previous_val]
  2641                                  	; dl = [next_val]
  2642 000015A6 E80F060000              	call	interpolating_3_8bit_mono ; 1 of 17
  2643 000015AB E32D                    	jecxz	lff22m_3
  2644                                  lff22m_2_2:
  2645 000015AD AC                      	lodsb
  2646 000015AE B280                    	mov	dl, 80h
  2647 000015B0 49                      	dec	ecx
  2648 000015B1 7402                    	jz	short lff22m_2_3
  2649 000015B3 8A16                    	mov	dl, [esi]
  2650                                  lff22m_2_3:
  2651 000015B5 E884060000               	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2652 000015BA E31E                    	jecxz	lff22m_3
  2653 000015BC 4D                      	dec	ebp
  2654 000015BD 75EE                    	jnz	short lff22m_2_2
  2655                                  
  2656 000015BF A0[08210000]            	mov	al, [faz]
  2657 000015C4 FEC8                    	dec	al
  2658 000015C6 74CA                    	jz	short lff22m_9
  2659 000015C8 FE0D[08210000]          	dec	byte [faz]
  2660 000015CE BD04000000              	mov	ebp, 4
  2661 000015D3 FEC8                    	dec	al
  2662 000015D5 75C7                    	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2663 000015D7 45                      	inc	ebp ; 5
  2664 000015D8 EBC4                    	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2665                                  
  2666                                  lff22m_3:
  2667                                  lff22s_3:
  2668 000015DA E997F5FFFF              	jmp	lff22_3	; padfill
  2669                                  		; (put zeros in the remain words of the buffer)
  2670                                  lff22m_7:
  2671                                  lff22s_7:
  2672 000015DF E9AEF5FFFF              	jmp	lff22_5  ; error
  2673                                  
  2674                                  load_22khz_stereo_8_bit:
  2675                                  	; 16/11/2023
  2676 000015E4 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2677                                  					; last of the file?
  2678 000015EB 7402                    	jz	short lff22s_0		; no
  2679 000015ED F9                      	stc
  2680 000015EE C3                      	retn
  2681                                  
  2682                                  lff22s_0:
  2683 000015EF BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2684                                          ;mov	edx, [loadsize]
  2685                                  
  2686                                  	; esi = buffer address
  2687                                  	;; edx = buffer size
  2688                                  
  2689                                  	; load file into memory
  2690                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000015F4 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000015FA 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000015FC 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001602 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001607 CD40                <1>  int 40h
  2691 00001609 72D4                    	jc	short lff22s_7 ; error !
  2692                                  
  2693 0000160B BF[00300000]            	mov	edi, audio_buffer
  2694                                  	
  2695 00001610 D1E8                    	shr	eax, 1
  2696 00001612 7505                    	jnz	short lff22s_8
  2697 00001614 E970F5FFFF              	jmp	lff22_eof
  2698                                  
  2699                                  lff22s_8:
  2700 00001619 89C1                    	mov	ecx, eax	; word count
  2701                                  lff22s_9:
  2702 0000161B BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2703 00001620 C605[08210000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2704                                  lff22s_1:
  2705                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2706 00001627 66AD                    	lodsw
  2707 00001629 66BA8080                	mov	dx, 8080h
  2708 0000162D 49                      	dec	ecx
  2709 0000162E 7403                    	jz	short lff22s_2_1 
  2710 00001630 668B16                  	mov	dx, [esi]
  2711                                  lff22s_2_1:	
  2712                                  	; al = [previous_val_l]
  2713                                  	; ah = [previous_val_r]
  2714                                  	; dl = [next_val_l]
  2715                                  	; dh = [next_val_r]	
  2716 00001633 E8B3050000              	call	interpolating_3_8bit_stereo ; 1 of 17 
  2717 00001638 E3A0                    	jecxz	lff22s_3
  2718                                  lff22s_2_2:
  2719 0000163A 66AD                    	lodsw
  2720 0000163C 66BA8080                	mov	dx, 8080h
  2721 00001640 49                      	dec	ecx
  2722 00001641 7403                    	jz	short lff22s_2_3
  2723 00001643 668B16                  	mov	dx, [esi]
  2724                                  lff22s_2_3:
  2725 00001646 E810060000               	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2726 0000164B E38D                    	jecxz	lff22s_3
  2727 0000164D 4D                      	dec	ebp
  2728 0000164E 75EA                    	jnz	short lff22s_2_2
  2729                                  
  2730 00001650 A0[08210000]            	mov	al, [faz]
  2731 00001655 FEC8                    	dec	al
  2732 00001657 74C2                    	jz	short lff22s_9
  2733 00001659 FE0D[08210000]          	dec	byte [faz]
  2734 0000165F BD04000000              	mov	ebp, 4
  2735 00001664 FEC8                    	dec	al
  2736 00001666 75BF                    	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2737 00001668 45                      	inc	ebp ; 5
  2738 00001669 EBBC                    	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2739                                  
  2740                                  load_22khz_mono_16_bit:
  2741                                  	; 16/11/2023
  2742 0000166B F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2743                                  					; last of the file?
  2744 00001672 7402                    	jz	short lff22m2_0		; no
  2745 00001674 F9                      	stc
  2746 00001675 C3                      	retn
  2747                                  
  2748                                  lff22m2_0:
  2749 00001676 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2750                                          ;mov	edx, [loadsize]
  2751                                  
  2752                                  	; esi = buffer address
  2753                                  	;; edx = buffer size
  2754                                  
  2755                                  	; load file into memory
  2756                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 0000167B 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001681 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001683 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001689 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000168E CD40                <1>  int 40h
  2757 00001690 7261                    	jc	short lff22m2_7 ; error !
  2758                                  
  2759 00001692 BF[00300000]            	mov	edi, audio_buffer
  2760                                  	
  2761 00001697 D1E8                    	shr	eax, 1
  2762 00001699 7505                    	jnz	short lff22m2_8
  2763 0000169B E9E9F4FFFF              	jmp	lff22_eof
  2764                                  
  2765                                  lff22m2_8:
  2766 000016A0 89C1                    	mov	ecx, eax	; word count
  2767                                  lff22m2_9:
  2768 000016A2 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2769 000016A7 C605[08210000]03        	mov	byte [faz], 3  ; 3 steps/phases
  2770                                  lff22m2_1:
  2771                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2772 000016AE 66AD                    	lodsw
  2773 000016B0 31D2                    	xor	edx, edx
  2774 000016B2 49                      	dec	ecx
  2775 000016B3 7403                    	jz	short lff22m2_2_1
  2776 000016B5 668B16                  	mov	dx, [esi]
  2777                                  lff22m2_2_1:	
  2778                                  	; ax = [previous_val]
  2779                                  	; dx = [next_val]
  2780 000016B8 E8CF050000              	call	interpolating_3_16bit_mono ; 1 of 17
  2781 000016BD E32F                    	jecxz	lff22m2_3
  2782                                  lff22m2_2_2:
  2783 000016BF 66AD                    	lodsw
  2784 000016C1 31D2                    	xor	edx, edx
  2785 000016C3 49                      	dec	ecx
  2786 000016C4 7403                    	jz	short lff22m2_2_3
  2787 000016C6 668B16                  	mov	dx, [esi]
  2788                                  lff22m2_2_3:
  2789 000016C9 E851060000               	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2790 000016CE E31E                    	jecxz	lff22m2_3
  2791 000016D0 4D                      	dec	ebp
  2792 000016D1 75EC                    	jnz	short lff22m2_2_2
  2793                                  
  2794 000016D3 A0[08210000]            	mov	al, [faz]
  2795 000016D8 FEC8                    	dec	al
  2796 000016DA 74C6                    	jz	short lff22m2_9
  2797 000016DC FE0D[08210000]          	dec	byte [faz]
  2798 000016E2 BD04000000              	mov	ebp, 4
  2799 000016E7 FEC8                    	dec	al
  2800 000016E9 75C3                    	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2801 000016EB 45                      	inc	ebp ; 5
  2802 000016EC EBC0                    	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2803                                  
  2804                                  lff22m2_3:
  2805                                  lff22s2_3:
  2806 000016EE E983F4FFFF              	jmp	lff22_3	; padfill
  2807                                  		; (put zeros in the remain words of the buffer)
  2808                                  lff22m2_7:
  2809                                  lff22s2_7:
  2810 000016F3 E99AF4FFFF              	jmp	lff22_5  ; error
  2811                                  
  2812                                  load_22khz_stereo_16_bit:
  2813                                  	; 16/11/2023
  2814 000016F8 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2815                                  					; last of the file?
  2816 000016FF 7402                    	jz	short lff22s2_0		; no
  2817 00001701 F9                      	stc
  2818 00001702 C3                      	retn
  2819                                  
  2820                                  lff22s2_0:
  2821 00001703 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2822                                          ;mov	edx, [loadsize]
  2823                                  
  2824                                  	; esi = buffer address
  2825                                  	;; edx = buffer size
  2826                                  
  2827                                  	; load file into memory
  2828                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001708 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000170E 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001710 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001716 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 0000171B CD40                <1>  int 40h
  2829 0000171D 72D4                    	jc	short lff22s2_7 ; error !
  2830                                  
  2831 0000171F BF[00300000]            	mov	edi, audio_buffer
  2832                                  	
  2833 00001724 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  2834 00001727 7505                    	jnz	short lff22s2_8
  2835 00001729 E95BF4FFFF              	jmp	lff22_eof
  2836                                  
  2837                                  lff22s2_8:
  2838 0000172E 89C1                    	mov	ecx, eax	; dword count
  2839                                  lff22s2_9:
  2840 00001730 BD05000000              	mov	ebp, 5 ; interpolation (one step) loop count
  2841 00001735 C605[08210000]03        	mov	byte [faz], 3  ; 3 steps/phase
  2842                                  lff22s2_1:
  2843                                  	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2844 0000173C 66AD                    	lodsw
  2845 0000173E 89C3                    	mov	ebx, eax
  2846 00001740 66AD                    	lodsw
  2847 00001742 8B16                    	mov	edx, [esi]
  2848 00001744 668915[04210000]        	mov	[next_val_l], dx
  2849                                  	; 26/11/2023
  2850 0000174B C1EA10                  	shr	edx, 16
  2851 0000174E 49                      	dec	ecx
  2852 0000174F 7509                    	jnz	short lff22s2_2_1
  2853 00001751 31D2                    	xor	edx, edx ; 0
  2854 00001753 668915[04210000]        	mov	[next_val_l], dx
  2855                                  lff22s2_2_1:
  2856                                  	; bx = [previous_val_l]
  2857                                  	; ax = [previous_val_r]
  2858                                  	; [next_val_l]
  2859                                  	; dx = [next_val_r]
  2860 0000175A E85D050000              	call	interpolating_3_16bit_stereo ; 1 of 17 
  2861 0000175F E38D                    	jecxz	lff22s2_3
  2862                                  lff22s2_2_2:
  2863 00001761 66AD                    	lodsw
  2864 00001763 89C3                    	mov	ebx, eax
  2865 00001765 66AD                    	lodsw
  2866 00001767 8B16                    	mov	edx, [esi]
  2867 00001769 668915[04210000]        	mov	[next_val_l], dx
  2868                                  	; 26/11/2023
  2869 00001770 C1EA10                  	shr	edx, 16
  2870 00001773 49                      	dec	ecx
  2871 00001774 7509                    	jnz	short lff22s2_2_3
  2872 00001776 31D2                    	xor	edx, edx ; 0
  2873 00001778 668915[04210000]        	mov	[next_val_l], dx
  2874                                  lff22s2_2_3:
  2875 0000177F E8B3050000               	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  2876 00001784 E31E                    	jecxz	lff22s2_2_4
  2877                                  
  2878 00001786 4D                      	dec	ebp
  2879 00001787 75D8                    	jnz	short lff22s2_2_2
  2880                                  
  2881 00001789 A0[08210000]            	mov	al, [faz]
  2882 0000178E FEC8                    	dec	al
  2883 00001790 749E                    	jz	short lff22s2_9
  2884 00001792 FE0D[08210000]          	dec	byte [faz]
  2885 00001798 BD04000000              	mov	ebp, 4
  2886 0000179D FEC8                    	dec	al
  2887 0000179F 759B                    	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2888 000017A1 45                      	inc	ebp ; 5
  2889 000017A2 EB98                    	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2890                                  
  2891                                  lff22s2_2_4:
  2892                                  	; 26/11/2023
  2893 000017A4 E9CDF3FFFF              	jmp	lff22_3	; padfill
  2894                                  
  2895                                  ; .....................
  2896                                  
  2897                                  load_11khz_mono_8_bit:
  2898                                  	; 18/11/2023
  2899 000017A9 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2900                                  					; last of the file?
  2901 000017B0 7402                    	jz	short lff11m_0		; no
  2902 000017B2 F9                      	stc
  2903 000017B3 C3                      	retn
  2904                                  
  2905                                  lff11m_0:
  2906 000017B4 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2907                                          ;mov	edx, [loadsize]
  2908                                  
  2909                                  	; esi = buffer address
  2910                                  	;; edx = buffer size
  2911                                  
  2912                                  	; load file into memory
  2913                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000017B9 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000017BF 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000017C1 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000017C7 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000017CC CD40                <1>  int 40h
  2914 000017CE 7247                    	jc	short lff11m_7 ; error !
  2915                                  
  2916 000017D0 BF[00300000]            	mov	edi, audio_buffer
  2917                                  	
  2918 000017D5 21C0                    	and	eax, eax
  2919 000017D7 7505                    	jnz	short lff11m_8
  2920 000017D9 E9ABF3FFFF              	jmp	lff11_eof
  2921                                  
  2922                                  lff11m_8:
  2923 000017DE 89C1                    	mov	ecx, eax		; byte count
  2924                                  lff11m_9:
  2925 000017E0 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  2926                                  lff11m_1:
  2927                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2928 000017E5 AC                      	lodsb
  2929 000017E6 B280                    	mov	dl, 80h
  2930 000017E8 49                      	dec	ecx
  2931 000017E9 7402                    	jz	short lff11m_2_1
  2932 000017EB 8A16                    	mov	dl, [esi]
  2933                                  lff11m_2_1:	
  2934                                  	; al = [previous_val]
  2935                                  	; dl = [next_val]
  2936 000017ED E876050000              	call	interpolating_5_8bit_mono
  2937 000017F2 E328                    	jecxz	lff11m_3
  2938                                  lff11m_2_2:
  2939 000017F4 AC                      	lodsb
  2940 000017F5 B280                    	mov	dl, 80h
  2941 000017F7 49                      	dec	ecx
  2942 000017F8 7402                    	jz	short lff11m_2_3
  2943 000017FA 8A16                    	mov	dl, [esi]
  2944                                  lff11m_2_3:
  2945 000017FC E873060000               	call	interpolating_4_8bit_mono
  2946 00001801 E319                    	jecxz	lff11m_3
  2947                                  
  2948 00001803 4D                      	dec	ebp
  2949 00001804 74DA                    	jz	short lff11m_9
  2950                                  
  2951 00001806 AC                      	lodsb
  2952 00001807 B280                    	mov	dl, 80h
  2953 00001809 49                      	dec	ecx
  2954 0000180A 7402                    	jz	short lff11m_2_4
  2955 0000180C 8A16                    	mov	dl, [esi]
  2956                                  lff11m_2_4:
  2957 0000180E E861060000              	call	interpolating_4_8bit_mono
  2958 00001813 E307                    	jecxz	lff11m_3
  2959 00001815 EBCE                    	jmp	short lff11m_1
  2960                                  
  2961                                  lff11m_7:
  2962                                  lff11s_7:
  2963 00001817 E976F3FFFF              	jmp	lff11_5  ; error
  2964                                  
  2965                                  lff11m_3:
  2966                                  lff11s_3:
  2967 0000181C E955F3FFFF              	jmp	lff11_3	; padfill
  2968                                  		; (put zeros in the remain words of the buffer)
  2969                                  
  2970                                  load_11khz_stereo_8_bit:
  2971                                  	; 18/11/2023
  2972 00001821 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  2973                                  					; last of the file?
  2974 00001828 7402                    	jz	short lff11s_0		; no
  2975 0000182A F9                      	stc
  2976 0000182B C3                      	retn
  2977                                  
  2978                                  lff11s_0:
  2979 0000182C BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  2980                                          ;mov	edx, [loadsize]
  2981                                  
  2982                                  	; esi = buffer address
  2983                                  	;; edx = buffer size
  2984                                  
  2985                                  	; load file into memory
  2986                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001831 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001837 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001839 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 0000183F B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001844 CD40                <1>  int 40h
  2987 00001846 72CF                    	jc	short lff11s_7 ; error !
  2988                                  
  2989 00001848 BF[00300000]            	mov	edi, audio_buffer
  2990                                  	
  2991 0000184D D1E8                    	shr	eax, 1
  2992 0000184F 7505                    	jnz	short lff11s_8
  2993 00001851 E933F3FFFF              	jmp	lff11_eof
  2994                                  
  2995                                  lff11s_8:
  2996 00001856 89C1                    	mov	ecx, eax	; word count
  2997                                  lff11s_9:
  2998 00001858 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  2999                                  lff11s_1:
  3000                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3001 0000185D 66AD                    	lodsw
  3002 0000185F 66BA8080                	mov	dx, 8080h
  3003 00001863 49                      	dec	ecx
  3004 00001864 7403                    	jz	short lff11s_2_1 
  3005 00001866 668B16                  	mov	dx, [esi]
  3006                                  lff11s_2_1:	
  3007                                  	; al = [previous_val_l]
  3008                                  	; ah = [previous_val_r]
  3009                                  	; dl = [next_val_l]
  3010                                  	; dh = [next_val_r]	
  3011 00001869 E859050000              	call	interpolating_5_8bit_stereo
  3012 0000186E E3AC                    	jecxz	lff11s_3
  3013                                  lff11s_2_2:
  3014 00001870 66AD                    	lodsw
  3015 00001872 66BA8080                	mov	dx, 8080h
  3016 00001876 49                      	dec	ecx
  3017 00001877 7403                    	jz	short lff11s_2_3
  3018 00001879 668B16                  	mov	dx, [esi]
  3019                                  lff11s_2_3:
  3020 0000187C E832060000               	call	interpolating_4_8bit_stereo
  3021 00001881 E399                    	jecxz	lff11s_3
  3022                                  	
  3023 00001883 4D                      	dec	ebp
  3024 00001884 74D2                    	jz	short lff11s_9
  3025                                  
  3026 00001886 66AD                    	lodsw
  3027 00001888 66BA8080                	mov	dx, 8080h
  3028 0000188C 49                      	dec	ecx
  3029 0000188D 7403                    	jz	short lff11s_2_4
  3030 0000188F 668B16                  	mov	dx, [esi]
  3031                                  lff11s_2_4:
  3032 00001892 E81C060000              	call	interpolating_4_8bit_stereo
  3033 00001897 E383                    	jecxz	lff11s_3
  3034 00001899 EBC2                    	jmp	short lff11s_1
  3035                                  
  3036                                  load_11khz_mono_16_bit:
  3037                                  	; 18/11/2023
  3038 0000189B F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3039                                  					; last of the file?
  3040 000018A2 7402                    	jz	short lff11m2_0		; no
  3041 000018A4 F9                      	stc
  3042 000018A5 C3                      	retn
  3043                                  
  3044                                  lff11m2_0:
  3045 000018A6 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3046                                          ;mov	edx, [loadsize]
  3047                                  
  3048                                  	; esi = buffer address
  3049                                  	;; edx = buffer size
  3050                                  
  3051                                  	; load file into memory
  3052                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000018AB 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000018B1 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000018B3 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000018B9 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000018BE CD40                <1>  int 40h
  3053 000018C0 724D                    	jc	short lff11m2_7 ; error !
  3054                                  
  3055 000018C2 BF[00300000]            	mov	edi, audio_buffer
  3056                                  	
  3057 000018C7 D1E8                    	shr	eax, 1
  3058 000018C9 7505                    	jnz	short lff11m2_8
  3059 000018CB E9B9F2FFFF              	jmp	lff11_eof
  3060                                  
  3061                                  lff11m2_8:
  3062 000018D0 89C1                    	mov	ecx, eax	; word count
  3063                                  lff11m2_9:
  3064 000018D2 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3065                                  lff11m2_1:
  3066                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3067 000018D7 66AD                    	lodsw
  3068 000018D9 31D2                    	xor	edx, edx
  3069 000018DB 49                      	dec	ecx
  3070 000018DC 7403                    	jz	short lff11m2_2_1
  3071 000018DE 668B16                  	mov	dx, [esi]
  3072                                  lff11m2_2_1:	
  3073                                  	; ax = [previous_val]
  3074                                  	; dx = [next_val]
  3075 000018E1 E83A060000              	call	interpolating_5_16bit_mono
  3076 000018E6 E362                    	jecxz	lff11m2_3
  3077                                  lff11m2_2_2:
  3078 000018E8 66AD                    	lodsw
  3079 000018EA 31D2                    	xor	edx, edx
  3080 000018EC 49                      	dec	ecx
  3081 000018ED 7403                    	jz	short lff11m2_2_3
  3082 000018EF 668B16                  	mov	dx, [esi]
  3083                                  lff11m2_2_3:
  3084 000018F2 E853070000               	call	interpolating_4_16bit_mono
  3085 000018F7 E351                    	jecxz	lff11m2_3
  3086                                  
  3087 000018F9 4D                      	dec	ebp
  3088 000018FA 74D6                    	jz	short lff11m2_9
  3089                                  
  3090 000018FC 66AD                    	lodsw
  3091 000018FE 31D2                    	xor	edx, edx
  3092 00001900 49                      	dec	ecx
  3093 00001901 7403                    	jz	short lff11m2_2_4
  3094 00001903 668B16                  	mov	dx, [esi]
  3095                                  lff11m2_2_4:
  3096 00001906 E83F070000               	call	interpolating_4_16bit_mono
  3097 0000190B E33D                    	jecxz	lff11m2_3
  3098 0000190D EBC8                    	jmp	short lff11m2_1
  3099                                  
  3100                                  lff11m2_7:
  3101                                  lff11s2_7:
  3102 0000190F E97EF2FFFF              	jmp	lff11_5  ; error
  3103                                  
  3104                                  load_11khz_stereo_16_bit:
  3105                                  	; 18/11/2023
  3106 00001914 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3107                                  					; last of the file?
  3108 0000191B 7402                    	jz	short lff11s2_0		; no
  3109 0000191D F9                      	stc
  3110 0000191E C3                      	retn
  3111                                  
  3112                                  lff11s2_0:
  3113 0000191F BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3114                                          ;mov	edx, [loadsize]
  3115                                  
  3116                                  	; esi = buffer address
  3117                                  	;; edx = buffer size
  3118                                  
  3119                                  	; load file into memory
  3120                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001924 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 0000192A 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 0000192C 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001932 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001937 CD40                <1>  int 40h
  3121 00001939 72D4                    	jc	short lff11s2_7 ; error !
  3122                                  
  3123 0000193B BF[00300000]            	mov	edi, audio_buffer
  3124                                  	
  3125 00001940 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3126 00001943 750A                    	jnz	short lff11s2_8
  3127 00001945 E93FF2FFFF              	jmp	lff11_eof
  3128                                  
  3129                                  lff11m2_3:
  3130                                  lff11s2_3:
  3131 0000194A E927F2FFFF              	jmp	lff11_3	; padfill
  3132                                  		; (put zeros in the remain words of the buffer)
  3133                                  
  3134                                  lff11s2_8:
  3135 0000194F 89C1                    	mov	ecx, eax	; dword count
  3136                                  lff11s2_9:
  3137 00001951 BD06000000              	mov	ebp, 6 ; interpolation (one step) loop count
  3138                                  lff11s2_1:
  3139                                  	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3140 00001956 66AD                    	lodsw
  3141 00001958 89C3                    	mov	ebx, eax
  3142 0000195A 66AD                    	lodsw
  3143 0000195C 8B16                    	mov	edx, [esi]
  3144 0000195E 8915[04210000]          	mov	[next_val_l], edx
  3145                                  	; 26/11/2023
  3146 00001964 C1EA10                  	shr	edx, 16
  3147                                  	;mov	[next_val_r], dx
  3148 00001967 49                      	dec	ecx
  3149 00001968 7509                    	jnz	short lff11s2_2_1
  3150 0000196A 31D2                    	xor	edx, edx ; 0
  3151 0000196C 668915[04210000]        	mov	[next_val_l], dx
  3152                                  	;mov	[next_val_r], dx
  3153                                  lff11s2_2_1:
  3154                                  	; bx = [previous_val_l]
  3155                                  	; ax = [previous_val_r]
  3156                                  	; [next_val_l]
  3157                                  	; dx = [next_val_r]
  3158 00001973 E803060000              	call	interpolating_5_16bit_stereo
  3159 00001978 E3D0                    	jecxz	lff11s2_3
  3160                                  lff11s2_2_2:
  3161 0000197A 66AD                    	lodsw
  3162 0000197C 89C3                    	mov	ebx, eax
  3163 0000197E 66AD                    	lodsw
  3164 00001980 8B16                    	mov	edx, [esi]
  3165 00001982 668915[04210000]        	mov	[next_val_l], dx
  3166                                  	; 26/11/2023
  3167 00001989 C1EA10                  	shr	edx, 16
  3168                                  	;mov	[next_val_r], dx
  3169 0000198C 49                      	dec	ecx
  3170 0000198D 7509                    	jnz	short lff11s2_2_3
  3171 0000198F 31D2                    	xor	edx, edx ; 0
  3172 00001991 668915[04210000]        	mov	[next_val_l], dx
  3173                                  	;mov	[next_val_r], dx
  3174                                  lff11s2_2_3:
  3175 00001998 E8E6060000               	call	interpolating_4_16bit_stereo
  3176 0000199D E3AB                    	jecxz	lff11s2_3
  3177                                  	
  3178 0000199F 4D                      	dec	ebp
  3179 000019A0 74AF                    	jz	short lff11s2_9
  3180                                  
  3181 000019A2 66AD                    	lodsw
  3182 000019A4 89C3                    	mov	ebx, eax
  3183 000019A6 66AD                    	lodsw
  3184 000019A8 8B16                    	mov	edx, [esi]
  3185 000019AA 668915[04210000]        	mov	[next_val_l], dx
  3186                                  	; 26/11/2023
  3187 000019B1 C1EA10                  	shr	edx, 16
  3188                                  	;mov	[next_val_r], dx
  3189 000019B4 49                      	dec	ecx
  3190 000019B5 7509                    	jnz	short lff11s2_2_4
  3191 000019B7 31D2                    	xor	edx, edx ; 0
  3192 000019B9 668915[04210000]        	mov	[next_val_l], dx
  3193                                  	;mov	[next_val_r], dx
  3194                                  lff11s2_2_4:
  3195 000019C0 E8BE060000               	call	interpolating_4_16bit_stereo
  3196 000019C5 E383                    	jecxz	lff11s2_3
  3197 000019C7 EB8D                    	jmp	short lff11s2_1
  3198                                  
  3199                                  ; .....................
  3200                                  
  3201                                  load_44khz_mono_8_bit:
  3202                                  	; 18/11/2023
  3203 000019C9 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3204                                  					; last of the file?
  3205 000019D0 7402                    	jz	short lff44m_0		; no
  3206 000019D2 F9                      	stc
  3207 000019D3 C3                      	retn
  3208                                  
  3209                                  lff44m_0:
  3210 000019D4 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3211                                          ;mov	edx, [loadsize]
  3212                                  
  3213                                  	; esi = buffer address
  3214                                  	;; edx = buffer size
  3215                                  
  3216                                  	; load file into memory
  3217                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 000019D9 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 000019DF 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 000019E1 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 000019E7 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 000019EC CD40                <1>  int 40h
  3218 000019EE 7250                    	jc	short lff44m_7 ; error !
  3219                                  
  3220 000019F0 BF[00300000]            	mov	edi, audio_buffer
  3221                                  	
  3222 000019F5 21C0                    	and	eax, eax
  3223 000019F7 7505                    	jnz	short lff44m_8
  3224 000019F9 E98BF1FFFF              	jmp	lff44_eof
  3225                                  
  3226                                  lff44m_8:
  3227 000019FE 89C1                    	mov	ecx, eax	; byte count
  3228                                  lff44m_9:
  3229 00001A00 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3230 00001A05 C605[08210000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3231                                  lff44m_1:
  3232                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3233                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3234 00001A0C AC                      	lodsb
  3235 00001A0D B280                    	mov	dl, 80h
  3236 00001A0F 49                      	dec	ecx
  3237 00001A10 7402                    	jz	short lff44m_2_1
  3238 00001A12 8A16                    	mov	dl, [esi]
  3239                                  lff44m_2_1:	
  3240                                  	; al = [previous_val]
  3241                                  	; dl = [next_val]
  3242 00001A14 E825020000              	call	interpolating_2_8bit_mono
  3243 00001A19 E320                    	jecxz	lff44m_3
  3244                                  lff44m_2_2:
  3245 00001A1B AC                      	lodsb
  3246 00001A1C 2C80                    	sub	al, 80h
  3247 00001A1E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3248 00001A22 66AB                    	stosw		; (L)
  3249 00001A24 66AB                    	stosw		; (R)	
  3250                                  
  3251 00001A26 49                      	dec	ecx
  3252 00001A27 7412                    	jz	short lff44m_3	
  3253 00001A29 4D                      	dec	ebp
  3254 00001A2A 75EF                    	jnz	short lff44m_2_2
  3255                                  	
  3256 00001A2C FE0D[08210000]          	dec	byte [faz]
  3257 00001A32 74CC                    	jz	short lff44m_9 
  3258 00001A34 BD0B000000              	mov	ebp, 11
  3259 00001A39 EBD1                    	jmp	short lff44m_1
  3260                                  
  3261                                  lff44m_3:
  3262                                  lff44s_3:
  3263 00001A3B E936F1FFFF              	jmp	lff44_3	; padfill
  3264                                  		; (put zeros in the remain words of the buffer)
  3265                                  lff44m_7:
  3266                                  lff44s_7:
  3267 00001A40 E94DF1FFFF              	jmp	lff44_5  ; error
  3268                                  
  3269                                  load_44khz_stereo_8_bit:
  3270                                  	; 16/11/2023
  3271 00001A45 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3272                                  					; last of the file?
  3273 00001A4C 7402                    	jz	short lff44s_0		; no
  3274 00001A4E F9                      	stc
  3275 00001A4F C3                      	retn
  3276                                  
  3277                                  lff44s_0:
  3278 00001A50 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3279                                          ;mov	edx, [loadsize]
  3280                                  
  3281                                  	; esi = buffer address
  3282                                  	;; edx = buffer size
  3283                                  
  3284                                  	; load file into memory
  3285                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001A55 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001A5B 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001A5D 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001A63 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001A68 CD40                <1>  int 40h
  3286 00001A6A 72D4                    	jc	short lff44s_7 ; error !
  3287                                  
  3288 00001A6C BF[00300000]            	mov	edi, audio_buffer
  3289                                  	
  3290 00001A71 D1E8                    	shr	eax, 1
  3291 00001A73 7505                    	jnz	short lff44s_8
  3292 00001A75 E90FF1FFFF              	jmp	lff44_eof
  3293                                  
  3294                                  lff44s_8:
  3295 00001A7A 89C1                    	mov	ecx, eax	; word count
  3296                                  lff44s_9:
  3297 00001A7C BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3298 00001A81 C605[08210000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3299                                  lff44s_1:
  3300                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3301                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3302 00001A88 66AD                    	lodsw
  3303 00001A8A 66BA8080                	mov	dx, 8080h
  3304 00001A8E 49                      	dec	ecx
  3305 00001A8F 7403                    	jz	short lff44s_2_1 
  3306 00001A91 668B16                  	mov	dx, [esi]
  3307                                  lff44s_2_1:	
  3308                                  	; al = [previous_val_l]
  3309                                  	; ah = [previous_val_r]
  3310                                  	; dl = [next_val_l]
  3311                                  	; dh = [next_val_r]	
  3312 00001A94 E8C2010000              	call	interpolating_2_8bit_stereo
  3313 00001A99 E3A0                    	jecxz	lff44s_3
  3314                                  lff44s_2_2:
  3315 00001A9B AC                      	lodsb
  3316 00001A9C 2C80                    	sub	al, 80h
  3317 00001A9E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3318 00001AA2 66AB                    	stosw		; (L)
  3319 00001AA4 AC                      	lodsb
  3320 00001AA5 2C80                    	sub	al, 80h
  3321 00001AA7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3322 00001AAB 66AB                    	stosw		; (R)
  3323                                  
  3324 00001AAD 49                      	dec	ecx
  3325 00001AAE 748B                    	jz	short lff44s_3	
  3326 00001AB0 4D                      	dec	ebp
  3327 00001AB1 75E8                    	jnz	short lff44s_2_2
  3328                                  	
  3329 00001AB3 FE0D[08210000]          	dec	byte [faz]
  3330 00001AB9 74C1                    	jz	short lff44s_9 
  3331 00001ABB BD0B000000              	mov	ebp, 11
  3332 00001AC0 EBC6                    	jmp	short lff44s_1
  3333                                  
  3334                                  load_44khz_mono_16_bit:
  3335                                  	; 18/11/2023
  3336 00001AC2 F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3337                                  					; last of the file?
  3338 00001AC9 7402                    	jz	short lff44m2_0		; no
  3339 00001ACB F9                      	stc
  3340 00001ACC C3                      	retn
  3341                                  
  3342                                  lff44m2_0:
  3343 00001ACD BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3344                                          ;mov	edx, [loadsize]
  3345                                  
  3346                                  	; esi = buffer address
  3347                                  	;; edx = buffer size
  3348                                  
  3349                                  	; load file into memory
  3350                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001AD2 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001AD8 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001ADA 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001AE0 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001AE5 CD40                <1>  int 40h
  3351 00001AE7 724D                    	jc	short lff44m2_7 ; error !
  3352                                  
  3353 00001AE9 BF[00300000]            	mov	edi, audio_buffer
  3354                                  	
  3355 00001AEE D1E8                    	shr	eax, 1
  3356 00001AF0 7505                    	jnz	short lff44m2_8
  3357 00001AF2 E992F0FFFF              	jmp	lff44_eof
  3358                                  
  3359                                  lff44m2_8:
  3360 00001AF7 89C1                    	mov	ecx, eax	; word count
  3361                                  lff44m2_9:
  3362 00001AF9 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3363 00001AFE C605[08210000]02        	mov	byte [faz], 2  ; 2 steps/phases
  3364                                  lff44m2_1:
  3365                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3366                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3367 00001B05 66AD                    	lodsw
  3368 00001B07 31D2                    	xor	edx, edx
  3369 00001B09 49                      	dec	ecx
  3370 00001B0A 7403                    	jz	short lff44m2_2_1
  3371 00001B0C 668B16                  	mov	dx, [esi]
  3372                                  lff44m2_2_1:	
  3373                                  	; ax = [previous_val]
  3374                                  	; dx = [next_val]
  3375 00001B0F E80B020000              	call	interpolating_2_16bit_mono
  3376 00001B14 E31B                    	jecxz	lff44m2_3
  3377                                  lff44m2_2_2:
  3378 00001B16 66AD                    	lodsw
  3379 00001B18 66AB                    	stosw		; (L)eft Channel
  3380 00001B1A 66AB                    	stosw		; (R)ight Channel
  3381                                  
  3382 00001B1C 49                      	dec	ecx
  3383 00001B1D 7412                    	jz	short lff44m2_3	
  3384 00001B1F 4D                      	dec	ebp
  3385 00001B20 75F4                    	jnz	short lff44m2_2_2
  3386                                  	
  3387 00001B22 FE0D[08210000]          	dec	byte [faz]
  3388 00001B28 74CF                    	jz	short lff44m2_9 
  3389 00001B2A BD0B000000              	mov	ebp, 11
  3390 00001B2F EBD4                    	jmp	short lff44m2_1
  3391                                  
  3392                                  lff44m2_3:
  3393                                  lff44s2_3:
  3394 00001B31 E940F0FFFF              	jmp	lff44_3	; padfill
  3395                                  		; (put zeros in the remain words of the buffer)
  3396                                  lff44m2_7:
  3397                                  lff44s2_7:
  3398 00001B36 E957F0FFFF              	jmp	lff44_5  ; error
  3399                                  
  3400                                  load_44khz_stereo_16_bit:
  3401                                  	; 18/11/2023
  3402 00001B3B F605[18240000]01                test    byte [flags], ENDOFFILE	; have we already read the
  3403                                  					; last of the file?
  3404 00001B42 7402                    	jz	short lff44s2_0		; no
  3405 00001B44 F9                      	stc
  3406 00001B45 C3                      	retn
  3407                                  
  3408                                  lff44s2_0:
  3409 00001B46 BE[00300100]            	mov	esi, temp_buffer ; temporary buffer for wav data
  3410                                          ;mov	edx, [loadsize]
  3411                                  
  3412                                  	; esi = buffer address
  3413                                  	;; edx = buffer size
  3414                                  
  3415                                  	; load file into memory
  3416                                  	sys 	_read, [FileHandle], esi, [loadsize]
    72                              <1> 
    73                              <1> 
    74                              <1> 
    75                              <1> 
    76                              <1>  %if %0 >= 2
    77 00001B4B 8B1D[09210000]      <1>  mov ebx, %2
    78                              <1>  %if %0 >= 3
    79 00001B51 89F1                <1>  mov ecx, %3
    80                              <1>  %if %0 = 4
    81 00001B53 8B15[D6030000]      <1>  mov edx, %4
    82                              <1>  %endif
    83                              <1>  %endif
    84                              <1>  %endif
    85 00001B59 B803000000          <1>  mov eax, %1
    86                              <1> 
    87 00001B5E CD40                <1>  int 40h
  3417 00001B60 72D4                    	jc	short lff44s2_7 ; error !
  3418                                  
  3419 00001B62 BF[00300000]            	mov	edi, audio_buffer
  3420                                  	
  3421 00001B67 C1E802                  	shr	eax, 2	; dword (left chan word + right chan word)
  3422 00001B6A 7505                    	jnz	short lff44s2_8
  3423 00001B6C E918F0FFFF              	jmp	lff44_eof
  3424                                  
  3425                                  lff44s2_8:
  3426 00001B71 89C1                    	mov	ecx, eax	; dword count
  3427                                  lff44s2_9:
  3428 00001B73 BD0A000000              	mov	ebp, 10 ; interpolation (one step) loop count
  3429 00001B78 C605[08210000]02        	mov	byte [faz], 2  ; 2 steps/phase
  3430                                  lff44s2_1:
  3431                                  	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3432                                  	; 2:1:1:1:1:1:1:1:1:1:1:1
  3433 00001B7F 66AD                    	lodsw
  3434 00001B81 89C3                    	mov	ebx, eax
  3435 00001B83 66AD                    	lodsw
  3436                                  	;mov	dx, [esi]
  3437                                  	;mov	[next_val_l], dx
  3438                                  	;mov	dx, [esi+2]
  3439                                  	; 26/11/2023
  3440 00001B85 8B16                    	mov	edx, [esi]
  3441 00001B87 668915[04210000]        	mov	[next_val_l], dx
  3442 00001B8E C1EA10                  	shr	edx, 16
  3443 00001B91 49                      	dec	ecx
  3444 00001B92 7509                    	jnz	short lff44s2_2_1
  3445 00001B94 31D2                    	xor	edx, edx ; 0
  3446 00001B96 668915[04210000]        	mov	[next_val_l], dx
  3447                                  lff44s2_2_1:
  3448                                  	; bx = [previous_val_l]
  3449                                  	; ax = [previous_val_r]
  3450                                  	; [next_val_l]
  3451                                  	; dx = [next_val_r]
  3452 00001B9D E895010000              	call	interpolating_2_16bit_stereo
  3453 00001BA2 E38D                    	jecxz	lff44s2_3
  3454                                  lff44s2_2_2:
  3455                                  	;movsw		; (L)eft Channel
  3456                                  	;movsw		; (R)ight Channel
  3457 00001BA4 A5                      	movsd
  3458                                  
  3459 00001BA5 49                      	dec	ecx
  3460 00001BA6 7489                    	jz	short lff44s2_3	
  3461 00001BA8 4D                      	dec	ebp
  3462 00001BA9 75F9                    	jnz	short lff44s2_2_2
  3463                                  	
  3464 00001BAB FE0D[08210000]          	dec	byte [faz]
  3465 00001BB1 74C0                    	jz	short lff44s2_9 
  3466 00001BB3 BD0B000000              	mov	ebp, 11
  3467 00001BB8 EBC5                    	jmp	short lff44s2_1
  3468                                  
  3469                                  ; .....................
  3470                                  
  3471                                  interpolating_3_8bit_mono:
  3472                                  	; 16/11/2023
  3473                                  	; al = [previous_val]
  3474                                  	; dl = [next_val]
  3475                                  	; original-interpolated-interpolated
  3476 00001BBA 88C3                    	mov	bl, al
  3477 00001BBC 2C80                    	sub	al, 80h
  3478 00001BBE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3479 00001BC2 66AB                    	stosw		; original sample (L)
  3480 00001BC4 66AB                    	stosw		; original sample (R)
  3481 00001BC6 88D8                    	mov	al, bl
  3482 00001BC8 00D0                    	add	al, dl	
  3483 00001BCA D0D8                    	rcr	al, 1
  3484 00001BCC 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3485 00001BCE 00D8                    	add	al, bl
  3486 00001BD0 D0D8                    	rcr	al, 1
  3487 00001BD2 2C80                    	sub	al, 80h
  3488 00001BD4 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3489 00001BD8 66AB                    	stosw		; interpolated sample 1 (L)
  3490 00001BDA 66AB                    	stosw		; interpolated sample 1 (R)
  3491 00001BDC 88F8                    	mov	al, bh
  3492 00001BDE 00D0                    	add	al, dl	; [next_val]
  3493 00001BE0 D0D8                    	rcr	al, 1
  3494 00001BE2 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3495 00001BE6 66AB                    	stosw		; interpolated sample 2 (L)
  3496 00001BE8 66AB                    	stosw		; interpolated sample 2 (R)
  3497 00001BEA C3                      	retn
  3498                                  
  3499                                  interpolating_3_8bit_stereo:
  3500                                  	; 16/11/2023
  3501                                  	; al = [previous_val_l]
  3502                                  	; ah = [previous_val_r]
  3503                                  	; dl = [next_val_l]
  3504                                  	; dh = [next_val_r]	
  3505                                  	; original-interpolated-interpolated
  3506 00001BEB 89C3                    	mov	ebx, eax
  3507 00001BED 2C80                    	sub	al, 80h
  3508 00001BEF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3509 00001BF3 66AB                    	stosw		; original sample (L)
  3510 00001BF5 88F8                    	mov	al, bh
  3511 00001BF7 2C80                    	sub	al, 80h
  3512 00001BF9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3513 00001BFD 66AB                    	stosw		; original sample (R)
  3514 00001BFF 88D8                    	mov	al, bl
  3515 00001C01 00D0                    	add	al, dl	; [next_val_l]	
  3516 00001C03 D0D8                    	rcr	al, 1
  3517 00001C05 50                      	push	eax ; *	; al = interpolated middle (L) (temporary)
  3518 00001C06 00D8                    	add	al, bl	; [previous_val_l]
  3519 00001C08 D0D8                    	rcr	al, 1
  3520 00001C0A 2C80                    	sub	al, 80h
  3521 00001C0C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3522 00001C10 66AB                    	stosw		; interpolated sample 1 (L)
  3523 00001C12 88F8                    	mov	al, bh
  3524 00001C14 00F0                    	add	al, dh	; [next_val_r]
  3525 00001C16 D0D8                    	rcr	al, 1
  3526 00001C18 50                      	push	eax ; ** ; al = interpolated middle (R) (temporary)
  3527 00001C19 00F8                    	add	al, bh	; [previous_val_r]
  3528 00001C1B D0D8                    	rcr	al, 1
  3529 00001C1D 2C80                    	sub	al, 80h
  3530 00001C1F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3531 00001C23 66AB                    	stosw		; interpolated sample 1 (R)
  3532 00001C25 5B                      	pop	ebx ; **
  3533 00001C26 58                      	pop	eax ; *
  3534 00001C27 00D0                    	add	al, dl	; [next_val_l]
  3535 00001C29 D0D8                    	rcr	al, 1
  3536 00001C2B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3537 00001C2F 66AB                    	stosw		; interpolated sample 2 (L)
  3538 00001C31 88D8                    	mov	al, bl
  3539 00001C33 00F0                    	add	al, dh	; [next_val_r]
  3540 00001C35 D0D8                    	rcr	al, 1
  3541 00001C37 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3542 00001C3B 66AB                    	stosw		; interpolated sample 2 (R)
  3543 00001C3D C3                      	retn
  3544                                  
  3545                                  interpolating_2_8bit_mono:
  3546                                  	; 16/11/2023
  3547                                  	; al = [previous_val]
  3548                                  	; dl = [next_val]
  3549                                  	; original-interpolated
  3550 00001C3E 88C3                    	mov	bl, al
  3551 00001C40 2C80                    	sub	al, 80h
  3552 00001C42 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3553 00001C46 66AB                    	stosw		; original sample (L)
  3554 00001C48 66AB                    	stosw		; original sample (R)
  3555 00001C4A 88D8                    	mov	al, bl
  3556 00001C4C 00D0                    	add	al, dl	
  3557 00001C4E D0D8                    	rcr	al, 1
  3558 00001C50 2C80                    	sub	al, 80h
  3559 00001C52 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3560 00001C56 66AB                    	stosw		; interpolated sample (L)
  3561 00001C58 66AB                    	stosw		; interpolated sample (R)
  3562 00001C5A C3                      	retn
  3563                                  
  3564                                  interpolating_2_8bit_stereo:
  3565                                  	; 16/11/2023
  3566                                  	; al = [previous_val_l]
  3567                                  	; ah = [previous_val_r]
  3568                                  	; dl = [next_val_l]
  3569                                  	; dh = [next_val_r]	
  3570                                  	; original-interpolated
  3571 00001C5B 89C3                    	mov	ebx, eax
  3572 00001C5D 2C80                    	sub	al, 80h
  3573 00001C5F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3574 00001C63 66AB                    	stosw		; original sample (L)
  3575 00001C65 88F8                    	mov	al, bh
  3576 00001C67 2C80                    	sub	al, 80h
  3577 00001C69 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3578 00001C6D 66AB                    	stosw		; original sample (R)
  3579 00001C6F 88D8                    	mov	al, bl	; [previous_val_l]
  3580 00001C71 00D0                    	add	al, dl	; [next_val_l]	
  3581 00001C73 D0D8                    	rcr	al, 1
  3582 00001C75 2C80                    	sub	al, 80h
  3583 00001C77 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3584 00001C7B 66AB                    	stosw		; interpolated sample (L)
  3585 00001C7D 88F8                    	mov	al, bh
  3586 00001C7F 00F0                    	add	al, dh	; [next_val_r]
  3587 00001C81 D0D8                    	rcr	al, 1
  3588 00001C83 2C80                    	sub	al, 80h
  3589 00001C85 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3590 00001C89 66AB                    	stosw		; interpolated sample (R)
  3591 00001C8B C3                      	retn
  3592                                  
  3593                                  interpolating_3_16bit_mono:
  3594                                  	; 16/11/2023
  3595                                  	; ax = [previous_val]
  3596                                  	; dx = [next_val]
  3597                                  	; original-interpolated-interpolated
  3598                                  
  3599 00001C8C 66AB                    	stosw		; original sample (L)
  3600 00001C8E 66AB                    	stosw		; original sample (R)
  3601 00001C90 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3602 00001C93 50                      	push	eax ; *	; [previous_val]
  3603 00001C94 80C680                  	add	dh, 80h
  3604 00001C97 6601D0                  	add	ax, dx
  3605 00001C9A 66D1D8                  	rcr	ax, 1
  3606 00001C9D 5B                      	pop	ebx ; *		
  3607 00001C9E 93                      	xchg	ebx, eax ; bx  = interpolated middle (temporary)
  3608 00001C9F 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  3609 00001CA2 66D1D8                  	rcr	ax, 1
  3610 00001CA5 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3611 00001CA8 66AB                    	stosw 		; interpolated sample 1 (L)
  3612 00001CAA 66AB                    	stosw		; interpolated sample 1 (R)
  3613 00001CAC 89D8                    	mov	eax, ebx
  3614 00001CAE 6601D0                  	add	ax, dx	 ;interpolated middle + [next_val]
  3615 00001CB1 66D1D8                  	rcr	ax, 1
  3616 00001CB4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3617 00001CB7 66AB                    	stosw		; interpolated sample 2 (L)
  3618 00001CB9 66AB                    	stosw		; interpolated sample 2 (R)
  3619 00001CBB C3                      	retn
  3620                                  
  3621                                  interpolating_3_16bit_stereo:
  3622                                  	; 16/11/2023
  3623                                  	; bx = [previous_val_l]
  3624                                  	; ax = [previous_val_r]
  3625                                  	; [next_val_l]
  3626                                  	; dx = [next_val_r]
  3627                                  	; original-interpolated-interpolated
  3628                                  
  3629 00001CBC 93                      	xchg	eax, ebx
  3630 00001CBD 66AB                    	stosw		; original sample (L)
  3631 00001CBF 93                      	xchg	eax, ebx
  3632 00001CC0 66AB                    	stosw		; original sample (R)
  3633 00001CC2 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3634 00001CC5 50                      	push	eax ; *	; [previous_val_r]
  3635 00001CC6 80C780                  	add	bh, 80h
  3636 00001CC9 8005[05210000]80        	add	byte [next_val_l+1], 80h
  3637 00001CD0 66A1[04210000]          	mov	ax, [next_val_l]
  3638 00001CD6 6601D8                  	add	ax, bx	; [previous_val_l]
  3639 00001CD9 66D1D8                  	rcr	ax, 1
  3640 00001CDC 93                      	xchg	eax, ebx ; ax = [previous_val_l]
  3641 00001CDD 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  3642 00001CE0 66D1D8                  	rcr	ax, 1
  3643 00001CE3 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3644 00001CE6 66AB                    	stosw 		; interpolated sample 1 (L)
  3645 00001CE8 58                      	pop	eax  ; *
  3646 00001CE9 80C680                  	add	dh, 80h ; convert sound level 0 to 65535 format
  3647 00001CEC 52                      	push	edx  ; * ; [next_val_r]
  3648 00001CED 92                      	xchg	eax, edx
  3649 00001CEE 6601D0                  	add	ax, dx	; [next_val_r] + [previous_val_r]
  3650 00001CF1 66D1D8                  	rcr	ax, 1	; / 2
  3651 00001CF4 50                      	push	eax ; ** ; interpolated middle (R)
  3652 00001CF5 6601D0                  	add	ax, dx	; + [previous_val_r]
  3653 00001CF8 66D1D8                  	rcr	ax, 1
  3654 00001CFB 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3655 00001CFE 66AB                    	stosw 		; interpolated sample 1 (R)
  3656 00001D00 66A1[04210000]          	mov	ax, [next_val_l]
  3657 00001D06 6601D8                  	add	ax, bx	; + interpolated middle (L)
  3658 00001D09 66D1D8                  	rcr	ax, 1
  3659 00001D0C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3660 00001D0F 66AB                    	stosw 		; interpolated sample 2 (L)
  3661 00001D11 58                      	pop	eax ; **
  3662 00001D12 5A                      	pop	edx ; *	
  3663 00001D13 6601D0                  	add	ax, dx	; interpolated middle + [next_val_r]
  3664 00001D16 66D1D8                  	rcr	ax, 1	; / 2
  3665 00001D19 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3666 00001D1C 66AB                    	stosw 		; interpolated sample 2 (L)
  3667 00001D1E C3                      	retn
  3668                                  
  3669                                  interpolating_2_16bit_mono:
  3670                                  	; 16/11/2023
  3671                                  	; ax = [previous_val]
  3672                                  	; dx = [next_val]
  3673                                  	; original-interpolated
  3674                                  
  3675 00001D1F 66AB                    	stosw		; original sample (L)
  3676 00001D21 66AB                    	stosw		; original sample (R)
  3677 00001D23 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3678 00001D26 80C680                  	add	dh, 80h
  3679 00001D29 6601D0                  	add	ax, dx
  3680 00001D2C 66D1D8                  	rcr	ax, 1
  3681 00001D2F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3682 00001D32 66AB                    	stosw		; interpolated sample (L)
  3683 00001D34 66AB                    	stosw		; interpolated sample (R)
  3684 00001D36 C3                      	retn
  3685                                  
  3686                                  interpolating_2_16bit_stereo:
  3687                                  	; 16/11/2023
  3688                                  	; bx = [previous_val_l]
  3689                                  	; ax = [previous_val_r]
  3690                                  	; [next_val_l]
  3691                                  	; dx = [next_val_r]
  3692                                  	; original-interpolated
  3693                                  
  3694 00001D37 93                      	xchg	eax, ebx
  3695 00001D38 66AB                    	stosw		; original sample (L)
  3696 00001D3A 93                      	xchg	eax, ebx
  3697 00001D3B 66AB                    	stosw		; original sample (R)
  3698 00001D3D 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3699 00001D40 80C680                  	add	dh, 80h
  3700 00001D43 6601D0                  	add	ax, dx	; [previous_val_r] + [next_val_r]
  3701 00001D46 66D1D8                  	rcr	ax, 1	; / 2
  3702 00001D49 50                      	push	eax ; *	; interpolated sample (R)
  3703 00001D4A 66A1[04210000]          	mov	ax, [next_val_l]
  3704 00001D50 80C480                  	add	ah, 80h
  3705 00001D53 80C780                  	add	bh, 80h
  3706 00001D56 6601D8                  	add	ax, bx	; [next_val_l] + [previous_val_l]
  3707 00001D59 66D1D8                  	rcr	ax, 1	; / 2		
  3708 00001D5C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3709 00001D5F 66AB                    	stosw 		; interpolated sample (L)
  3710 00001D61 58                      	pop	eax ; *	
  3711 00001D62 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3712 00001D65 66AB                    	stosw 		; interpolated sample (R)
  3713 00001D67 C3                      	retn
  3714                                  
  3715                                  interpolating_5_8bit_mono:
  3716                                  	; 17/11/2023
  3717                                  	; al = [previous_val]
  3718                                  	; dl = [next_val]
  3719                                  	; original-interpltd-interpltd-interpltd-interpltd
  3720 00001D68 88C3                    	mov	bl, al
  3721 00001D6A 2C80                    	sub	al, 80h
  3722 00001D6C 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3723 00001D70 66AB                    	stosw		; original sample (L)
  3724 00001D72 66AB                    	stosw		; original sample (R)
  3725 00001D74 88D8                    	mov	al, bl
  3726 00001D76 00D0                    	add	al, dl	
  3727 00001D78 D0D8                    	rcr	al, 1
  3728 00001D7A 88C7                    	mov	bh, al	; interpolated middle (temporary)
  3729 00001D7C 00D8                    	add	al, bl  ; [previous_val]
  3730 00001D7E D0D8                    	rcr	al, 1 	
  3731 00001D80 88C6                    	mov	dh, al	; interpolated 1st quarter (temporary)
  3732 00001D82 00D8                    	add	al, bl
  3733 00001D84 D0D8                    	rcr	al, 1
  3734 00001D86 2C80                    	sub	al, 80h
  3735 00001D88 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3736 00001D8C 66AB                    	stosw		; interpolated sample 1 (L)
  3737 00001D8E 66AB                    	stosw		; interpolated sample 1 (R)
  3738 00001D90 88F8                    	mov	al, bh
  3739 00001D92 00F0                    	add	al, dh
  3740 00001D94 D0D8                    	rcr	al, 1
  3741 00001D96 2C80                    	sub	al, 80h
  3742 00001D98 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3743 00001D9C 66AB                    	stosw		; interpolated sample 2 (L)
  3744 00001D9E 66AB                    	stosw		; interpolated sample 2 (R)
  3745 00001DA0 88F8                    	mov	al, bh
  3746 00001DA2 00D0                    	add	al, dl	; [next_val]
  3747 00001DA4 D0D8                    	rcr	al, 1
  3748 00001DA6 88C6                    	mov	dh, al	; interpolated 3rd quarter (temporary)
  3749 00001DA8 00F8                    	add	al, bh
  3750 00001DAA D0D8                    	rcr	al, 1
  3751 00001DAC 2C80                    	sub	al, 80h
  3752 00001DAE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3753 00001DB2 66AB                    	stosw		; interpolated sample 3 (L)
  3754 00001DB4 66AB                    	stosw		; interpolated sample 3 (R)
  3755 00001DB6 88F0                    	mov	al, dh
  3756 00001DB8 00D0                    	add	al, dl
  3757 00001DBA D0D8                    	rcr	al, 1
  3758 00001DBC 2C80                    	sub	al, 80h
  3759 00001DBE 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3760 00001DC2 66AB                    	stosw		; interpolated sample 4 (L)
  3761 00001DC4 66AB                    	stosw		; interpolated sample 4 (R)
  3762 00001DC6 C3                      	retn
  3763                                  
  3764                                  interpolating_5_8bit_stereo:
  3765                                  	; 17/11/2023
  3766                                  	; al = [previous_val_l]
  3767                                  	; ah = [previous_val_r]
  3768                                  	; dl = [next_val_l]
  3769                                  	; dh = [next_val_r]	
  3770                                  	; original-interpltd-interpltd-interpltd-interpltd
  3771 00001DC7 89C3                    	mov	ebx, eax
  3772 00001DC9 2C80                    	sub	al, 80h
  3773 00001DCB 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3774 00001DCF 66AB                    	stosw		; original sample (L)
  3775 00001DD1 88F8                    	mov	al, bh
  3776 00001DD3 2C80                    	sub	al, 80h
  3777 00001DD5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3778 00001DD9 66AB                    	stosw		; original sample (R)
  3779 00001DDB 52                      	push	edx ; *
  3780 00001DDC 88D8                    	mov	al, bl
  3781 00001DDE 00D0                    	add	al, dl	; [next_val_l]
  3782 00001DE0 D0D8                    	rcr	al, 1
  3783 00001DE2 50                      	push	eax ; **	; al = interpolated middle (L) (temporary)
  3784 00001DE3 00D8                    	add	al, bl	; [previous_val_l]
  3785 00001DE5 D0D8                    	rcr	al, 1
  3786 00001DE7 86C3                    	xchg	al, bl	
  3787 00001DE9 00D8                    	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  3788 00001DEB D0D8                    	rcr	al, 1
  3789 00001DED 2C80                    	sub	al, 80h
  3790 00001DEF 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3791 00001DF3 66AB                    	stosw		; interpolated sample 1 (L)
  3792 00001DF5 88F8                    	mov	al, bh
  3793 00001DF7 00F0                    	add	al, dh	; [next_val_r]
  3794 00001DF9 D0D8                    	rcr	al, 1
  3795 00001DFB 50                      	push	eax ; *** ; al = interpolated middle (R) (temporary)
  3796 00001DFC 00F8                    	add	al, bh	; [previous_val_r]
  3797 00001DFE D0D8                    	rcr	al, 1
  3798 00001E00 86C7                    	xchg	al, bh	
  3799 00001E02 00F8                    	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  3800 00001E04 D0D8                    	rcr	al, 1
  3801 00001E06 2C80                    	sub	al, 80h
  3802 00001E08 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3803 00001E0C 66AB                    	stosw		; interpolated sample 1 (R)
  3804 00001E0E 5A                      	pop	edx ; ***
  3805 00001E0F 58                      	pop	eax ; **	; al = interpolated middle (L) (temporary)
  3806 00001E10 86C3                    	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  3807 00001E12 00D8                    	add	al, bl	; bl = interpolated middle (L) (temporary)
  3808 00001E14 D0D8                    	rcr	al, 1
  3809 00001E16 2C80                    	sub	al, 80h
  3810 00001E18 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3811 00001E1C 66AB                    	stosw		; interpolated sample 2 (L)	
  3812 00001E1E 88D0                    	mov	al, dl 	; interpolated middle (R) (temporary)
  3813 00001E20 86C7                    	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  3814 00001E22 00F8                    	add	al, bh	; bh = interpolated middle (R) (temporary)
  3815 00001E24 D0D8                    	rcr	al, 1
  3816 00001E26 2C80                    	sub	al, 80h
  3817 00001E28 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3818 00001E2C 66AB                    	stosw		; interpolated sample 2 (R)
  3819 00001E2E 5A                      	pop	edx ; *
  3820 00001E2F 88D8                    	mov	al, bl	; interpolated middle (L) (temporary)
  3821 00001E31 00D0                    	add	al, dl	; [next_val_l]
  3822 00001E33 D0D8                    	rcr	al, 1
  3823 00001E35 86C3                    	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  3824 00001E37 00D8                    	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  3825 00001E39 D0D8                    	rcr	al, 1
  3826 00001E3B 2C80                    	sub	al, 80h
  3827 00001E3D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3828 00001E41 66AB                    	stosw		; interpolated sample 3 (L)
  3829 00001E43 88F8                    	mov	al, bh	
  3830 00001E45 00F0                    	add	al, dh	; interpolated middle (R) + [next_val_r]
  3831 00001E47 D0D8                    	rcr	al, 1
  3832 00001E49 86C7                    	xchg	al, bh	; al = interpolated middle (R)
  3833 00001E4B 00F8                    	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  3834 00001E4D D0D8                    	rcr	al, 1
  3835 00001E4F 2C80                    	sub	al, 80h
  3836 00001E51 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3837 00001E55 66AB                    	stosw		; interpolated sample 3 (R)
  3838 00001E57 88D8                    	mov	al, bl
  3839 00001E59 00D0                    	add	al, dl	; [next_val_l]
  3840 00001E5B D0D8                    	rcr	al, 1
  3841 00001E5D 2C80                    	sub	al, 80h
  3842 00001E5F 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3843 00001E63 66AB                    	stosw		; interpolated sample 4 (L)
  3844 00001E65 88F8                    	mov	al, bh
  3845 00001E67 00F0                    	add	al, dh	; [next_val_r]
  3846 00001E69 D0D8                    	rcr	al, 1
  3847 00001E6B 2C80                    	sub	al, 80h
  3848 00001E6D 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3849 00001E71 66AB                    	stosw		; interpolated sample 4 (R)
  3850 00001E73 C3                      	retn
  3851                                  
  3852                                  interpolating_4_8bit_mono:
  3853                                  	; 17/11/2023
  3854                                  	; al = [previous_val]
  3855                                  	; dl = [next_val]
  3856                                  	; original-interpolated-interpolated-interpolated
  3857 00001E74 88C3                    	mov	bl, al
  3858 00001E76 2C80                    	sub	al, 80h
  3859 00001E78 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3860 00001E7C 66AB                    	stosw		; original sample (L)
  3861 00001E7E 66AB                    	stosw		; original sample (R)
  3862 00001E80 88D8                    	mov	al, bl
  3863 00001E82 00D0                    	add	al, dl	
  3864 00001E84 D0D8                    	rcr	al, 1
  3865 00001E86 86C3                    	xchg	al, bl  ; al = [previous_val]
  3866 00001E88 00D8                    	add	al, bl	; bl = interpolated middle (sample 2)
  3867 00001E8A D0D8                    	rcr	al, 1 	
  3868 00001E8C 2C80                    	sub	al, 80h
  3869 00001E8E 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3870 00001E92 66AB                    	stosw		; interpolated sample 1 (L)
  3871 00001E94 66AB                    	stosw		; interpolated sample 1 (R)
  3872 00001E96 88D8                    	mov	al, bl	; interpolated middle (sample 2)
  3873 00001E98 2C80                    	sub	al, 80h
  3874 00001E9A 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3875 00001E9E 66AB                    	stosw		; interpolated sample 2 (L)
  3876 00001EA0 66AB                    	stosw		; interpolated sample 2 (R)
  3877 00001EA2 88D8                    	mov	al, bl
  3878 00001EA4 00D0                    	add	al, dl	; [next_val]
  3879 00001EA6 D0D8                    	rcr	al, 1
  3880 00001EA8 2C80                    	sub	al, 80h
  3881 00001EAA 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3882 00001EAE 66AB                    	stosw		; interpolated sample 3 (L)
  3883 00001EB0 66AB                    	stosw		; interpolated sample 3 (R)
  3884 00001EB2 C3                      	retn
  3885                                  
  3886                                  interpolating_4_8bit_stereo:
  3887                                  	; 17/11/2023
  3888                                  	; al = [previous_val_l]
  3889                                  	; ah = [previous_val_r]
  3890                                  	; dl = [next_val_l]
  3891                                  	; dh = [next_val_r]	
  3892                                  	; original-interpolated-interpolated-interpolated
  3893 00001EB3 89C3                    	mov	ebx, eax
  3894 00001EB5 2C80                    	sub	al, 80h
  3895 00001EB7 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3896 00001EBB 66AB                    	stosw		; original sample (L)
  3897 00001EBD 88F8                    	mov	al, bh
  3898 00001EBF 2C80                    	sub	al, 80h
  3899 00001EC1 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3900 00001EC5 66AB                    	stosw		; original sample (R)
  3901 00001EC7 88D8                    	mov	al, bl
  3902 00001EC9 00D0                    	add	al, dl	; [next_val_l]
  3903 00001ECB D0D8                    	rcr	al, 1
  3904 00001ECD 86C3                    	xchg	al, bl	; al = [previous_val_l]
  3905 00001ECF 00D8                    	add	al, bl	; bl = interpolated middle (L) (sample 2)
  3906 00001ED1 D0D8                    	rcr	al, 1
  3907 00001ED3 2C80                    	sub	al, 80h
  3908 00001ED5 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3909 00001ED9 66AB                    	stosw		; interpolated sample 1 (L)
  3910 00001EDB 88F8                    	mov	al, bh
  3911 00001EDD 00F0                    	add	al, dh	; [next_val_r]
  3912 00001EDF D0D8                    	rcr	al, 1
  3913 00001EE1 86C7                    	xchg	al, bh	; al = [previous_val_h]
  3914 00001EE3 00F8                    	add	al, bh	; bh = interpolated middle (R) (sample 2)
  3915 00001EE5 D0D8                    	rcr	al, 1
  3916 00001EE7 2C80                    	sub	al, 80h
  3917 00001EE9 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3918 00001EED 66AB                    	stosw		; interpolated sample 1 (R)
  3919 00001EEF 88D8                    	mov	al, bl	; interpolated middle (L) (sample 2)
  3920 00001EF1 2C80                    	sub	al, 80h
  3921 00001EF3 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3922 00001EF7 66AB                    	stosw		; interpolated sample 2 (L)
  3923 00001EF9 88F8                    	mov	al, bh	; interpolated middle (L) (sample 2)
  3924 00001EFB 2C80                    	sub	al, 80h
  3925 00001EFD 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3926 00001F01 66AB                    	stosw		; interpolated sample 2 (L)
  3927 00001F03 88D8                    	mov	al, bl
  3928 00001F05 00D0                    	add	al, dl	; [next_val_l]
  3929 00001F07 D0D8                    	rcr	al, 1
  3930 00001F09 2C80                    	sub	al, 80h
  3931 00001F0B 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3932 00001F0F 66AB                    	stosw		; interpolated sample 3 (L)
  3933 00001F11 88F8                    	mov	al, bh
  3934 00001F13 00F0                    	add	al, dh	; [next_val_r]
  3935 00001F15 D0D8                    	rcr	al, 1
  3936 00001F17 2C80                    	sub	al, 80h
  3937 00001F19 66C1E008                	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3938 00001F1D 66AB                    	stosw		; interpolated sample 3 (R)
  3939 00001F1F C3                      	retn
  3940                                  
  3941                                  interpolating_5_16bit_mono:
  3942                                  	; 18/11/2023
  3943                                  	; ax = [previous_val]
  3944                                  	; dx = [next_val]
  3945                                  	; original-interpltd-interpltd-interpltd-interpltd
  3946 00001F20 66AB                    	stosw		; original sample (L)
  3947 00001F22 66AB                    	stosw		; original sample (R)
  3948 00001F24 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3949 00001F27 89C3                    	mov	ebx, eax ; [previous_val]
  3950 00001F29 80C680                  	add	dh, 80h
  3951 00001F2C 6601D0                  	add	ax, dx
  3952 00001F2F 66D1D8                  	rcr	ax, 1
  3953 00001F32 50                      	push	eax ; *	; interpolated middle (temporary)
  3954 00001F33 6601D8                  	add	ax, bx	; interpolated middle + [previous_val] 
  3955 00001F36 66D1D8                  	rcr	ax, 1
  3956 00001F39 50                      	push	eax ; **	; interpolated 1st quarter (temporary)
  3957 00001F3A 6601D8                  	add	ax, bx	; 1st quarter + [previous_val]
  3958 00001F3D 66D1D8                  	rcr	ax, 1	
  3959 00001F40 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3960 00001F43 66AB                    	stosw 		; interpolated sample 1 (L)
  3961 00001F45 66AB                    	stosw		; interpolated sample 1 (R)
  3962 00001F47 58                      	pop	eax ; **	
  3963 00001F48 5B                      	pop	ebx ; *
  3964 00001F49 6601D8                  	add	ax, bx	; 1st quarter + middle
  3965 00001F4C 66D1D8                  	rcr	ax, 1	; / 2
  3966 00001F4F 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again	
  3967 00001F52 66AB                    	stosw		; interpolated sample 2 (L)
  3968 00001F54 66AB                    	stosw		; interpolated sample 2 (R)		
  3969 00001F56 89D8                    	mov	eax, ebx
  3970 00001F58 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  3971 00001F5B 66D1D8                  	rcr	ax, 1
  3972 00001F5E 50                      	push	eax ; *	; interpolated 3rd quarter (temporary)
  3973 00001F5F 6601D8                  	add	ax, bx	; + interpolated middle
  3974 00001F62 66D1D8                  	rcr	ax, 1
  3975 00001F65 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3976 00001F68 66AB                    	stosw		; interpolated sample 3 (L)
  3977 00001F6A 66AB                    	stosw		; interpolated sample 3 (R)
  3978 00001F6C 58                      	pop	eax ; *	
  3979 00001F6D 6601D0                  	add	ax, dx	; 3rd quarter + [next_val]
  3980 00001F70 66D1D8                  	rcr	ax, 1	; / 2
  3981 00001F73 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  3982 00001F76 66AB                    	stosw		; interpolated sample 4 (L)
  3983 00001F78 66AB                    	stosw		; interpolated sample 4 (R)
  3984 00001F7A C3                      	retn
  3985                                  
  3986                                  interpolating_5_16bit_stereo:
  3987                                  	; 18/11/2023
  3988                                  	; bx = [previous_val_l]
  3989                                  	; ax = [previous_val_r]
  3990                                  	; [next_val_l]
  3991                                  	; [next_val_r]
  3992                                  	; original-interpltd-interpltd-interpltd-interpltd
  3993 00001F7B 51                      	push	ecx ; !
  3994 00001F7C 93                      	xchg	eax, ebx
  3995 00001F7D 66AB                    	stosw		; original sample (L)
  3996 00001F7F 93                      	xchg	eax, ebx
  3997 00001F80 66AB                    	stosw		; original sample (R)
  3998 00001F82 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  3999 00001F85 50                      	push	eax ; *	; [previous_val_r]
  4000 00001F86 80C780                  	add	bh, 80h
  4001 00001F89 8005[05210000]80        	add	byte [next_val_l+1], 80h
  4002 00001F90 66A1[04210000]          	mov	ax, [next_val_l]
  4003 00001F96 6601D8                  	add	ax, bx	; [previous_val_l]
  4004 00001F99 66D1D8                  	rcr	ax, 1
  4005 00001F9C 89C1                    	mov	ecx, eax ; interpolated middle (L)
  4006 00001F9E 6601D8                  	add	ax, bx	
  4007 00001FA1 66D1D8                  	rcr	ax, 1
  4008 00001FA4 89C2                    	mov	edx, eax ; interpolated 1st quarter (L)	
  4009 00001FA6 6601D8                  	add	ax, bx	; [previous_val_l]
  4010 00001FA9 66D1D8                  	rcr	ax, 1
  4011 00001FAC 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4012 00001FAF 66AB                    	stosw 		; interpolated sample 1 (L)
  4013 00001FB1 89C8                    	mov	eax, ecx
  4014 00001FB3 6601D0                  	add	ax, dx	; middle (L) + 1st quarter (L) 
  4015 00001FB6 66D1D8                  	rcr	ax, 1	; / 2
  4016 00001FB9 89C3                    	mov	ebx, eax  ; interpolated sample 2 (L)
  4017 00001FBB 5A                      	pop	edx ; *	; [previous_val_r]
  4018 00001FBC 89D0                    	mov	eax, edx
  4019 00001FBE 8005[07210000]80        	add	byte [next_val_r+1], 80h
  4020 00001FC5 660305[06210000]        	add	ax, [next_val_r]
  4021 00001FCC 66D1D8                  	rcr	ax, 1
  4022 00001FCF 50                      	push	eax ; *	; interpolated middle (R)
  4023 00001FD0 6601D0                  	add	ax, dx
  4024 00001FD3 66D1D8                  	rcr	ax, 1
  4025 00001FD6 50                      	push	eax ; ** ; interpolated 1st quarter (R)
  4026 00001FD7 6601D0                  	add	ax, dx	; [previous_val_r]
  4027 00001FDA 66D1D8                  	rcr	ax, 1
  4028 00001FDD 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4029 00001FE0 66AB                    	stosw 		; interpolated sample 1 (R)
  4030 00001FE2 89D8                    	mov	eax, ebx
  4031 00001FE4 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4032 00001FE7 66AB                    	stosw 		; interpolated sample 2 (L)
  4033 00001FE9 58                      	pop	eax ; **
  4034 00001FEA 5A                      	pop	edx ; *
  4035 00001FEB 6601D0                  	add	ax, dx	; 1st quarter (R) + middle (R)
  4036 00001FEE 66D1D8                  	rcr	ax, 1	; / 2
  4037 00001FF1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4038 00001FF4 66AB                    	stosw 		; interpolated sample 2 (R)
  4039 00001FF6 89C8                    	mov	eax, ecx
  4040 00001FF8 660305[04210000]        	add	ax, [next_val_l]
  4041 00001FFF 66D1D8                  	rcr	ax, 1
  4042 00002002 50                      	push	eax ; * ; interpolated 3rd quarter (L)
  4043 00002003 6601C8                  	add	ax, cx	; interpolated middle (L)
  4044 00002006 66D1D8                  	rcr	ax, 1
  4045 00002009 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4046 0000200C 66AB                    	stosw 		; interpolated sample 3 (L)
  4047 0000200E 89D0                    	mov	eax, edx
  4048 00002010 660305[06210000]        	add	ax, [next_val_r]
  4049 00002017 66D1D8                  	rcr	ax, 1
  4050 0000201A 50                      	push	eax ; ** ; interpolated 3rd quarter (R)
  4051 0000201B 6601D0                  	add	ax, dx	; interpolated middle (R)
  4052 0000201E 66D1D8                  	rcr	ax, 1
  4053 00002021 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4054 00002024 66AB                    	stosw 		; interpolated sample 3 (R)
  4055 00002026 5B                      	pop	ebx ; **
  4056 00002027 58                      	pop	eax ; *
  4057 00002028 660305[04210000]        	add	ax, [next_val_l]
  4058 0000202F 66D1D8                  	rcr	ax, 1
  4059 00002032 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4060 00002035 66AB                    	stosw 		; interpolated sample 4 (L)
  4061 00002037 89D8                    	mov	eax, ebx	
  4062 00002039 660305[06210000]        	add	ax, [next_val_r]
  4063 00002040 66D1D8                  	rcr	ax, 1
  4064 00002043 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4065 00002046 66AB                    	stosw 		; interpolated sample 4 (R)
  4066 00002048 59                      	pop	ecx ; !
  4067 00002049 C3                      	retn
  4068                                  
  4069                                  interpolating_4_16bit_mono:
  4070                                  	; 18/11/2023
  4071                                  	; ax = [previous_val]
  4072                                  	; dx = [next_val]
  4073                                  	; original-interpolated
  4074                                  
  4075 0000204A 66AB                    	stosw		; original sample (L)
  4076 0000204C 66AB                    	stosw		; original sample (R)
  4077 0000204E 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4078 00002051 89C3                    	mov	ebx, eax ; [previous_val]
  4079 00002053 80C680                  	add	dh, 80h
  4080 00002056 6601D0                  	add	ax, dx	; [previous_val] + [next_val]
  4081 00002059 66D1D8                  	rcr	ax, 1
  4082 0000205C 93                      	xchg	eax, ebx	
  4083 0000205D 6601D8                  	add	ax, bx	; [previous_val] + interpolated middle
  4084 00002060 66D1D8                  	rcr	ax, 1
  4085 00002063 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4086 00002066 66AB                    	stosw 		; interpolated sample 1 (L)
  4087 00002068 66AB                    	stosw		; interpolated sample 1 (R)
  4088 0000206A 89D8                    	mov	eax, ebx ; interpolated middle
  4089 0000206C 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4090 0000206F 66AB                    	stosw 		; interpolated sample 2 (L)
  4091 00002071 66AB                    	stosw		; interpolated sample 2 (R)
  4092 00002073 89D8                    	mov	eax, ebx
  4093 00002075 6601D0                  	add	ax, dx	; interpolated middle + [next_val]
  4094 00002078 66D1D8                  	rcr	ax, 1
  4095 0000207B 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4096 0000207E 66AB                    	stosw		; interpolated sample 3 (L)
  4097 00002080 66AB                    	stosw		; interpolated sample 3 (R)
  4098 00002082 C3                      	retn
  4099                                  
  4100                                  interpolating_4_16bit_stereo:
  4101                                  	; 18/11/2023
  4102                                  	; bx = [previous_val_l]
  4103                                  	; ax = [previous_val_r]
  4104                                  	; [next_val_l]
  4105                                  	; [next_val_r]
  4106                                  	; original-interpolated-interpolated-interpolated
  4107 00002083 93                      	xchg	eax, ebx
  4108 00002084 66AB                    	stosw		; original sample (L)
  4109 00002086 93                      	xchg	eax, ebx
  4110 00002087 66AB                    	stosw		; original sample (R)
  4111 00002089 80C480                  	add	ah, 80h ; convert sound level 0 to 65535 format
  4112 0000208C 89C2                    	mov	edx, eax ; [previous_val_r]
  4113 0000208E 80C780                  	add	bh, 80h
  4114 00002091 8005[05210000]80        	add	byte [next_val_l+1], 80h
  4115 00002098 66A1[04210000]          	mov	ax, [next_val_l]
  4116 0000209E 6601D8                  	add	ax, bx	; [previous_val_l]
  4117 000020A1 66D1D8                  	rcr	ax, 1
  4118 000020A4 93                      	xchg	eax, ebx	
  4119 000020A5 6601D8                  	add	ax, bx	; bx = interpolated middle (L)
  4120 000020A8 66D1D8                  	rcr	ax, 1
  4121 000020AB 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4122 000020AE 66AB                    	stosw 		; interpolated sample 1 (L)
  4123 000020B0 8005[07210000]80        	add	byte [next_val_r+1], 80h
  4124 000020B7 89D0                    	mov	eax, edx ; [previous_val_r]
  4125 000020B9 660305[06210000]        	add	ax, [next_val_r]
  4126 000020C0 66D1D8                  	rcr	ax, 1
  4127 000020C3 92                      	xchg	eax, edx	
  4128 000020C4 6601D0                  	add	ax, dx	; dx = interpolated middle (R)
  4129 000020C7 66D1D8                  	rcr	ax, 1
  4130 000020CA 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4131 000020CD 66AB                    	stosw 		; interpolated sample 1 (R)
  4132 000020CF 89D8                    	mov	eax, ebx
  4133 000020D1 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4134 000020D4 66AB                    	stosw 		; interpolated sample 2 (L)
  4135 000020D6 89D0                    	mov	eax, edx
  4136 000020D8 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4137 000020DB 66AB                    	stosw 		; interpolated sample 2 (R)
  4138 000020DD 89D8                    	mov	eax, ebx
  4139 000020DF 660305[04210000]        	add	ax, [next_val_l]
  4140 000020E6 66D1D8                  	rcr	ax, 1
  4141 000020E9 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4142 000020EC 66AB                    	stosw 		; interpolated sample 3 (L)
  4143 000020EE 89D0                    	mov	eax, edx
  4144 000020F0 660305[06210000]        	add	ax, [next_val_r]
  4145 000020F7 66D1D8                  	rcr	ax, 1
  4146 000020FA 80EC80                  	sub	ah, 80h	; -32768 to +32767 format again
  4147 000020FD 66AB                    	stosw 		; interpolated sample 3 (R)
  4148 000020FF C3                      	retn
  4149                                  
  4150                                  ; 13/11/2023
  4151                                  previous_val:
  4152 00002100 0000                    previous_val_l: dw 0
  4153 00002102 0000                    previous_val_r: dw 0
  4154                                  next_val:
  4155 00002104 0000                    next_val_l: dw 0
  4156 00002106 0000                    next_val_r: dw 0
  4157                                  
  4158                                  ; 16/11/2023
  4159 00002108 00                      faz:	db 0	
  4160                                  	
  4161                                  ; --------------------------------------------------------
  4162                                  
  4163                                  ; DATA
  4164                                  
  4165                                  FileHandle:	
  4166 00002109 FFFFFFFF                	dd	-1
  4167                                  
  4168                                  Credits:
  4169 0000210D 54696E792057415620-     	db	'Tiny WAV Player for TRDOS 386 by Erdogan Tan. '
  4169 00002116 506C6179657220666F-
  4169 0000211F 72205452444F532033-
  4169 00002128 383620627920457264-
  4169 00002131 6F67616E2054616E2E-
  4169 0000213A 20                 
  4170                                  	;;db	'August 2020.',10,13,0
  4171                                  	;db	'November 2023.',10,13,0
  4172 0000213B 4A756E652032303234-     	db	'June 2024.', 10,13,0
  4172 00002144 2E0A0D00           
  4173 00002148 31372F30362F323031-     	db	'17/06/2017', 10,13,0
  4173 00002151 370A0D00           
  4174 00002155 31382F30382F323032-     	db	'18/08/2020', 10,13,0
  4174 0000215E 300A0D00           
  4175 00002162 32372F31312F323032-     	db	'27/11/2023', 10,13,0
  4175 0000216B 330A0D00           
  4176 0000216F 30312F30362F323032-     	db	'01/06/2024', 10,13,0
  4176 00002178 340A0D00           
  4177 0000217C 30362F30362F323032-     	db	'06/06/2024', 10,13,0
  4177 00002185 340A0D00           
  4178                                  
  4179                                  msgAudioCardInfo:
  4180 00002189 666F7220496E74656C-     	db 	'for Intel AC97 (ICH) Audio Controller.', 10,13,0
  4180 00002192 204143393720284943-
  4180 0000219B 482920417564696F20-
  4180 000021A4 436F6E74726F6C6C65-
  4180 000021AD 722E0A0D00         
  4181                                  
  4182                                  msg_usage:
  4183 000021B2 75736167653A20706C-     	db	'usage: playwav6 filename.wav',10,13,0
  4183 000021BB 617977617636206669-
  4183 000021C4 6C656E616D652E7761-
  4183 000021CD 760A0D00           
  4184                                  
  4185                                  noDevMsg:
  4186 000021D1 4572726F723A20556E-     	db	'Error: Unable to find AC97 audio device!'
  4186 000021DA 61626C6520746F2066-
  4186 000021E3 696E64204143393720-
  4186 000021EC 617564696F20646576-
  4186 000021F5 69636521           
  4187 000021F9 0A0D00                  	db	10,13,0
  4188                                  
  4189                                  noFileErrMsg:
  4190 000021FC 4572726F723A206669-     	db	'Error: file not found.',10,13,0
  4190 00002205 6C65206E6F7420666F-
  4190 0000220E 756E642E0A0D00     
  4191                                  
  4192                                  trdos386_err_msg:
  4193 00002215 5452444F5320333836-     	db	'TRDOS 386 System call error !',10,13,0
  4193 0000221E 2053797374656D2063-
  4193 00002227 616C6C206572726F72-
  4193 00002230 20210A0D00         
  4194                                  
  4195                                  ; 01/06/2024
  4196                                  msg_init_err:
  4197 00002235 0A0D                    	db	10,13
  4198 00002237 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  4198 00002240 726F6C6C65722F436F-
  4198 00002249 64656320696E697469-
  4198 00002252 616C697A6174696F6E-
  4198 0000225B 206572726F722021   
  4199 00002263 0A0D00                  	db	10,13,0
  4200                                  
  4201                                  ; 25/11/2023
  4202                                  msg_no_vra:
  4203 00002266 0A0D                    	db	10,13
  4204 00002268 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  4204 00002271 70706F72742021204F-
  4204 0000227A 6E6C79203438206B48-
  4204 00002283 5A2073616D706C6520-
  4204 0000228C 726174652073757070-
  4204 00002295 6F727465642021     
  4205 0000229C 0A0D00                  	db	10,13,0
  4206                                  
  4207 0000229F 0D0A5741562046696C-     msgWavFileName:	db 0Dh, 0Ah, "WAV File Name: ",0
  4207 000022A8 65204E616D653A2000 
  4208 000022B1 0D0A53616D706C6520-     msgSampleRate:	db 0Dh, 0Ah, "Sample Rate: "
  4208 000022BA 526174653A20       
  4209 000022C0 303030303020487A2C-     msgHertz:	db "00000 Hz, ", 0 
  4209 000022C9 2000               
  4210 000022CB 3820626974732C2000      msg8Bits:	db "8 bits, ", 0 
  4211 000022D4 4D6F6E6F0D0A00          msgMono:	db "Mono", 0Dh, 0Ah, 0
  4212 000022DB 313620626974732C20-     msg16Bits:	db "16 bits, ", 0 
  4212 000022E4 00                 
  4213 000022E5 53746572656F            msgStereo:	db "Stereo"
  4214 000022EB 0D0A00                  nextline:	db 0Dh, 0Ah, 0
  4215                                  
  4216                                  ; 03/06/2017
  4217 000022EE 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  4217 000022F7 3941424344454600   
  4218 000022FF 0D0A                    msgAC97Info	db 0Dh, 0Ah
  4219 00002301 414339372041756469-     		db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  4219 0000230A 6F20436F6E74726F6C-
  4219 00002313 6C6572202620436F64-
  4219 0000231C 656320496E666F0D0A 
  4220 00002325 56656E646F72204944-     		db "Vendor ID: "
  4220 0000232E 3A20               
  4221 00002330 303030306820446576-     msgVendorId	db "0000h Device ID: "
  4221 00002339 6963652049443A20   
  4222 00002341 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  4223 00002348 4275733A20              		db "Bus: "
  4224 0000234D 303068204465766963-     msgBusNo	db "00h Device: "
  4224 00002356 653A20             
  4225 00002359 3030682046756E6374-     msgDevNo	db "00h Function: "
  4225 00002362 696F6E3A20         
  4226 00002367 303068                  msgFncNo	db "00h"
  4227 0000236A 0D0A                    		db 0Dh, 0Ah
  4228 0000236C 4E414D4241523A20        		db "NAMBAR: "
  4229 00002374 30303030682020          msgNamBar	db "0000h  "
  4230 0000237B 4E41424D4241523A20      		db "NABMBAR: "
  4231 00002384 303030306820204952-     msgNabmBar	db "0000h  IRQ: "
  4231 0000238D 513A20             
  4232 00002390 3030                    msgIRQ		dw 3030h
  4233 00002392 0D0A00                  		db 0Dh, 0Ah, 0
  4234                                  ; 06/06/2024
  4235 00002395 0D0A                    msgCodec	db 0Dh, 0Ah
  4236 00002397 434F44454320            		db "CODEC "
  4237 0000239D 0D0A                    		db 0Dh, 0Ah
  4238 0000239F 56656E646F72204944-     		db "Vendor ID1: "
  4238 000023A8 313A20             
  4239 000023AB 30303030682020          msgCodecId1	db "0000h  "
  4240 000023B2 56656E646F72204944-     		db "Vendor ID2: "
  4240 000023BB 323A20             
  4241 000023BE 30303030682020          msgCodecId2	db "0000h  "  
  4242                                  ; 25/11/2023
  4243 000023C5 0D0A00                  		db 0Dh, 0Ah, 0
  4244 000023C8 56524120737570706F-     msgVRAheader:	db "VRA support: "
  4244 000023D1 72743A20           
  4245 000023D5 00                      		db 0	
  4246 000023D6 5945530D0A00            msgVRAyes:	db "YES", 0Dh, 0Ah, 0
  4247 000023DC 4E4F200D0A              msgVRAno:	db "NO ", 0Dh, 0Ah
  4248 000023E1 28496E746572706F6C-     		db "(Interpolated sample rate playing method)"
  4248 000023EA 617465642073616D70-
  4248 000023F3 6C6520726174652070-
  4248 000023FC 6C6179696E67206D65-
  4248 00002405 74686F6429         
  4249 0000240A 0D0A00                  		db 0Dh, 0Ah, 0	
  4250                                  EOF: 
  4251                                  
  4252                                  ; BSS
  4253                                  
  4254                                  bss_start:
  4255                                  
  4256                                  ABSOLUTE bss_start
  4257                                  
  4258 0000240D ??????                  alignb 4
  4259                                  
  4260 00002410 ??                      stmo:		resb 1 ; stereo or mono (1=stereo) 
  4261 00002411 ??                      bps:		resb 1 ; bits per sample (8,16)
  4262 00002412 ????                    sample_rate:	resw 1 ; Sample Frequency (Hz)
  4263                                  
  4264                                  ; 25/11/2023
  4265 00002414 ????????                bufferSize:	resd 1
  4266                                  
  4267 00002418 ??                      flags:		resb 1
  4268                                  ;cbs_busy:	resb 1 
  4269 00002419 ??                      half_buff:	resb 1
  4270 0000241A ??                      srb:		resb 1
  4271                                  ; 18/08/2020
  4272 0000241B ??                      volume_level:	resb 1
  4273                                  ; 25/11/2023
  4274 0000241C ??                      VRA:		resb 1	; Variable Rate Audio Support Status
  4275                                  
  4276 0000241D <res 1Ch>               smpRBuff:	resw 14 
  4277                                  
  4278                                  wav_file_name:
  4279 00002439 <res 50h>               		resb 80 ; wave file, path name (<= 80 bytes)
  4280                                  
  4281 00002489 ????                    		resw 1
  4282 0000248B ??                      ac97_int_ln_reg: resb 1
  4283 0000248C ??                      fbs_shift:	resb 1 ; 26/11/2023
  4284 0000248D ????????                dev_vendor:	resd 1
  4285 00002491 ????????                bus_dev_fn:	resd 1
  4286 00002495 ????                    ac97_NamBar:	resw 1
  4287 00002497 ????                    ac97_NabmBar:	resw 1
  4288                                  
  4289                                  bss_end:
  4290 00002499 <res B67h>              alignb 4096
  4291                                  ;audio_buffer:	resb BUFFERSIZE ; DMA Buffer Size / 2 (32768)
  4292                                  ; 26/11/2023
  4293 00003000 <res 10000h>            audio_buffer:	resb 65536
  4294                                  ; 13/06/2017
  4295                                  ;temp_buffer:	resb BUFFERSIZE
  4296                                  ; 26/11/2023
  4297 00013000 <res 10000h>            temp_buffer:	resb 65536
