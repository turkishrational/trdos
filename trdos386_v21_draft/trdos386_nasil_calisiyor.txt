31/01/2025 - TRDOS 386 çalýþma prensibi - Youtube açýklamasý
mp3play5.prg programýna göre açýklama 

@erdogantan

Boot sektör 96KB olan kernel dosyasý TRDOS386.SYS'yi belleðe 1000h:0000h segment ve ofsetinde yüklüyor. Kernel Rombiostan temel verileri aldýktan sonra, interruptlarý durdurup kendini 0:0 a geri taþýyor.. Ve önce 32 bit protected moda geçiyor sonra sistemin page directory ve page table ayarlarýný yapýp, paging modunu devreye sokuyor... Bellek Atama Tablosunu düzenliyor.. Diskleri reset yapýp kontrol ediyor. Interruptlarý kuruyor. FAT12-16-32 partition'larý logical hesaplarý yapýp logical drive tablosuna ekliyor. VESA VBE3 protected mod arabirimini kontrol edip varsa kuruyor, video bios'u ona göre ayarlýyor. Linear Frame Buffer'ýn var ve eriþilebilir olduðunu görmüþ (yani VESA VBE3 PMI hazýr) ise belleði orada kesiyor. Artýk VESA video modu kullanýma hazýr oluyor. Fakat kernel text modunda kalmaya devam ediyor. Asla grafik moda geçmiyor ve program sona erince daima text moduna geri dönecek þekilde ayarlýyor, text modu ekranýný silmiyor. Her þey uygun ise kernel mainprog (iç komut yorumlayýcýsý) prosedürünü (ki biraz COMMAND.COM'a benziyor ama dahili ve çok basit) çalýþtýrýyor. 

Programý çalýþtýran komut yorumlayýcýsý yani shell ayrý bir dosya deðil. O da TRDOS386.SYS içinde, yaklaþýk 8-10 kilobyte'lýk bir kod. Kernel boyutunu o kadar artýrmýþ oluyor. Mainprog ilk kez çalýþýrken MAINPROG.CFG  dosyasý var mý diye bakýyor. Varsa onun içindeki komutlarý veya adý yazýlý programý çalýþtýrýyor. (Çok basit bir AUTOEXEC.BAT yöntemi. Ýleride geliþtirmem gerekiyor.) 

Tüm bunlar 96 KB ama belleðin ilk 4 megabyte'ý kernel'e ait.

Program 5. Megabyte'ýn baþýný kendisinin sýfýrý olarak görüyor.. Ve düz yani segmentsiz ama page table esaslý çalýþýyor. Virtual Flat Memory yöntemi yani. 
Program video memory'yi (LFB) ve sistemin Audio Buffer'ýný gerekirse kernelin memory map fonksiyonunu çaðýrarak kullanýyor. Program doðrudan Input/Output yapamýyor. O da gerekirse input/output port ve datasý vererek kernel fonksiyonunu (IOCTL System call) çaðýrýyor. 

Tüm bu iþlevler için sadece 96 kilobyte kernel çalýþýyor. 4MB RAM yeterli. Ama programýn mp3 çalabilmesi için 8-32 MB RAM gerekiyor. 

Demolarda kullandýðým MP3PLAY5.PRG sadece 47 kilobyte.

Demolardaki diskler (C, D, E) Windows 7 çalýþan bilgisayarýn NTFS mantýksal diski olan C deðil ama onunla birlikte ayný fiziksel diskte olan FAT16 ve FAT32 mantýksal diski yani dosya sistemi (Demodaki diskleri Windows D, E, F diskleri olarak görüyor). TRDOS 386 2 terabyte'a kadar Masterboot partition table tipi Windows kurulu bilgisayar disklerine eriþebiliyor. Ama NTFS dosya slstemini tanýmýyor. Dolayýsýyla Extended yada Primary partition içinde FAT32 dosya sistemi kurulu ise Windowsta çalýþýp sonra ayný diski TRDOS 386yý baþlatarak (gerçek veya QEMU üzerinden) kullanabiliyorum. Kopyeleme vs dahil..

Bu þekilde olunca teorik olarak bir TRDOS 386 programý Windows programýna göre çok fazla kompakt ve en az %20 daha hýzlý çalýþýyor olmasý lazým. Linux programlarýndan da hýzlý. Çünkü hem direkt hardware eriþimi var hem de Assembly programlama dili ile yapýlmýþ olduðundan ayný iþlevi %20 kadar daha az CPU zamaný kullanarak yapmýþ oluyor. C dili olsaydý araya çok push/pop ve pointer to pointer girecekti.

Bu tarz programlamanýn bir örneði var. BareMetal OS diye kavram ve uygulanan bir proje var (bu proje 64 bit'e geçmiþ, eski bilgisayarlara göre deðil). TRDOS 386 bir BareMetal OS deðil ama 32bit BareMetal'a yakýn. (BareMetal: Ýþletim sistemi yok gibi, program herþeye tam hakim.) TRDOS 386 device driver yerine 32bit bios yöntemini kullanýyor. 

TRDOS 386yý kendi özgü programlarla çalýþýrken ayný programýn tam veya tama yakýn muadili Windows'ta çalýþtýrmaktan kötü ve güvensiz yapan özelliði diske yazma. (Dosyayý okuma dezavantajý yok. Windows'tan çok az yavaþ. Ama kompakt olduðundan ve DLL vs kullanmadýðý için kullanýcý iþlemine Windows programýndan daha hýzlý tepki veriyor.) 

Ýleride bunu halletmeye çalýþacaðým.

Retro DOS v5 (modifiye edilmiþ IBM PCDOS 7.1 kerneli ve command.com) iþletim sistemini (Retro DOS v5 tam tamýna PCDOS 7.1 orijinalin update'i ve bugfixed hali gibi, klon deðil) bunun için yazdým. Web sitemde ve github sayfamda var.

TRDOS 386nýn FAT ve FAT32 dosya sistemlerinden dosya okuyup yazmasýný oradaki prosedürleri örnek alarak düzelteceðim. 

TRDOS 386.. 80386 (FPU içeren veya içermeyen) sistemleri ile günümüzün x86, x64 iþlemcili tüm IBM PC/AT klonu ev bilgisayarlarýnda ve embedded sistemlerde (freeware olarak) çalýþabilmeli þekilde hedefim var. Ama aslýnda bu kapsamda hayal ettiðim þey, asýl hedef TRDOS386 deðil. O benim için bir ara durak.

Not: TRDOS386nýn bir türevini veya varyantýný diyelim, PCDOS386 adýyla yazmayý düþünüyorum. Bunu yaparsam, amacým daha çok eski DOS'a benzetmek, harici komut yorumlayýcýsý (32 bit command.com veya unix shell muadili) yöntemini kullanmak.  Daha ziyade yabancýlara hitap edecek özellikleri öne çýkarmak olur. Yaparsam, o da freeware olacak. Aslýnda ismi gizlenmiþ TRDOS olacak ama yabancý kiþiler onu PCDOS386   diye tanýrsa daha çok ilgi gösterirler. Türkiyenin bu konuda ileri ülke olarak bilinmemesi ve Türklerin kötü imajý dolayýsýyla TRDOS (Turkish Rational DOS) ismi çalýþmama çok azda olsa fren koymuþ oluyor. Desteklemek için iletiþim kuranlar azalýyor. Bu konulara meraklý olsalar bile, TRDOS 386nýn Lokal ve Türk iþi bir hobi iþletim slstemi yazms çabasý olduðunu düþünüp, ilgilenmekte (ve kaynak kodunu desteklemekte) faydalarý yok sanýyorlardýr. Bu þekilde endüstriyel ve embedded sistemlere ve ucuz donanýmlara uyarlamaya ve PC'de Freedos'un yerine kullanmaya çok uygun bir iletim sistemi (veya 32 bit Rombios, video bios alt yapýsý) örneðinin geliþmekte olduðunu da görmemiþ oluyorlar.

(Çok zeki ve bilgili bir kiþi kaynak kodlarýný ve yazdýðým açýklamalarý detaylý incelese aslýnda TRDOS 386nýn 80386 yazýlýmý olsun diye veya PC yazýlýmý olsun diye yazýlmýþ olmadýðýný baþka bir þeye evrileceðini, bir ara durak olduðunu tahmin eder. Oradan henüz niyetimi tam anlayan bir mesaj gelmedi. Birkaç ipucu vereyim ama telefon yazýlýmý yazacaðým olarak anlamayýn mantýðý tahmin edin: Baz istasyonlarý olmadan haberleþen telefon yazýlýmý fikrim vardý. Hatta Aselsana email gönderip önermiþtim. Depremde lazým vs. Basit telsiz deðil ama Ýnternet gibi telsiz aðý. Her telefon grubundaki diðerleri için baz istasyonu. Bilgisayar iþinde ilk hayalim merkezi otomatik alarm slstemi, 'central cats' idi. Askeri maksatlý, çoklu helikopter ve robot silah kullanýmýný kontrol eden iletiþimi kesilemez, her durumda, ýþýk, ses, titreþim, elektrik, ýsý dalgasýyla bile talimat ve kod iletebilen alarm verme kabiliyeti olan bilgisayar aðý. Sonraki hayalim Çok basit bir þekilde makine kumandasý. Çok hýzlý çalýþma. Mevcut donanýmda dünyanýn en hýzlý çalýþan yazýlýmý olmalý. Ýndirekt vs hýz kesen tüm bileþenlerden kurtulunmalý vs Sonraki hayalim öyle bir iþletim sistemi yazayým ki.. CPUya göre iþletim sistemi deðil iþletim sisteminin yazýlým mimarisine uyan CPU ve bilgisayar mimarisi geliþtirme fikrini desteklesin. 1 milyar transistörlü cpu ile deðil mesela 1 milyon transistörlü cpu ile 1 milyarlýk olandan daha hýzlý program çalýþtýrsýn. x86, x64 ve ARM iþlemcileri çöp olsun yani. PDP-11'in býraktýðý yerden devam edilsin örneðin.. Hatta ilk açýlýþta ROMdan çalýþýp, sonra source device register, destination device register ve base address register ile multi memory çalýþan, mesela ayný disk kullanýr gibi memory kullanan cpu düþündüm. Bilgisayarýnýz ayný.. Siz sadece bellek ünitesini deðiþtiyorsunuz. Ne dosya açýyorsunuz, ne dosya siliyorsunuz. Mesela seyretmek istediðiniz film dosya deðil. Usb bellek gibi ayrý bellek modülünde bir veri bloku. CPUya bellek ünite numarasý verildiðinde dosya aç, kapa yok. Direkt film oynatan sök/tak rombiosa veya rambiosa dallanmýþ olacak. Günümüz teknolojisinde medyaya özel rombios yazmak çok kolay ve çok ucuz olur. Mesela mp4 film oynatan rombios, filmin yüklü olduðu aygýtta, aygýt bilgisayara takýlýnca veya bir tuþa basýp cpu device register switch yapýlýnca, cpu ip buraya dallanacaðý için belkide bugün Windowsta týkladýktan sonra 5 saniyede baþlayan bir film mesela 1 mili saniyede baþlatýlmýþ olacak. Fikir olarak bunun yakýnýný BareMetalOS projesinde vs biraz düþünmüþler. Ama x64 iþlemcili pc için. Benim hayal ettiðim cpu için diske kurulu iþletim sistemi bile yok. Aslýnda multimedia aygýtý cpu'su gibi bir þey. Sadece rombios veya rambios var. Sadece video bios var, veya iletim sisteminden baðýmsýz video driver baþka bellek ünitesinde/modülünde yani. O da kendi bellek ünitesinde yani ana bellekte deðil. Diskten iþletim sistemi yüklenen ana bellek diye bir þey de yok, o bile rambios. TRDOS 386'yý yazarken bunlarý da düþünüyordum. Onun için ara durak diyorum.) 