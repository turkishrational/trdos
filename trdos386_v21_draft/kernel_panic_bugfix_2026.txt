10/01/2026 - Kernel Panic BugFix
TRDOS 386 Kernel v2.0.10 ve v2.1.0 (draft) da
trdosk6.s içinde 'kernel panic !' sebebi olan
kusuru 10/01/2026'da düzelttim...


****
Zombie durumuna ayarlanan child process, parent process
tarafýndan serbest býrakýlýyordu. -Retro UNIX 386 v1-
Fakat TRDOS 386'nýn MainProg adýný verdiðim iç/dahili
komut yorumlayýcýsý, proses 1 olarak çalýþýrken...
"Wait for child return" durumuna gelecek þekilde, sysfork
veya sysexec ile child prosesi çalýþtýrmadýðý için... 
-Retro Unix 386'daki /etc/init gibi çalýþmadýðý için-
ilgili ayar child process'in p.stat deðerini sýfýrlamýyordu.
Proses 1 olan MainProg Sadece dos_prompt'tan program sonlanýnca
döngü yapýyor, tekrar aktifleþiyordu.
"load_and_run_file:" prosedürü ile tekrar programý çalýþtýrýyordu.
Her seferinde boþ yani p.stat deðeri 0 olan proses numarasý arandýðý için,
zombie durumu olan proses geçiliyor, bir sonraki boþ proses sýra numarasý
atanýyordu. 16. prosesden sonra boþ yer olmadýðý için "kernel panic !" hatasý
alýnýyordu.

'load_and_run_file:' içinde aþaðýdaki gibi deðiþiklik yaparak
kusuru düzelttim:

trdosk6.s (load_and_run_file:)
; ----------------------------------------------------

	;;; 02/05/2016
	;;; Create a new process (parent: MainProg)
	xor 	esi, esi
cnpm_1: ; search p.stat table for unused process number
	inc	esi
	; 10/01/2026
	mov	al, [esi+p.stat-1]
	cmp	al, 0
	;cmp	byte [esi+p.stat-1], 0 ; SFREE
				; is process active, unused, dead
	jna	short cnpm_2	; it's unused so branch
	;;;;
	; 10/01/2026 - TRDOS 386 v2.0.10 (BugFix)
	; (if the parent proc's number = 1, the child's status = 3)
	cmp	al, 3 ; zombie ?
	jne	short cnpm_3 ; al = 1
	shl 	esi, 1
	mov	ax, [esi+p.ppid-2] ; parent process's id
	shr	esi, 1
	cmp	ax, [p.pid] ; compare with process 1's process id
	jne	short cnpm_3 ; not MainProg (!?)
	mov	byte [esi+p.stat-1], 0
	jmp	short cnpm_2
cnpm_3:
	;;;;
	cmp	si, nproc 	; all processes checked
	jb	short cnpm_1    ; no, branch back
cnpm_panic:
	jmp	panic 
cnpm_2:
	mov	eax, [u.pgdir] ; page directory of MainProg
	mov	[u.ppgdir], eax ; parent's page directory
	call	allocate_page
	;jc	panic
	; 23/07/2022
	jc	short cnpm_panic

; ----------------------------------------------------

trdosk6.s (sysexit:)
; ----------------------------------------------------
sysexit_7:
	mov	al, [esi] ; process number (of timer event)
	cmp	al, bl ; process number comparison
	je	short sysexit_10
	and	al, al
	jz	short sysexit_9
sysexit_8:
	dec	cl
	jz	short sysexit_11
	; 08/01/2026 (BugFix) 
	mov	al, 0
sysexit_9:
	dec	ah
	jz	short sysexit_12
	add	esi, 16
	jmp	short sysexit_7

	.......

sysexit_5:
	.......

	mov	al, [esi+p.stat-1]
		; movb p.stat-1(r1),r2 / move status of parent to r2
	and	al, al
	jz	short sysexit_6
		; beq 2f / if its been freed, 2f
	cmp	al, 3
		; cmp r2,$3 / is parent a zombie?
	je	short sysexit_6
		; beq 2f / yes, 2f
	; BH = 0
	mov	bl, [u.uno]
		; movb u.uno,r3 / move dying process's number to r3
	mov	byte [ebx+p.stat-1], 3 ; SZOMB
		; movb $3,p.stat-1(r3) / make the process a zombie
	
; ----------------------------------------------------


 